# 项目介绍（YunBQ）

本文按“功能模块”梳理项目的目标、前后端结构、核心接口与交互流程，并补充部署与运维要点，便于团队成员快速上手与协作。

## 一、项目概览
- 品牌与核心定位：拾·言（便签/短内容）与导航广场的组合站点，提供个人便签管理、公开广场浏览、消息互动与网站导航。
- 技术栈：
  - 后端：Spring Boot + MyBatis-Plus（分页/查询），JWT 安全，部分场景使用 Redis（可禁用）。
  - 前端：Vue 3 + Element Plus，组合式 API，多页面统一 TwoPaneLayout 布局。
  - 数据库：MySQL（含审计/请求/认证/错误日志表）。
  - 部署：Docker Compose（可选 Nginx 反向代理），静态头像 `uploads/avatars` 映射。

## 二、功能模块

### 2.1 拾言（便签）
前端主要页面：
- `ShiyanTown.vue`（拾言小镇/公开页，已根据实际精简展示逻辑）
- `Notes.vue`、`notes/NotesBody.vue`（添加/管理我的便签）
- `UserNotes.vue`（他人公开拾言列表）

后端主要接口控制器与服务：
- `NoteController`（路径别名：`/api/notes` 与 `/api/shiyan`）
  - 分页列表：`GET /api/notes`（支持 `q/archived/isPublic/mineOnly/page/size` 过滤与分页）
  - 创建：`POST /api/notes`（需登录）
  - 更新：`PUT /api/notes/{id}`（仅作者）
  - 删除：`DELETE /api/notes/{id}`（仅作者）
  - 点赞：`POST /api/notes/{id}/like` / 取消点赞：`DELETE /api/notes/{id}/like`
  - 收藏：`POST /api/notes/{id}/favorite` / 取消收藏：`DELETE /api/notes/{id}/favorite`
  - 收藏信息：`GET /api/notes/{id}/favorites`（返回收藏总数与我是否已收藏）

后端服务逻辑（`NoteService`）：
- 列表与视图：
  - 未登录：仅返回公开未归档拾言；
  - 登录：默认返回“我的全部 + 他人公开”的合并视图；支持 `isPublic/mineOnly/archived` 精确过滤。
- 写操作与交互：
  - 创建/更新/删除遵循作者校验；
  - 点赞/收藏对公开拾言开放；私有仅作者可操作；
  - 交互成功后生成行为消息（`MessageService`）通知作者。
- 标签解析与规范化：
  - 从内容中提取 `#tag` 并清理到 `tags` 字段；去重、去空、统一分隔。

缓存说明（按当前实际使用情况）：
- 系统原先支持“最近/热门公开拾言”缓存（`NoteCacheService`，键：`notes:recent:size:{size}`、`notes:hot:size:{size}`）。
- 如果前端已取消最近/热门展示且后端也不再调用相关接口/失效方法，则可视为不再使用 Redis（详见“运维与可选开关”）。

### 2.2 导航广场
前端主要页面：
- `Square.vue`（广场页，侧栏分类 + 右侧站点卡片列表）
- 子组件：`square/SquareBody.vue`、`components/SideNav.vue`、`components/NavigationSiteList.vue`

后端主要接口控制器与服务：
- `NavigationController`（`/api/navigation`）
  - 分类：
    - 获取根分类：`GET /api/navigation/categories`
    - 获取全部启用分类（含子级）：`GET /api/navigation/categories/all`
  - 站点：
    - 按分类查询站点：`GET /api/navigation/sites/category/{categoryId}`
    - 精选/热门站点：服务层与 Mapper 通过排序/点击量实现（`NavigationSiteMapper`）
    - 标签搜索：`GET /api/navigation/sites/tags/{tags}`（逗号分隔标签，`LIKE` 模糊匹配）

站点列表前端交互：
- 客户端分页与“加载更多”；移动端进入视口自动加载下一页；
- 严格标签过滤工具：`utils/siteNoteUtils.js`（`hasTag/openSite/snippet` 等）。

### 2.3 消息中心
前端主要页面：
- `Messages.vue`（系统消息、收到的赞、收藏消息等，分页展示，支持已读与删除）

后端主要接口控制器与服务：
- `MessageController`（`/api/messages`）
  - 列表：`GET /api/messages`（分页，支持 `type` 过滤）
  - 标记已读：`POST /api/messages/{id}/read`
  - 删除消息：`DELETE /api/messages/{id}`
  - 未读计数：`GET /api/messages/counts`

### 2.4 账户与个人中心
前端主要页面：
- `Login.vue`（登录页，图形验证码；顶栏保持一致导航）
- 个人资料/头像上传入口（顶栏或独立视图；头像静态资源位于 `uploads/avatars`）

后端主要接口控制器与服务：
- `AccountController`（`/api/account`）
  - 公开资料：`GET /api/account/profile/{username}`（仅公开字段）
  - 当前用户信息：`GET /api/account/me`（需登录）
  - 更新资料/头像上传/绑定邮箱：POST/PUT 系列接口（需登录）
- `PasswordResetController`（`/api/auth`）
  - 找回密码：`POST /api/auth/forgot`（校验验证码，发送一次性重置码至邮箱）
  - 重置密码：`POST /api/auth/reset`（校验邮箱与重置码，更新新密码）
- `CaptchaController`（`/api/captcha`）
  - 获取验证码：`GET /api/captcha`
  - 校验验证码：`POST /api/captcha/verify`

验证码与找回密码实现说明：
- 当前使用进程内 `ConcurrentHashMap` 存储短期验证码与发送频率（简易实现，单实例适用）。
- 多实例部署建议迁移到 Redis 并设置 TTL；前端表单集成 `captchaId/captchaCode` 字段。

### 2.5 管理后台（仅管理员）
前端主要页面：
- `Admin.vue`（左侧菜单 + 右侧主区，动态加载子页面：用户管理、导航管理、站点管理、审计/请求/认证/错误日志）

后端主要接口控制器与服务：
- `AdminController`（`/api/admin`）
  - 用户管理、导航/站点批量导入导出、日志分页与导出等（方法级 `@PreAuthorize('hasRole('ADMIN')')`）
- 安全配置：路径级限制 `/api/admin/**` + 方法级角色授权，双重保护。

### 2.6 背景与其它辅助
- `BackgroundController`：`GET /api/background` 返回随机背景图 URL（支持宽高与关键字），用于前端沉浸式背景。
- `DebugController`（仅开发用途）：探针接口查看安全上下文、请求头等，生产环境建议关闭。

## 三、前端架构与路由
- 根组件：`App.vue` 渲染 `router-view`，统一页脚 `TransparentFooter`。
- 入口：`main.js` 注册 Element Plus 与路由，统一样式 `style.css`。
- 布局：`components/TwoPaneLayout.vue` 提供“顶栏吸顶 + 左右两列 + 右侧滚动容器”的一致布局。
- 顶栏：`components/AppTopBar.vue`（搜索、入口按钮、头像/消息入口等）。
- 统一交互与可用性：
  - 列表页普遍采用“骨架/空态/错误提示”三态渲染；
  - 移动端优化：滚动哨兵自动加载、BackTop 回到顶部；
  - 头像兜底：`assets/default-avatar.svg` + `avatarFullUrl` 拼接。

## 四、后端架构与数据层
- 分层：Controller（路由）→ Service（业务）→ Mapper（MyBatis-Plus）→ DB。
- 安全：JWT 将用户信息注入 SecurityContext；`AuthUtil.currentUserId()` 获取当前用户ID；角色控制保护管理端点。
- 日志与审计：
  - 表：请求日志、认证日志、错误日志、审计日志（SQL 脚本位于 `backend/sql/*`）；
  - 清理任务：`LogRetentionScheduler` 定时清理超期数据（`logdb.retention-sweep-interval-ms` 配置）。
- 静态资源：头像目录 `uploads/avatars` 对外映射 `/uploads/**`。

## 五、缓存与 Redis（可选）
- 组件：`NoteCacheService` 使用 `StringRedisTemplate` 缓存“热门/最近公开拾言”，键空间：`notes:hot:size:{size}`、`notes:recent:size:{size}`。
- 失效策略：写操作（新增/更新/删除/点赞/收藏）后失效相关键空间。
- 当前实际：若前端取消“最近/热门”，且后端也不再调用相关接口与失效方法，则可停用 Redis（参考第六节建议）。

## 六、部署与运维建议
- 本地运行：参考 `本地运行-不启用开发工具.md`（免开发工具快速启动）。
- Docker Compose：
  - 后端/前端容器 + 可选 Redis；Nginx 用于静态资源与反向代理。
  - 环境变量：`SPRING_DATA_REDIS_HOST/PORT`（如禁用缓存可不配置或关闭服务）。
- Redis 关闭的安全做法：
  - 移除/关闭 `NoteCacheService` 的读取与失效调用（例如 `NoteService` 中 `noteCache.evictHotAll()` 等）；
  - 或增加配置开关：`cache.notes.enabled=false`，并将缓存注入改为可选（`@Autowired(required=false)` 或 `ObjectProvider`）。
- 数据保留与清理：根据业务量调整日志保留天数与清理间隔，避免表膨胀。

## 七、开发与测试建议
- 前后端联调：控制器记录关键参数与用户ID，便于定位“未到达控制器” vs “业务错误”。
- 页面回归场景：
  - 便签：公开/私有切换后公开页不应显示私有内容（前端本地列表需及时移除）。
  - 导航：分类树加载、标签搜索、热门/精选稳定性；移动端分页与加载更多。
  - 消息：未读计数准确、标记已读与删除行为一致。
  - 账户：验证码/找回密码流程、头像上传与静态资源访问。

## 八、目录结构（摘要）
```
YunBQ/
├── backend/              # 后端工程（Spring Boot）
│   ├── src/main/java/com/yunbq/backend/
│   │   ├── controller/   # Note/Navigation/Account/Admin 等控制器
│   │   ├── service/      # NoteService/MessageService/... 业务逻辑
│   │   ├── mapper/       # MyBatis-Plus Mapper
│   │   ├── job/          # LogRetentionScheduler 定时清理任务
│   │   ├── config/       # 迁移/配置辅助
│   ├── sql/              # 表结构与增量 SQL 脚本
│   └── uploads/avatars/  # 头像静态文件目录
├── frontend/             # 前端工程（Vue 3 + Element Plus）
│   ├── src/views/        # Admin/Square/Notes/Messages/Login 等视图
│   ├── src/components/   # TwoPaneLayout/AppTopBar/列表组件等
│   └── src/utils/        # 站点便签工具、认证辅助
└── scripts/              # 部署模板（Docker/Nginx）、本地运行脚本
```

---

如需“彻底停用 Redis 并保留未来开关能力”，我可以在后端增加 `cache.notes.enabled` 配置与可选注入，提交改动并附带详细注释，确保生产/开发环境切换便捷与安全。