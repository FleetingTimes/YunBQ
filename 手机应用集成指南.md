# 拾言（YunBQ）网页应用转手机应用指南

本指南提供三种把现有网页应用放到手机上的方案，并给出基于 Capacitor 的推荐实现步骤（可发布到 Android/iOS）。

## 方案对比
- PWA（渐进式网页应用）
  - 优点：无需上架，用户“添加到主屏幕”，支持基础离线缓存
  - 局限：原生能力有限，推送/后台受平台限制
- Android TWA（Trusted Web Activity）
  - 要求：站点满足 PWA（HTTPS、manifest、Service Worker），用 Bubblewrap 生成可上架的 Android 应用
- Capacitor（推荐）
  - 用原生壳（WebView）封装现有 Vue + Vite 前端，可调用原生能力，打包为 APK/AAB（Android）或 IPA（iOS）

## 推荐路线：Capacitor 原生封装

### 前置条件
- Node.js 18+、npm、Android Studio（Android）/ Xcode（iOS）
- 线上站点与后端：`https://app.shiyan.online` 与 `https://api.shiyan.online`（建议）

### CORS 与 API 地址
- 生产前端：`frontend/.env.production` 设置 `VITE_API_BASE=https://api.shiyan.online/api`
- 后端生产 CORS 放行来源（示例片段）：
  ```yaml
  cors:
    allowed-origins:
      - "https://app.shiyan.online"
    allowed-origin-patterns:
      - "https://*.shiyan.online"
    allowed-methods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS
      - PATCH
    allowed-headers:
      - Authorization
      - Content-Type
    allow-credentials: true
  ```
- 如使用“离线包”模式（App 内嵌 `dist`），额外放行 `capacitor://localhost`：
  ```yaml
  cors:
    allowed-origins:
      - "https://app.shiyan.online"
      - "capacitor://localhost"
  ```

### 步骤一：安装与初始化
1) 安装依赖
   ```bash
   npm i @capacitor/core @capacitor/cli
   ```
2) 初始化项目
   ```bash
   npx cap init Shiyan com.yunbq.shiyan
   ```
3) 选择平台（可任意）
   ```bash
   npx cap add android
   npx cap add ios
   ```

### 步骤二：选择加载模式
- 远程加载（推荐维护成本最低）
  - 在 `capacitor.config.ts` 或 `capacitor.config.json` 设置：
    ```json
    {
      "appId": "com.yunbq.shiyan",
      "appName": "Shiyan",
      "server": { "url": "https://app.shiyan.online" }
    }
    ```
  - 原生壳直接加载线上站点，接口走 `https://api.shiyan.online/api`
- 离线包（内嵌 `dist`）
  - 生产构建：`npm run build`
  - 同步前端产物到原生工程：`npx cap copy`
  - 不配置 `server.url`，App 加载内置 `dist/index.html`
  - 后端需放行 `capacitor://localhost` CORS；API 指向线上地址

### 步骤三：运行与打包
- 打开原生工程
  ```bash
  npx cap open android   # Android Studio
  npx cap open ios       # Xcode
  ```
- 调试运行：选择设备或模拟器，启动应用
- 生成制品：
  - Android：签名后生成 `APK/AAB`，提交 Play Console 或直接分发
  - iOS：配置证书与描述文件，生成 `IPA`，通过 TestFlight/App Store 分发

### 常用配置与说明
- Android 明文网络（仅开发时后端为 http）
  - 在 `AndroidManifest.xml` 添加：`android:usesCleartextTraffic="true"`
  - 建议生产全部使用 HTTPS
- 设备访问本机后端（联调）
  - 模拟器：`http://10.0.2.2:<port>`；真机：`http://<你的局域网IP>:<port>`
- 静态资源 `/uploads/**`
  - 头像等资源走完整 URL；前端已有 `avatarFullUrl` 将 `API_BASE` 去除 `/api` 再拼接静态路径

## 备选路线：PWA 与 TWA

### PWA 最小实现
1) 安装：`vite-plugin-pwa`
2) 添加 `manifest.webmanifest`（名称、图标、启动 URL、display: standalone）
3) 注册 Service Worker 缓存基础静态资源
4) 部署到 `https://app.shiyan.online`，用户可“添加到主屏幕”

### Android TWA（将 PWA 上架）
1) 安装 Bubblewrap：`npm i -g @bubblewrap/cli`
2) 初始化 TWA 项目：`bubblewrap init`，填写站点 `https://app.shiyan.online`
3) 构建与签名：`bubblewrap build`，得到可上架的应用包

## 测试与验收清单
- 登录与受保护接口（`Authorization: Bearer <JWT>`）请求返回正常
- 导航与列表数据加载正常，弱网状态下无白屏（可增加重试与提示）
- 头像上传与 `/uploads/**` 访问正常
- CORS：验证来源 `https://app.shiyan.online` 与（如使用离线包）`capacitor://localhost` 均已放行
- 推广与发布：Android 签名、iOS 证书、商店元数据与图标均完整

---
如需我把示例 `capacitor.config.ts` 与后端 CORS 配置片段直接加入仓库并完善打包脚本，请告知，我可以补充完整的代码与命令清单。
