# 本地隧道工具对比与使用指南（ngrok / localtunnel / frp / Cloudflare Tunnel）

> 目标：在本地开发阶段，将你的后端服务（如 `http://localhost:8080`）安全地映射到公网地址，以便对接 QQ 互联等第三方授权平台需要的 `redirect_uri`。本文从四种常用工具的简介、优缺点、适用场景到详细安装与联调步骤做全覆盖说明，并包含与 QQ 登录的联调注意事项。

---

## 快速选择建议

- 如果你“马上需要一个可用的公网地址”，并且不介意临时域名：选 `ngrok`（简单稳定、文档完善）。
- 如果你“只做一次临时演示”且希望零账号、零配置：选 `localtunnel`（上手最快，但稳定性一般）。
- 如果你“拥有公网服务器/云主机”并想要“可控的自建隧道”：选 `frp`（性能强、成本可控、在国内网络环境下更稳）。
- 如果你“已有自己的域名”且希望在不开放入站端口的情况下“稳定地暴露服务”：选 `Cloudflare Tunnel`（免费、稳定、需域名托管在 Cloudflare）。

---

## ngrok

### 简介
- 官方 SaaS 隧道服务；将本地端口映射到一个 `https://<随机子域>.ngrok.io` 的公网地址。
- 提供请求检查、区域选择、保留域名（付费）等功能。

### 优点
- 快速、简单，跨平台支持好（Windows/macOS/Linux）。
- 免费层即可使用 `https`，减少被第三方平台拒绝的问题。
- 有 Web 检查界面，便于调试回调与请求内容。

### 缺点
- 免费层域名通常是临时随机的，重启后更换，需同步更新 QQ 平台配置与 `application.yml`。
- 部分地区网络可能偶发不稳定。

### 适用场景
- 本地开发、第三方授权联调、一次性演示；无自建服务器时的首选。

### 使用步骤（Windows，PowerShell）
1) 下载安装：到 `https://ngrok.com/` 注册并下载 Windows 版本；解压得到 `ngrok.exe`。
2) 登录并绑定令牌：在 ngrok 账户页复制 `authtoken`，执行：
   ```powershell
   .\ngrok.exe config add-authtoken <你的_authtoken>
   ```
3) 暴露后端端口：
   ```powershell
   .\ngrok.exe http 8080
   ```
   - 控制台将显示 `https://xxxx.ngrok.io` 等公网地址。
4) 配置 QQ 互联：
   - “网站地址”可填写 `https://xxxx.ngrok.io`（或与之同域名的展示地址）。
   - “回调地址”填写 `https://xxxx.ngrok.io/api/auth/qq/callback`。
5) 更新项目 `application.yml`：
   - `oauth.qq.redirect-uri` 设置为上述回调地址。
   - `frontend.base-url` 可继续为本地前端地址（例：`http://localhost:5173`）。
   - 如果后端校验 CORS，`cors.allowed-origins` 中加入你的 ngrok 域名。

### 注意事项
- 确保使用 `https` 回调地址；很多平台要求 HTTPS。
- 每次重启 ngrok 可能获得不同域名；需同步更新 QQ 平台与项目配置。
- 与防 CSRF 的 `state` 校验搭配使用：发起授权时保存 `state`，回调时校验一致性。

---

## localtunnel

### 简介
- 社区维护的开源隧道服务；通过 Node.js 将本地端口映射到 `https://<随机子域>.loca.lt`（或公开 `localtunnel.me` 服务器）。
- 可使用 `npx` 无需安装全局模块。

### 优点
- 无需注册账号，零配置即可使用。
- 上手最快，特别适合一次性的演示与开发联调。

### 缺点
- 稳定性与可用性一般，可能出现连接被重置或服务不可用的情况。
- 自定义子域不一定能长期保留；官方服务带宽与限流不可控。

### 适用场景
- 临时联调、快速验证授权回调链路；对稳定性要求不高。

### 使用步骤（Windows，PowerShell）
1) 确保本机有 Node.js 与 npm。
2) 运行：
   ```powershell
   npx localtunnel --port 8080
   ```
   - 控制台输出一个 `https://<随机>.loca.lt` 或 `https://<随机>.localtunnel.me` 的公网地址。
3) （可选）指定子域名：
   ```powershell
   npx localtunnel --port 8080 --subdomain mydev
   ```
4) 配置 QQ 互联与项目 `application.yml`，方式与 ngrok 一样：将 `redirect-uri` 指向该地址并加入 CORS。

### 注意事项
- 有时候会出现 502/连接中断，重试或更换子域名。
- 依赖社区公共服务，生产环境与关键演示建议选择更稳定方案（ngrok/Cloudflare/自建 frp）。

---

## frp（Fast Reverse Proxy）

### 简介
- 高性能的自建反向隧道工具；需要一台“公网服务器”部署服务端（`frps`），本地运行客户端（`frpc`）对接。
- 支持 TCP/HTTP/HTTPS/WebSocket 等多协议，配合 Nginx 可实现基于域名的反向代理。

### 优点
- 稳定可控：拥有自己的服务器与域名后，稳定性与长期可用性都更好。
- 性能强：适合需要低延迟与高并发的开发/演示环境。
- 可与企业安全策略对齐：日志、访问控制、证书自管。

### 缺点
- 需要公网服务器与一定的运维能力（开放端口、安全组、证书等）。
- 配置相对复杂；需要维护 frps 与相关反代（Nginx 等）。

### 适用场景
- 在国内网络环境下需要长期稳定的隧道；团队协作、演示环境、类生产联调。

### 使用步骤（Windows + Linux 服务器示例）
1) 在服务器部署 `frps`：
   - 下载对应平台的 `frp` 发行包，解压得到 `frps`。
   - 创建 `frps.ini`：
     ```ini
     [common]
     bind_port = 7000
     # （可选）启用 Dashboard 观察状态
     dashboard_port = 7500
     dashboard_user = admin
     dashboard_pwd = <强密码>
     # （可选）TLS 配置，生产建议开启
     # enable_tls = true
     ```
   - 启动：`./frps -c ./frps.ini`（建议用 systemd 管理为服务）。
2) 在本地 Windows 运行 `frpc`：
   - 下载 Windows 版本的 frp，解压得到 `frpc.exe`。
   - 创建 `frpc.ini`（HTTP 域名映射示例）：
     ```ini
     [common]
     server_addr = <你的服务器IP或域名>
     server_port = 7000

     [web]
     type = http
     local_port = 8080
     custom_domains = dev.example.com
     ```
   - 运行：
     ```powershell
     .\frpc.exe -c .\frpc.ini
     ```
3) 配置 DNS 与反向代理：
   - 将 `dev.example.com` 解析到你的服务器 IP。
   - 如使用 Nginx/Traefik，配置虚拟主机与证书（Let’s Encrypt）以启用 HTTPS。
4) 配置 QQ 互联与项目 `application.yml`：
   - `redirect-uri` 用 `https://dev.example.com/api/auth/qq/callback`。
   - `cors.allowed-origins` 包含你的域名与本地前端地址。

### 注意事项
- 开放服务器端口（如 `7000`）并在安全组放行。
- 强烈建议使用 HTTPS，Q Q 平台更容易接受安全回调地址。
- 证书与反代的配置需对齐你的域名与安全策略；在生产环境遵循最小暴露原则。

---

## Cloudflare Tunnel

### 简介
- 由 Cloudflare 提供的免费隧道方案；通过 `cloudflared` 将内网/本地服务暴露到互联网，且无需在服务器上开放入站端口。
- 需要将你的域名托管到 Cloudflare；隧道会给你一个稳定的子域（如 `dev.example.com`）。

### 优点
- 免费、稳定、无需维护服务器端口暴露；支持 HTTPS 与 WebSocket 等。
- 安全性好：连接从内网出站到 Cloudflare 边缘，减少被扫端口的风险。

### 缺点
- 必须使用托管在 Cloudflare 的域名；没有域名就无法使用。
- 某些企业网络对 Cloudflare 有策略限制，需要提前评估。

### 适用场景
- 已有域名的团队/个人，在开发阶段需要一个稳定的公网地址，与生产安全策略相近。

### 使用步骤（Windows，基于自有域名）
0) 官网 https://dash.cloudflare.com/　
1) 准备：将你的域名添加到 Cloudflare，并完成 DNS 托管。
      登录 Cloudflare 后点击“添加站点”  -->  输入(你的域名)    -->  选择免费套餐(free)   
          -->   Cloudflare 会提供两个NS服务器地址  -->   将这两个NS服务器地址添加到你的域名注册商的DNS设置中
          -->   等待DNS生效(可能需要几分钟)

          之后去 设置里 验证邮箱(第一次注册的新用户) (不然下面的授权无法通过)
2) 安装 `cloudflared`（Windows）：
   - 访问 `https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/` 下载 Windows 安装包或 zip。
3) 登录并创建隧道：
   ```powershell
   cloudflared tunnel login
   cloudflared tunnel create dev-tunnel
   ```
   在 执行第一行命令行时，会打开一个浏览器窗口，要求登录 Cloudflare 账号。
   登录后，授权Cloudflare Tunnel . 选择将Tunnel添加到的区域 (下面会有你的域名，选择即可)
   显示成功，会自动下载凭证文件(可以在命令行中看到 保存的路径 --》C:\Users\你的用户名\.cloudflared\cert.pem)
      可以 拷贝到 想存放的地方 (我的是放在D:\Cloudflared\下了)

   即可执行 第二条命令 创建 隧道

      创建成功后: 会生成一个UUID凭证文件,输出一条日志，提示UUID
      文件默认生成在 C:\Users\你的用户名\.cloudflared\目录下
         建议 复制或移动到 想要的位置(我的是放在D:\Cloudflare\下了) . 
               重命名为 创建隧道时的名字(我的是shiyan-tunnel.json)

4) 配置路由与服务：创建配置文件（例如 `%USERPROFILE%\.cloudflared\config.yml`）：
   ```yaml
   tunnel: dev-tunnel
   credentials-file: C:\Users\你的用户名\.cloudflared\dev-tunnel.json

   ingress:
      - hostname: app.shiyan.online
         service: http://localhost:5173
      - hostname: api.shiyan.online
         service: http://localhost:8080
      - service: http_status:404
   ```
   hostname:是购买的域名(可以是顶级域名,可以是子域名)
5) 为隧道创建 DNS 记录：
   ```powershell
   cloudflared tunnel route dns dev-tunnel dev.example.com
   ```
6) 启动隧道：
   ```powershell
   cloudflared tunnel run shiyan-tunnel
   ```
   或者是：(如果移动了凭证文件到其他位置)
   ```powershell
   cloudflared.exe tunnel --config E:\cloudflared\config.yml run
   ```


7) 配置 QQ 互联与项目 `application.yml`：
   - `redirect-uri` 用 `https://dev.example.com/api/auth/qq/callback`。
   - `cors.allowed-origins` 加入你的子域与本地前端地址。

### 注意事项
- 端口无需在公网开放；所有入站流量从 Cloudflare 边缘进入你的隧道。
- 使用专用子域进行联调，以避免影响正式站点；建议采用短期子域并限制暴露范围。
- 注意 Cloudflare 的缓存与安全策略（如 WAF/Bot 管理）对回调请求的影响，必要时关闭相关规则或添加放行。

---

## 与 QQ 登录的联调整体步骤（四种工具通用）

1) 启动后端服务在本地：确保 `http://localhost:8080` 可访问，且 `GET /api/auth/qq/callback` 正常。
2) 选择任意一种隧道工具并获取稳定的 `https://` 公网地址（域名）。
3) 在 QQ 互联平台创建应用：
   - 网站地址：填写你的隧道域名（如 `https://abcd1234.ngrok.io` 或 `https://dev.example.com`）。
   - 回调地址（redirect_uri）：严格填写 `https://你的域名/api/auth/qq/callback`。
4) 更新后端配置 `backend/src/main/resources/application.yml`：
   ```yaml
   frontend:
     base-url: "http://localhost:5173"   # Vite 本地开发地址
   oauth:
     qq:
       app-id: "你的 App ID"
       app-key: "你的 App Key"
       redirect-uri: "https://你的域名/api/auth/qq/callback"
   cors:
     allowed-origins:
       - "http://localhost:5173"
       - "https://你的域名"
     allowed-origin-patterns:
       - "http://localhost:*"
   ```
5) 启动前端开发服务：`http://localhost:5173`。
6) 在登录页点击 QQ 登录按钮：浏览器跳转至 QQ 授权页 → 同意 → 回调到你的隧道回调地址 → 后端生成 JWT → 302 到 `/#/oauth/callback` → 前端保存 token 并跳首页。

---

## 常见问题与排查

- 重启后域名变化（ngrok/localtunnel）：需同步更新 QQ 平台配置与 `application.yml`。
- QQ 平台提示 `redirect_uri` 不匹配：协议/域名/端口/路径必须完全一致；建议使用 `https` 且无端口（80/443）。
- 回跳 404：检查 `frontend.base-url` 指向实际前端地址，确保前端路由包含 `/#/oauth/callback`。
- CORS 阻断：将前端与隧道域名加入 `cors.allowed-origins`；预检失败时检查允许方法与头。
- 国内网络不稳定：优先考虑自建 `frp` 或使用 Cloudflare Tunnel（需域名）。
- 安全建议：
  - 在发起授权时保存并校验 `state`（防 CSRF）；
  - 使用 HTTPS 隧道，避免明文回调被劫持；
  - 控制日志与回调参数暴露，避免泄露敏感信息；
  - 生产环境请不要用临时域名；启用审计与速率限制。

---

## 对比总结（要点）

- ngrok：易用、成熟、付费可保留域名；适合个人与小团队快速联调。
- localtunnel：零账号零配置，上手快；适合一次性演示，稳定性一般。
- frp：自建稳定、性能好；适合团队长期开发与在国内网络环境下的稳定联调。
- Cloudflare Tunnel：免费且稳定，需要域名；适合已有域名、希望减少入站端口暴露的团队。

> 如需我基于你选定的工具，直接为项目生成对应的 `application.yml` 片段与命令脚本，请告诉我你的选择（以及你的域名/隧道地址）。