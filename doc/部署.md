# 拾言（YunBQ）项目部署指南（构建、打包、上线与远端运行）

> 配套文档：为提高可读性与可操作性，建议结合以下文档一起阅读与使用：

- 项目整体介绍与架构：根 `README.md` 与 `scripts/README.md`
- 本地运行（不启用开发工具）指南：`本地运行-不启用开发工具.md`
- 生产部署（Linux + Docker + Nginx，含域名与端口定制）：`生产部署-Docker-Nginx.md`
- 生产上线完整清单（安全、监控、备份、CI/CD、验收等）：`生产上线完整清单.md`


> 适用对象：希望把本项目部署到服务器并开始对外服务的工程人员与运维人员。
>
> 技术栈：后端 `Java 17 + Spring Boot 3.3.4 + MyBatis-Plus + MySQL + Redis`，前端 `Vue 3 + Vite`，反向代理 `Nginx`。

---

## 1. 项目概览与目录结构

- 根目录结构（重点）
  - `backend/`：后端 Spring Boot 项目，产物为可运行 `jar`。
  - `frontend/`：前端 Vue 3 项目，产物为静态网站 `dist/`。
  - `backend/src/main/resources/application.yml`：默认配置（开发风格），生产需覆盖关键项。
  - `backend/src/main/resources/application-prod.yml`：生产 CORS 示例（按你的域名配置）。
  - `backend/src/main/resources/schema.sql`：数据库初始化脚本（首次部署可开启自动执行）。
  - `backend/sql/init_schema.sql`：手动建库/建表脚本（与 resources/schema.sql 对齐）。
  - `backend/uploads/avatars/`：本地上传目录（后端将其映射到 HTTP `/uploads/**` 访问）。

---

## 2. 前端构建与打包

- 在构建机或你的本地执行：
  - `cd frontend`
  - `npm ci`
  - `npm run build`
- 构建产物：
  - 生成 `frontend/dist` 目录，将其中内容部署到 `Nginx` 的静态根目录（例如 `/var/www/yunbq`）。
- 生产环境接口地址：在 `frontend/.env.production` 设置 `VITE_API_BASE=https://your-domain.com/api`，或在构建机通过环境变量注入。
- 资源路径说明：
  - 前端的 API 路径均以 `/api` 为前缀（由 `http.js` 的 `baseURL` 统一拼接）。
  - 头像等静态资源（例如 `/uploads/avatars/...`）会从 `baseURL` 去掉 `/api` 前缀后拼接为完整 URL（详见 `AdminUsers.vue` 中的 `avatarFullUrl` 逻辑）。

---

## 3. 后端构建、编译与打包

- 在构建机或你的本地执行：
  - `cd backend`
  - `mvn -q -DskipTests clean package`
- 产物：
  - `backend/target/backend-0.0.1-SNAPSHOT.jar`
- Java 版本：
  - 需安装 `Java 17`（`java -version` 输出 17）。
- 启动方式（基础）：
  - `java -jar backend-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod`
  - 建议通过 `systemd`（Linux）或 `NSSM`（Windows）注册为服务，以实现守护与自动重启。

---

## 4. 生产环境配置（关键项与安全项）

> 生产环境建议优先使用环境变量覆盖配置，而不是直接修改 `application.yml`。

- 数据库连接（MySQL）：
  - `SPRING_DATASOURCE_URL=jdbc:mysql://<mysql_host>:3306/yunbq?useUnicode=true&characterEncoding=utf8&serverTimezone=UTC&useSSL=false`
  - `SPRING_DATASOURCE_USERNAME=yunbq`
  - `SPRING_DATASOURCE_PASSWORD=<强密码>`
- Redis（可选但建议启用）：
  - `SPRING_DATA_REDIS_HOST=<redis_host>`
  - `SPRING_DATA_REDIS_PORT=6379`
  - 如有密码：`SPRING_DATA_REDIS_PASSWORD=<密码>`
- JWT（必须替换默认值）：
  - `JWT_SECRET=<随机且足够长的密钥>`
  - `JWT_ISSUER=<你的应用或域名>`
  - `JWT_EXPIRE_MINUTES=1440`（可按需调整）
- 邮件（如启用绑定邮箱/找回密码）：
  - `SPRING_MAIL_HOST=<smtp_host>`
  - `SPRING_MAIL_PORT=<smtp_port>`
  - `SPRING_MAIL_USERNAME=<邮箱账号>`
  - `SPRING_MAIL_PASSWORD=<邮箱授权码>`
  - 注意：仓库中的默认账号/密码仅用于本地演示，生产必须覆盖。
- CORS 与前端地址：
  - `application-prod.yml` 中示例：将 `cors.allowed-origins` 配置为你的前端域名（例如 `https://your-domain.com`）。
  - 如前后端不同域名，需正确设置 `allowed-origins` 或 `allowed-origin-patterns`，并包含所需方法（含 `PATCH`）。
- SQL 初始化策略：首次部署设 `spring.sql.init.mode=always` 自动执行 `schema.sql`；初始化后改为 `never`。如需手动控制，执行 `backend/sql/init_schema.sql`。

---

## 5. 数据库初始化与账号

- 创建数据库与账号（示例）：
  - `CREATE DATABASE yunbq CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;`
  - `CREATE USER 'yunbq'@'%' IDENTIFIED BY '<强密码>';`
  - `GRANT ALL PRIVILEGES ON yunbq.* TO 'yunbq'@'%'; FLUSH PRIVILEGES;`
- 字符集建议：
  - MySQL 与表均为 `utf8mb4`，以支持 Emoji 与完整 Unicode。
- 首次启动：
- 若设为 `always`，后端启动将自动执行 `schema.sql` 完成初始化；如采用手动方式，执行 `backend/sql/init_schema.sql`。

---

## 6. 文件上传与静态资源映射

- 后端在启动时会将工作目录下的 `uploads` 映射到 HTTP 路径 `/uploads/**`。
- 头像保存目录：`uploads/avatars/`。
- 生产服务器建议：
  - 在统一的工作目录（例如 `/opt/yunbq`）创建 `uploads/avatars`：
    - `mkdir -p /opt/yunbq/uploads/avatars`
    - 确保运行后端的用户对该目录拥有读写权限。
- 如需对象存储（OSS/S3）：
  - 将头像存储改为对象存储并返回 CDN 地址；
  - 同时调整后端静态资源映射或直接改为外链。

---

## 7. Nginx 部署（静态前端 + 反向代理后端）

- 静态站点：将 `frontend/dist` 内容部署至 `Nginx` 的站点根。
- 反向代理：将 `/api/` 前缀转发到后端 `8080` 端口。
- 示例（含 HTTPS 与 HTTP/2，可用 `certbot` 自动签发证书）：

```nginx
server {
  listen 80;
  server_name your-domain.com;
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl http2;
  server_name your-domain.com;

  # 证书（使用 certbot 安装后生成路径）
  ssl_certificate     /etc/letsencrypt/live/your-domain.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

  # 前端静态资源
  root /var/www/yunbq;
  index index.html;

  # 单页应用：不存在的路径回退到 index.html
  location / {
    try_files $uri /index.html;
  }

  # 反向代理到后端（Spring Boot）
  location /api/ {
    proxy_pass http://127.0.0.1:8080/api/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # 上传目录直传（如需 Nginx 直接服务静态文件，可开启）
  # location /uploads/ {
  #   alias /opt/yunbq/uploads/;
  #   autoindex off;
  # }
}
```

- CORS 配合：若前后端同域名，CORS 最简单；若不同域名，请在后端配置允许的 `origins/patterns`。

---

## 8. 远端运行方式

### 8.1 Linux（推荐）systemd 服务

- 路径建议：
  - 将 `backend-0.0.1-SNAPSHOT.jar` 放到 `/opt/yunbq/`；
  - 将 `uploads/` 放到 `/opt/yunbq/uploads/`。
- 服务文件（`/etc/systemd/system/yunbq-backend.service`）：

```ini
[Unit]
Description=YunBQ Spring Boot Backend
After=network.target

[Service]
WorkingDirectory=/opt/yunbq
ExecStart=/usr/bin/java -Xms256m -Xmx512m -jar /opt/yunbq/backend-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod
Restart=always
User=www-data
Environment=SPRING_DATASOURCE_URL=jdbc:mysql://<mysql_host>:3306/yunbq?useUnicode=true&characterEncoding=utf8&serverTimezone=UTC&useSSL=false
Environment=SPRING_DATASOURCE_USERNAME=yunbq
Environment=SPRING_DATASOURCE_PASSWORD=<强密码>
Environment=SPRING_DATA_REDIS_HOST=<redis_host>
Environment=SPRING_DATA_REDIS_PORT=6379
Environment=JWT_SECRET=<长随机密钥>
Environment=JWT_ISSUER=your-domain.com
Environment=JWT_EXPIRE_MINUTES=1440

[Install]
WantedBy=multi-user.target
```

- 启用与查看：
  - `sudo systemctl daemon-reload`
  - `sudo systemctl enable yunbq-backend`
  - `sudo systemctl start yunbq-backend`
  - `sudo systemctl status yunbq-backend`
  - 日志：`journalctl -u yunbq-backend -f`

### 8.2 Windows（NSSM 管理服务）

- 安装 NSSM（或使用 `sc.exe` 建服务）：
  - `nssm install YunBQ`
  - Path：`C:\Program Files\Java\jdk-17\bin\java.exe`
  - Arguments：`-Xms256m -Xmx512m -jar C:\opt\yunbq\backend-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod`
  - Startup directory：`C:\opt\yunbq`
  - 在 NSSM 的 Environment 中设置上述环境变量（数据库、JWT、Redis 等）。
  - 启动服务：`nssm start YunBQ`。

### 8.3 直接运行（开发或临时）

- `java -jar backend-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod`
- 在启动终端设定必要的环境变量（Windows PowerShell 示例）：

```powershell
$env:SPRING_DATASOURCE_URL="jdbc:mysql://dbhost:3306/yunbq?useUnicode=true&characterEncoding=utf8&serverTimezone=UTC&useSSL=false"
$env:SPRING_DATASOURCE_USERNAME="yunbq"
$env:SPRING_DATASOURCE_PASSWORD="<强密码>"
$env:SPRING_DATA_REDIS_HOST="redis-host"
$env:JWT_SECRET="<长随机密钥>"
$env:JWT_ISSUER="your-domain.com"
java -jar target\backend-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod
```

### 8.4 Docker Compose（可选）

- 示例 `docker-compose.yml`（参考，仅供自定义）：

```yaml
version: '3.8'
services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_DATABASE: yunbq
      MYSQL_USER: yunbq
      MYSQL_PASSWORD: <强密码>
      MYSQL_ROOT_PASSWORD: <更强的密码>
    volumes:
      - ./data/mysql:/var/lib/mysql
    ports:
      - "3306:3306"
  redis:
    image: redis:7
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - ./data/redis:/data
    ports:
      - "6379:6379"
  backend:
    image: eclipse-temurin:17-jre
    working_dir: /app
    volumes:
      - ./backend/target/backend-0.0.1-SNAPSHOT.jar:/app/app.jar
      - ./uploads:/app/uploads
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/yunbq?useUnicode=true&characterEncoding=utf8&serverTimezone=UTC&useSSL=false
      SPRING_DATASOURCE_USERNAME: yunbq
      SPRING_DATASOURCE_PASSWORD: <强密码>
      SPRING_DATA_REDIS_HOST: redis
      JWT_SECRET: <长随机密钥>
      JWT_ISSUER: your-domain.com
    command: ["java","-Xms256m","-Xmx512m","-jar","/app/app.jar","--spring.profiles.active=prod"]
    ports:
      - "8080:8080"
    depends_on:
      - mysql
      - redis
  nginx:
    image: nginx:stable
    volumes:
      - ./frontend/dist:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./uploads:/opt/yunbq/uploads:ro
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - backend
```

---

## 9. 常见问题与注意事项

- 强制替换默认密钥与凭据：
  - `JWT_SECRET`、数据库账号与密码、邮件 `SPRING_MAIL_*` 等必须使用你自己的安全值，切勿使用仓库中的示例值。
- CORS 问题（跨域 403）：
  - 确认 `application-prod.yml` 中允许的域名与方法；若前端与后端域名一致，最简方案是同域部署。
- 数据库初始化重复或失败：
  - 首次部署后将 `spring.sql.init.mode` 调整为 `never`；如需增量表结构，使用 `backend/sql/*.sql` 手动执行。
- 头像或上传 404：
  - 核实 `uploads/avatars` 目录存在且后端运行用户有读写权限；
  - 若改用对象存储，请更新返回 URL 与静态资源映射策略。
- 端口与反代路径不一致：
  - 前端 `VITE_API_BASE` 的 `/api` 前缀要与 Nginx 反代路径一致；前端内部接口路径不要重复写 `/api`。
- 内存与稳定性：
  - 为后端设置合适的 JVM 启动参数（如 `-Xmx512m`），观察负载后再调整；
  - 可以配合 `systemd` 的 `Restart=always` 实现故障自动重启。

---

## 10. 运维与监控建议

- 日志保留与采样（见 `application.yml` 的 `logdb.*`）：
  - 根据实际需求调整 `request-sampling-percent`（请求日志采样）与 `retention-*-days`（保留天数），控制数据量与性能。
- 备份与恢复：
  - 定期备份 MySQL 数据与上传目录；
  - 在变更表结构前做好快照或备份，避免不可逆风险。
- 监控：
  - 建议接入基础监控（CPU/内存/磁盘/端口存活）与应用日志告警；
  - 若使用 Docker，可在 Compose 中加入健康检查与重启策略。

---

## 11. 快速上线清单（Checklist）

- [ ] 准备服务器（Linux/Windows）与依赖（Java 17、MySQL、Redis、Nginx）。
- [ ] 创建数据库与账号；设置 `utf8mb4` 字符集。
- [ ] 前端设置 `VITE_API_BASE=https://your-domain.com/api` 并打包 `dist`。
- [ ] 后端打包 `jar`；配置环境变量（数据库、JWT、Redis、邮件等）。
- [ ] 创建 `uploads/avatars` 并赋权；确认静态映射可用。
- [ ] 配置 Nginx：静态站点 + `/api/` 反向代理到后端 `8080`；配置证书。
- [ ] 首次启动可执行 `schema.sql` 初始化；后续改为 `never`。
- [ ] 验证关键接口（登录、管理员页、消息、上传头像等）。
- [ ] 配置服务守护（systemd/NSSM）；设置 JVM 内存与重启策略。
- [ ] 启用监控与备份；收敛日志采样与保留策略。

---

如需我根据你的目标环境（Linux/Windows、是否用 Docker、具体域名与端口）生成一套“可直接复制粘贴”的 Nginx 配置、服务文件与启动命令合集，请告知，我可以按你的参数生成并解释每一行的作用。
