# 从本地开发到可公网访问的完整指南

面向当前项目（前端 `Vite + Vue`，后端 `Spring Boot`），本指南手把手教你从本地开发环境，逐步将服务暴露到公网使外部用户可访问。内容涵盖：域名与隧道/代理、后端安全与 CORS 设置、前端环境配置、上线验证与排错、运维建议。

## 一览（你需要做的事）
- 准备域名与公网入口：Cloudflare Tunnel 或 Nginx 反向代理（推荐 HTTPS）。
- 后端：完善 CORS（允许你的前端域名及所需方法/头）、确认公开接口授权、重启服务。
- 前端：设置 `baseURL` 指向公网 API 域名，确认跨域配置与鉴权头处理。
- 验证：浏览器 Network 面板与 `curl` 检查响应头，后端控制台日志联动定位。
- 运营：开机自启、基础安全（HTTPS、限流）、日志与监控。

---

## 前提条件与目标域名
- 本地后端监听：`http://localhost:8080`
- 本地前端开发：`http://localhost:5173`（Vite 开发服务器）
- 公网域名示例：
  - 前端：`app.shiyan.online`
  - 后端：`api.shiyan.online`
- 目标：`https://app.shiyan.online` 页面能请求 `https://api.shiyan.online` 的接口；如暂时为 HTTP，则需在后端 CORS 中允许 `http://app.shiyan.online`。

---

## 后端配置（Spring Security 与 CORS）

后端的授权规则与跨域放行由 `SecurityConfig` 与 `application.yml` 控制。确保以下点：

### 授权放行导航接口
- 在 `SecurityConfig` 中明确放行导航相关的匿名访问：
  - `GET /api/navigation/**`
  - `HEAD /api/navigation/**`
  - `OPTIONS /**`（CORS 预检必须放行）
- JWT 过滤器在缺少或校验失败时不会直接返回 403，只会清理上下文并继续链路；因此 403 更可能来自 CORS 层。

### CORS 允许来源、方法与头
在 `backend/src/main/resources/application.yml` 配置 `cors` 段落，注意允许你的前端域名（含子域与协议）：

```yaml
cors:
  allowed-origins:
    # 明确列出已知来源（可选）
    - "http://localhost:5500"
    - "http://localhost:5173"
    - "https://app.shiyan.online"
    - "https://api.shiyan.online"
  allowed-origin-patterns:
    - "http://localhost:*"
    # 为所有 HTTPS 子域（如 app.shiyan.online、api.shiyan.online）启用跨域匹配
    # 注意：当 allowCredentials=true 时，不能使用 "*"，需使用 patterns 精确匹配
    - "https://*.shiyan.online"
    # 若你的前端暂时以 HTTP 提供（例如 Origin 为 http://app.shiyan.online），需要允许 HTTP 子域：
    - "http://*.shiyan.online"
  allowed-methods:
    - GET
    # 一些浏览器/代理会在 GET 前发起 HEAD 探测；未放行 HEAD 可能导致 403
    - HEAD
    - POST
    - PUT
    - DELETE
    - OPTIONS
    # 管理后台或部分操作可能使用 PATCH；未声明会导致预检失败
    - PATCH
  allowed-headers:
    - Authorization
    - Content-Type
    # 常见 AJAX 头；未允许可能导致预检（OPTIONS）失败
    - X-Requested-With
  # 允许携带 Cookie/凭据；启用后不能使用 "*" 作为允许来源
  allow-credentials: true
```

说明：
- 若前端与后端都上 HTTPS，建议去掉 `http://*.shiyan.online`，提升整体安全性。
- `allowed-origin-patterns` 与 `allowed-origins` 二选一即可；前者支持通配更灵活。

### 重启后端使配置生效
- Windows PowerShell：
  - 构建：`mvn -DskipTests package`
  - 启动：`java -jar target/backend-0.0.1-SNAPSHOT.jar`
- 启动后检查控制台：应看到 `Tomcat initialized with port 8080` 等信息。

---

## 前端配置（Vite + Axios）

### baseURL 指向公网后端
- 在 `frontend/src/api/http.js`（或你的 API 客户端配置处）确保 `baseURL` 能在生产环境指向 `https://api.shiyan.online`：
  - 开发环境：使用 `.env.development` 设置 `VITE_API_BASE_URL=http://localhost:8080`
  - 生产环境：使用 `.env.production` 设置 `VITE_API_BASE_URL=https://api.shiyan.online`
- 项目已有智能回退逻辑（优先环境变量，其次推断公网域名），但推荐显式配置以避免误判。

### 跨域与鉴权头
- 请求拦截器添加 `Authorization: Bearer <token>`（如登录后）；
- 若需要携带 Cookie，确保前端开启 `withCredentials`，且后端 `allowCredentials=true`；
- 避免添加未声明的自定义头部（例如某些库自动注入的头）；如需自定义，请在 CORS `allowed-headers` 中加入。

---

## 公网入口方案 A：Cloudflare Tunnel（免服务器）

适合快速把内网 `localhost` 暴露到公网，自动获取 HTTPS（建议前端走 HTTPS）。

### 1. 安装与准备
- 安装 `cloudflared` 并登录 Cloudflare 账号；
- 在你的域名下创建 Tunnel 并记录 Tunnel ID。

### 2. 配置示例（`E:\cloudflared\config.yml`）

```yaml
tunnel: <YOUR_TUNNEL_ID>
credentials-file: C:\Users\<you>\.cloudflared\<YOUR_TUNNEL_ID>.json

ingress:
  # 将 api.shiyan.online 反代到本地后端
  - hostname: api.shiyan.online
    service: http://localhost:8080
  # 若要直接暴露本地前端开发服务器（不推荐生产使用）
  - hostname: app.shiyan.online
    service: http://localhost:5173
  # 兜底规则（必须存在）
  - service: http_status:404
```

### 3. 运行与 DNS
- 启动命令（Windows）：
  - `cloudflared.exe tunnel --config E:\cloudflared\config.yml run`
- Cloudflare 会自动为 `hostname` 创建 CNAME 指向 Tunnel；
- 完成后，访问 `https://api.shiyan.online` 将直达你的本地后端。

### 4. 注意事项
- 若前端页面通过 HTTP 暴露（`http://app.shiyan.online`），后端必须允许该 Origin；建议尽快切换到 HTTPS。
- 若开启了 Cloudflare Access/WAF，请确认未拦截你的 API 路径或预检请求。

---

## 公网入口方案 B：Nginx 反向代理（服务器/云主机）

适合长期部署与更强的运维控制。示例：

```nginx
server {
  listen 80;
  server_name api.shiyan.online;
  return 301 https://$host$request_uri;  # 强制 HTTPS
}

server {
  listen 443 ssl;
  server_name api.shiyan.online;
  ssl_certificate     /etc/letsencrypt/live/api.shiyan.online/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/api.shiyan.online/privkey.pem;

  location / {
    proxy_pass http://127.0.0.1:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}
```

前端静态站点（打包后的 `dist`）也可以用 Nginx 提供，并指向 `app.shiyan.online`。

---

## 验证方法（浏览器与命令行）

### 浏览器 Network 面板
- 在 `https://app.shiyan.online` 打开页面，找到对 `https://api.shiyan.online/api/navigation/**` 的请求：
  - 请求头应包含：`Origin: https://app.shiyan.online`（或你的真实前端域名/协议）；
  - 响应头应包含：
    - `Access-Control-Allow-Origin: https://app.shiyan.online`
    - `Access-Control-Allow-Credentials: true`（如启用了凭据）
- 若仍为 403，请记录 `Origin` 实际值，对照后端 CORS 是否覆盖。

### `curl` 验证（仅头部/含主体）
- 本地后端：
  - 只看头：`curl -I -H "Origin: https://app.shiyan.online" http://localhost:8080/api/navigation/categories/all`
  - 看内容：`curl -H "Origin: https://app.shiyan.online" http://localhost:8080/api/navigation/categories/all`
- 公网后端：
  - 只看头：`curl -I -H "Origin: https://app.shiyan.online" https://api.shiyan.online/api/navigation/categories/all`

### 后端控制台日志（已增强）
- 通过 `RequestLoggingFilter` 会打印：
  - `[RequestLoggingFilter] CORS headers: Origin=..., ACR-Method=..., ACR-Headers=...`
  - `[RequestLoggingFilter] CORS response: Allow-Origin=..., Allow-Credentials=...`
- 看到 `Allow-Origin` 为你的前端域名且状态码为 200，即为成功。

---

## 常见问题与排错

- 403（跨域）
  - 现象：响应无 `Access-Control-Allow-Origin`，控制台状态码 403。
  - 根因：后端 `allowed-origin-patterns` 未包含你的真实 `Origin`（特别是 HTTP/HTTPS 不一致）。
  - 处理：在 `application.yml` 中加入相应通配（如 `http://*.shiyan.online` 或 `https://*.shiyan.online`），重启后端。

- 401（未认证）
  - 现象：访问受保护接口返回 401。
  - 根因：未携带有效的 `Authorization: Bearer <token>`。
  - 处理：登录流程获取 token，或只访问公开接口（如导航与便签的匿名 GET）。

- 预检失败（OPTIONS 直接失败）
  - 现象：浏览器在发起非简单请求前的 OPTIONS 预检返回失败，实际请求未发出。
  - 根因：`allowed-methods` 未包含实际方法（如 PATCH）、`allowed-headers` 未包含实际头（如 `X-Requested-With`）。
  - 处理：补齐方法与头，确保 `OPTIONS /**` 放行。

- 代理层拦截/改写
  - 现象：Cloudflare WAF 或 Nginx 重写导致 `Origin` 异常或请求被阻断。
  - 处理：检查 Cloudflare Access/WAF 规则、Nginx 配置中的头转发与证书配置。

---

## 运维与上线建议

- 强制 HTTPS：前端与后端均使用 HTTPS，避免混合内容与安全警告。
- 最小放行：CORS 只允许你需要的域名；上线后可移除开发域名与 HTTP 通配。
- 速率限制：对写操作接口启用限流（Nginx/Cloudflare/WAF）。
- 日志与监控：
  - 后端日志文件：`backend/logs/app.log`
  - 控制台日志开启 `org.springframework.security: DEBUG` 有助联调；生产可降级。
- 开机自启：
  - Windows 可用计划任务或 NSSM 将后端 Jar 注册为服务。
  - Cloudflare Tunnel 可注册为服务并随开机自启。

---

## 附录：关键配置片段

### SecurityConfig（摘要）
```java
// 关键点：放行导航 GET/HEAD、放行所有 OPTIONS 预检、异常处理统一 401/403
.authorizeHttpRequests(auth -> auth
    .requestMatchers(HttpMethod.OPTIONS, "/**").permitAll()
    .requestMatchers(HttpMethod.GET, "/api/navigation/**").permitAll()
    .requestMatchers(HttpMethod.HEAD, "/api/navigation/**").permitAll()
    .anyRequest().authenticated()
)
```

### CORS 配置源（摘要）
```java
CorsConfiguration config = new CorsConfiguration();
config.setAllowCredentials(true);
config.setAllowedOriginPatterns(List.of(
    "https://*.shiyan.online",
    "http://*.shiyan.online",
    "http://localhost:*"
));
config.setAllowedMethods(List.of("GET","POST","PUT","DELETE","OPTIONS","PATCH","HEAD"));
config.setAllowedHeaders(List.of("Authorization","Content-Type","X-Requested-With"));
```

### Cloudflare Tunnel 启动命令（Windows）
```powershell
cloudflared.exe tunnel --config E:\cloudflared\config.yml run
```

---

## 最后
完成以上步骤后，外部用户即可通过你的域名访问前端页面与后端接口。若遇到问题，请结合浏览器 Network、`curl` 与后端控制台的 CORS 日志进行定位，并按“常见问题与排错”一节逐项核对与修复。