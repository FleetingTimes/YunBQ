# 生产上线完整清单（一次性准备项与落地操作）

> 环境基线：Linux + Docker（Compose），域名示例 `com.linaa.shiyan`，对外端口 `6639`（可替换为 80/443）。
> 目标：除 HTTPS 生产版配置外，所有必须或强烈建议的准备与操作项，集中成一份可执行清单。

---

## 1. 基础设施与系统

- 确认服务器规格：CPU/内存/磁盘充足，磁盘预留上传与日志空间。
- 操作系统与内核版本：推荐 Ubuntu 22.04+；保持安全更新与内核稳定。
- 安装依赖（构建机与服务器分工）：
  - 构建机：`Java 17`、`Node.js 18+`、`Maven`、`npm`。
  - 服务器：`Docker`、`Docker Compose`、`Nginx`（在容器或宿主均可）。
- 时区与时间同步：统一 `UTC` 或业务时区；安装 `chrony`/`ntpd`，避免时间漂移导致令牌与日志异常。
- 文件系统与权限：创建上传目录 `uploads/avatars` 并赋予运行用户读写权限（容器挂载到 `/opt/yunbq/uploads/avatars`）。

---

## 2. 域名与网络

- DNS 解析：为 `com.linaa.shiyan` 创建 `A` 记录指向服务器公网 IP。
- 防火墙与安全组：放通 `6639`（当前对外端口），建议同步放通 `80/443` 以随时切换到标准 HTTP/HTTPS。
  - Ubuntu `ufw` 示例：
    - `sudo ufw allow 6639`
    - `sudo ufw allow 80`
    - `sudo ufw allow 443`
- 反向代理端口与路径规划：统一 `/api/` 作为后端入口前缀；前端静态托管到站点根。

---

## 3. 证书与 HTTPS（标准做法与自定义端口）

- 标准 443 端口：使用 `certbot --nginx -d com.linaa.shiyan` 自动签发并续期；Nginx 开启 `http2` 与安全头部。
- 自定义端口 6639 启用 TLS：准备证书文件，`listen 6639 ssl;` 并配置 `ssl_certificate` 与 `ssl_certificate_key`；注意客户端与中间设备兼容性。
- 安全响应头部（仅 HTTPS 生效）：
  - `Strict-Transport-Security: max-age=31536000; includeSubDomains; preload`
  - `X-Content-Type-Options: nosniff`
  - `X-Frame-Options: SAMEORIGIN`
  - `Referrer-Policy: no-referrer-when-downgrade`

---

## 4. Docker 与 Compose

- 敏感变量集中管理：创建 `docker-compose.env`，包含数据库、Redis、JWT、邮件等，Compose 使用 `env_file` 引用，避免明文写在 `yml`。
- 重启与健康检查：为 `backend/mysql/redis` 设置 `restart: always` 与 `healthcheck`；Nginx 可用默认健康策略。
- 数据卷规划：持久化 `mysql`（`./data/mysql`）、`redis`（`./data/redis`）、`uploads`（`./uploads`）；备份策略见下文。
- 网络：统一 `bridge` 网络（如 `yunbq-net`），确保 `nginx` 可通过服务名 `backend` 访问后端容器（端口 `8080`）。

---

## 5. Nginx 生产级增强

- 压缩：开启 `gzip` 或 `brotli`（若安装了模块）；静态与代理响应均启用，提高传输效率。
- 缓存与静态优化：
  - 对构建产物（带 hash 的 CSS/JS）设置长缓存：`Cache-Control: public, max-age=31536000, immutable`。
  - `index.html` 设置不缓存：`Cache-Control: no-cache`，确保热更新。
- 限制与超时：
  - `client_max_body_size` 按上传需求设置（与后端 `multipart.max-file-size` 对齐）。
  - `proxy_read_timeout`、`keepalive_timeout` 视业务请求耗时调整。
- 日志：访问与错误日志分文件、按大小轮转；可定制 `log_format` 带上 `request_id` 等字段。

---

## 6. 后端生产配置（必须替换默认值）

- 数据源：
  - `SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/yunbq?useUnicode=true&characterEncoding=utf8&serverTimezone=UTC&useSSL=false`
  - `SPRING_DATASOURCE_USERNAME=yunbq`
  - `SPRING_DATASOURCE_PASSWORD=<强密码>`
- Redis：
  - `SPRING_DATA_REDIS_HOST=redis`
  - `SPRING_DATA_REDIS_PORT=6379`
  - 如有密码：`SPRING_DATA_REDIS_PASSWORD=<密码>`
- JWT：
  - `JWT_SECRET=<随机且足够长的密钥>`（必须替换示例值）
  - `JWT_ISSUER=com.linaa.shiyan`
  - `JWT_EXPIRE_MINUTES=1440`（按需调整）
- 邮件（如启用绑定邮箱/找回密码）：
  - `SPRING_MAIL_HOST=<smtp_host>`、`SPRING_MAIL_PORT=<smtp_port>`、`SPRING_MAIL_USERNAME=<账号>`、`SPRING_MAIL_PASSWORD=<授权码>`
- Profile：
  - 启动加 `--spring.profiles.active=prod`，使生产 CORS 等配置生效。
- SQL 初始化策略：
  - 首次部署可开启 `SPRING_SQL_INIT_MODE=always` 自动执行 `schema.sql`；初始化后改为 `never`。
- 日志采样与保留：
  - `logdb.request-sampling-percent`、`retention-*-days` 根据数据量与排障需求调整。
- JVM 参数：
  - 设置 `-Xms/-Xmx`（如 `-Xmx512m`）并观察运行时内存；必要时开启 GC 日志定位问题。

---

## 7. 前端生产配置

- 环境变量：在 `frontend/.env.production` 设置 `VITE_API_BASE=http://com.linaa.shiyan:6639/api`（或 `https://`）。
- 构建：`npm run build` 生成 `dist`，在 Nginx 挂载 `/usr/share/nginx/html`。
- 路径约定：前端调用统一不再重复 `/api` 前缀（由 Axios `baseURL` 负责）；头像与上传资源走 `/uploads/**`。

---

## 8. 数据库与缓存（初始化与优化）

- 建库与授权：
  - `CREATE DATABASE yunbq CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;`
  - `CREATE USER 'yunbq'@'%' IDENTIFIED BY '<强密码>';`
  - `GRANT ALL PRIVILEGES ON yunbq.* TO 'yunbq'@'%'; FLUSH PRIVILEGES;`
- MySQL 优化：
  - `innodb_buffer_pool_size`、`max_connections`、`slow_query_log` 根据负载调优。
- Redis 持久化：
  - 启用 `appendonly yes`（示例已启用），规划持久化目录与内存上限；必要时加密码与网络访问限制。
- 表结构迁移：
  - 首发用 `schema.sql`，后续建议使用增量脚本或迁移工具，避免每次启动执行 DDL。

---

## 9. 文件与备份

- 备份范围：MySQL 数据、`uploads/`、Compose 文件与 Nginx 配置、前后端构建产物与版本记录。
- 备份频率与保留：每日/每周，至少保留近 30 天；建议异地备份或对象存储。
- 恢复演练：按季度演练备份恢复，避免真实故障时无可用恢复手段。

---

## 10. 安全强化

- 凭据管理：敏感变量用 `.env`/`env_file`，限制读取权限；避免明文提交到仓库。
- 管理端保护：后端已有权限校验；可在 Nginx 对管理路径加 IP 白名单或额外认证。
- 登录防护：限制失败次数、验证码或风控策略（结合认证日志与请求日志）。
- 依赖与镜像更新：定期升级基础镜像与依赖；进行安全扫描与修复。
- 主机加固：SSH 端口与秘钥认证、禁用密码登录、`fail2ban` 防暴力尝试。

---

## 11. 监控与告警

- 应用监控：接口可用性、响应时间、错误率；对接 ELK/Promtail-Loki 或简易日志采集。
- 系统监控：CPU/内存/磁盘/网络；容器健康检查。
- 告警通道：邮件、企业 IM（钉钉/飞书/Slack）；合理设置阈值与抖动保护。

---

## 12. CI/CD 与发布

- 构建流水线：后端 `mvn package`、前端 `npm run build`，产物上传至服务器或镜像仓库。
- 制品管理：后端 Jar 与前端 `dist` 纳入制品库，便于回滚与溯源。
- 发布策略：预生产验证、灰度发布与快速回滚（保留上一个稳定版本与 Compose 切换脚本）。

---

## 13. 伸缩与高可用（按需）

- 横向扩展：后端多副本 + 负载均衡（Nginx/HAProxy 或云 LB）；会话无状态（JWT）便于扩容。
- 数据库 HA：主从复制与读写分离；故障切换与备份联动。
- 静态与上传：接入 CDN 与对象存储，降低带宽与单机压力。

---

## 14. 验收与健康检查

- 功能验收：登录/注册、管理员页（用户、日志、导航）、消息中心、上传头像。
- 性能验收：列表分页与导出接口在真实数据量下的响应时间；必要时限流与批次导出。
- 健康检查端点：`/admin/health`（管理员校验）、可选启用 Spring Actuator 的 `/actuator/health`。

---

## 15. 快速落地清单（Checklist）

- [ ] 准备服务器与依赖（Docker/Compose、Nginx、可选 Java/Node 用于本地构建）。
- [ ] 配置 DNS 与防火墙（6639/80/443）。
- [ ] 构建产物：`frontend/dist` 与 `backend/target/backend-0.0.1-SNAPSHOT.jar`。
- [ ] 创建上传目录并赋权：`/opt/yunbq/uploads/avatars`。
- [ ] 写入并启用 Nginx 与 Compose（含 `env_file`）。
- [ ] 首次初始化数据库（`SPRING_SQL_INIT_MODE=always`）后改为 `never`。
- [ ] 设置并核对 `VITE_API_BASE`、后端 CORS 与 JWT/数据库/Redis/邮件变量。
- [ ] 验证关键接口与页面（登录、管理员、消息、上传）。
- [ ] 启用监控、备份与日志保留策略；安全与加固到位。

---

如需我将上述清单换成你的标准端口（80/443）与完整 HTTPS 配置（含证书自动签发与续期），或生成 `docker-compose.env` 模板，请告知；我可以直接补充到仓库并联动更新 `生产部署-Docker-Nginx.md`。

---

## 16. 本地运行（不启用开发工具）验证

为确保上线前在本机完成端到端验证、且不依赖任何开发服务器或热重载，请参考：

- `本地运行-不启用开发工具.md`

验证关注点：
- 后端以 `--spring.profiles.active=prod` 启动，并显式传入数据库/Redis/JWT/邮件等参数
- 前端生产构建后以静态服务器或 Nginx 提供 `dist/`，`VITE_API_BASE=http://localhost:6639/api`
- 访问 `http://localhost:5173` 并验证登录、资料编辑、日志查询与上传头像等关键路径

---

## 17. 脚本与模板（快速落地）

- 本地运行（不启用开发工具）：
  - Windows：`scripts/local-run/windows/build_and_run_local.ps1`、`scripts/local-run/windows/stop_local.ps1`
  - Linux：`scripts/local-run/linux/build_and_run_local.sh`、`scripts/local-run/linux/stop_local.sh`
- 部署（Docker Compose）：
  - Linux：`scripts/deploy/linux/compose_deploy.sh`、`scripts/deploy/linux/compose_stop.sh`
  - Windows：`scripts/deploy/windows/compose_deploy.ps1`、`scripts/deploy/windows/compose_stop.ps1`
- 模板与环境：
  - Compose：`scripts/templates/docker-compose.yml`
  - Nginx：`scripts/templates/nginx/default.conf`
  - env 示例：`scripts/env/docker-compose.env.example`（复制为 `docker-compose.env` 并填写）

> 所有脚本与模板均附带详细注释，默认域名与端口为 `com.linaa.shiyan:6639`；如需 80/443 + HTTPS，请告知以生成对应配置与命令。