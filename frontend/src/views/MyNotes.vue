<!--
  æˆ‘çš„æ‹¾è¨€è§†å›¾ï¼ˆMyNotesï¼‰
  èŒè´£ä¸ç»“æ„ï¼š
  - ä¸¤æ ç»Ÿä¸€å¸ƒå±€ï¼šå¤ç”¨ TwoPaneLayout çš„â€œå…¨å®½å¸é¡¶é¡¶æ  + å³ä¾§æ­£æ–‡æ»šåŠ¨å®¹å™¨â€ï¼›
  - é¡¶æ ï¼šAppTopBar ç»Ÿä¸€å“ç‰Œä¸å¿«æ·å…¥å£ï¼›æ­£æ–‡å«ä¸ªäººèµ„æ–™æ‘˜è¦ã€è¿‡æ»¤æ ä¸æ‹¾è¨€åˆ—è¡¨ï¼›
  - æä¾›â€œå›åˆ°é¡¶éƒ¨â€ä¸è§¦åº•åŠ è½½ï¼Œå…¼å®¹ç§»åŠ¨ç«¯ä¸æ¡Œé¢ç«¯çš„æ»šåŠ¨ä½“éªŒã€‚
  æ•°æ®ä¸æ¥å£ï¼š
  - æœåŠ¡ç«¯åˆ†é¡µï¼šé€šè¿‡ /shiyan?q&page&size æ‹‰å–æ•°æ®ï¼Œä½¿ç”¨ total åˆ¤æ–­æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€é¡µï¼›
  - åˆ›å»º/æ›´æ–°/åˆ é™¤ï¼šPOST/PUT/DELETE /shiyan åŠ /shiyan/{id}ï¼›
  - ç‚¹èµ/æ”¶è—ï¼šPOST /shiyan/{id}/like|unlike ä¸ /favorite|unfavoriteï¼›å­—æ®µç»Ÿä¸€æ˜ å°„ä¸å…¼å®¹å¤„ç†ã€‚
  ç»†èŠ‚ä¸ä¿®å¤ï¼š
  - Emoji ç²˜è´´ä¿®å¤ï¼šå°†èŠå¤©åº”ç”¨ä¸­çš„å›¾ç‰‡è¡¨æƒ…æ˜ å°„ä¸º Unicode Emojiï¼ˆemojiMapï¼‰ï¼›
  - ç¼–è¾‘æ€èšç„¦ç®¡ç†ä¸é˜²å¹¶å‘åŠ è½½ï¼›è¿‡æ»¤æ ä¸ä½œè€…ä¿¡æ¯å±•ç¤ºå¯¹é½ã€‚
  å®‰å…¨ä¸æƒé™ï¼š
  - é¡µé¢éœ€è¦ç™»å½•ï¼ˆè·¯ç”± meta.requiresAuthï¼‰ï¼›
  - å†™æ“ä½œä»…å…è®¸ä½œè€…æœ¬äººæˆ–å…·å¤‡æƒé™çš„ç”¨æˆ·ï¼›é”™è¯¯ç»Ÿä¸€æç¤ºï¼Œé¿å…ä¿¡æ¯æ³„éœ²ã€‚
-->
<template>
  <!-- æ¥å…¥ç»Ÿä¸€å¸ƒå±€ï¼šä½¿ç”¨ TwoPaneLayout æä¾›â€œå…¨å®½å¸é¡¶é¡¶æ  + å³ä¾§æ­£æ–‡æ»šåŠ¨â€
       æ”¹é€ è¦ç‚¹ï¼š
       1) å°†é¡µé¢åŸæœ¬çš„æœ¬åœ°é¡¶æ ç§»é™¤ï¼Œæ”¹ä¸ºå…¬å…±é¡¶æ  AppTopBarï¼›
       2) é¡¶æ æ”¾åœ¨ topFull æ’æ§½ä¸­ï¼Œä¿æŒå…¨å®½å¹¶å¸é¡¶ï¼›
       3) é¡µé¢ä¸»ä½“ï¼ˆä¸ªäººèµ„æ–™ã€è¿‡æ»¤æ ä¸åˆ—è¡¨ï¼‰æ”¾åœ¨ rightMain æ’æ§½ä¸­ï¼›
       4) å°†å›åˆ°é¡¶éƒ¨ç»„ä»¶æŒ‡å®š target ä¸ºå¸ƒå±€çš„æ»šåŠ¨å®¹å™¨ï¼ˆ.scrollable-contentï¼‰ï¼Œç¡®ä¿æ»šåŠ¨è”åŠ¨æ­£å¸¸ã€‚ -->
  <TwoPaneLayout class="my-notes-layout">
    <!-- å…¬å…±é¡¶æ ï¼šç»Ÿä¸€é£æ ¼ä¸äº¤äº’ï¼›fluid è®©ä¸­é—´åŒºåŸŸï¼ˆæœç´¢ï¼‰é“ºæ»¡å®½åº¦ -->
    <template #topFull>
      <AppTopBar fluid />
    </template>

    <!-- å³ä¾§æ­£æ–‡ï¼šä¿ç•™åŸé¡µé¢ä¸»ä½“ç»“æ„ï¼Œä»…ç§»é™¤äº†æœ¬åœ°é¡¶æ  -->
    <template #rightMain>
      <div class="container" :style="{ '--filtersH': filtersHeight + 'px' }">
        <!-- ä¸ªäººèµ„æ–™æ‘˜è¦ï¼ˆæ˜¾ç¤ºåœ¨è¿‡æ»¤æ ä¸Šæ–¹ï¼‰ -->
        <div class="profile-summary">
          <img v-if="me.avatarUrl" :src="avatarUrl" alt="avatar" class="avatar-lg" width="260" height="260" loading="lazy" />
          <img v-else src="https://api.iconify.design/mdi/account-circle.svg" alt="avatar" class="avatar-lg" width="260" height="260" />
          <div class="text">
            <div class="nickname">{{ me.nickname || me.username || 'æœªè®¾ç½®æ˜µç§°' }}</div>
            <div
              class="signature"
              :class="[ signatureExpanded ? 'signature-full' : 'signature-ellipsis-3' ]"
              :title="me.signature || 'æœªè®¾ç½®'"
              ref="signatureRef"
            >
              {{ me.signature || 'æœªè®¾ç½®' }}
            </div>
            <a v-if="signatureOverflow" class="sig-toggle" @click="toggleSignature">{{ signatureExpanded ? 'æ”¶èµ·' : 'å±•å¼€' }}</a>
          </div>
        </div>

        <!-- è¿‡æ»¤ä¸æ’åºæ ï¼ˆstickyï¼šåœ¨å³ä¾§æ»šåŠ¨å®¹å™¨å†…ç²˜é¡¶ï¼‰ -->
        <div class="filters" :class="{ 'is-stuck': isStuck }" ref="filtersRef">
          <el-form :inline="true" label-width="80px" class="filters-form">
            <!-- ç¬¬ä¸€è¡Œï¼šå·¦ä¾§åˆ†ç»„ï¼ˆæ—¶é—´èŒƒå›´/æ ‡ç­¾/å…¬å¼€æ€§ï¼‰ + å³ä¾§æœç´¢ -->
            <div class="top-row">
              <div class="top-left">
            <el-form-item label="æ—¶é—´èŒƒå›´">
              <el-date-picker
                v-model="filters.range"
                type="daterange"
                range-separator="è‡³"
                start-placeholder="å¼€å§‹æ—¥æœŸ"
                end-placeholder="ç»“æŸæ—¥æœŸ"
                size="small"
                style="width:180px"
              />
            </el-form-item>
            <el-form-item label="æ ‡ç­¾">
              <el-select v-model="filters.tags" multiple filterable allow-create default-first-option placeholder="é€‰æ‹©æˆ–è¾“å…¥æ ‡ç­¾" size="small" style="width:140px">
                <el-option v-for="t in allTags" :key="t" :label="'#' + t" :value="t" />
              </el-select>
            </el-form-item>
            <el-form-item label="å…¬å¼€æ€§">
              <el-select v-model="filters.visibility" size="small" style="width:60px">
                <el-option label="å…¨éƒ¨" value="all" />
                <el-option label="å…¬å¼€" value="public" />
                <el-option label="ç§æœ‰" value="private" />
              </el-select>
            </el-form-item>
              </div>
              <div class="top-right">
                <el-form-item label="æœç´¢">
                  <el-input
                    v-model="filters.query"
                    size="small"
                    clearable
                    placeholder="æœç´¢æˆ‘çš„æ‹¾è¨€..."
                    style="width:200px"
                    @keyup.enter="triggerSearchPulse"
                  >
                    <template #prefix>
                      <img src="https://api.iconify.design/mdi/magnify.svg" alt="search" width="16" height="16" />
                    </template>
                  </el-input>
                </el-form-item>
                <!-- é€‰æ‹©æŒ‰é’®ç§»å‡ºè‡³å³ä¾§â€œæ¸…ç©ºâ€å‰é¢ï¼Œæ­¤å¤„ä¸å†æ¸²æŸ“ -->
              </div>
            </div>
            <div class="flex-break" aria-hidden="true"></div>
            <!-- ç¬¬äºŒè¡Œï¼šæ’åºåœ¨å·¦ä¾§ï¼›æ¸…ç©ºåœ¨å³ä¾§ -->
            <el-form-item label="æ’åº">
              <span class="sort-inline" style="width:260px">
                <el-radio-group v-model="filters.sortBy" size="small">
                  <el-radio-button label="time">æ—¶é—´</el-radio-button>
                  <el-radio-button label="likes">ç‚¹èµæ•°</el-radio-button>
                </el-radio-group>
                <el-tooltip content="åˆ‡æ¢å‡/é™åº" placement="top">
                  <el-button size="small" class="order-toggle" @click="toggleOrder">
                    <img v-if="filters.sortOrder==='desc'" src="https://api.iconify.design/mdi/sort-descending.svg" alt="desc" width="18" height="18" />
                    <img v-else src="https://api.iconify.design/mdi/sort-ascending.svg" alt="asc" width="18" height="18" />
                  </el-button>
                </el-tooltip>
              </span>
            </el-form-item>
            <el-form-item class="pull-right">
              <!-- å°†â€œé€‰æ‹©â€æ§ä»¶æ”¾åœ¨â€œæ¸…ç©ºâ€æ§ä»¶å‰é¢ï¼šä¾¿äºæ‰¹é‡æ“ä½œå…¥å£æ›´é è¿‘å³ä¾§å·¥å…· -->
              <!-- æ ·å¼ä¼˜åŒ–ï¼šä½¿ç”¨é»˜è®¤æŒ‰é’®é£æ ¼ä»¥ä¸â€œæ¸…ç©ºâ€ä¸€è‡´ï¼Œæå‡åè°ƒæ€§ -->
              <el-button size="small" @click="toggleSelectionMode" style="margin-right:8px;" class="select-btn">
                {{ selectionMode ? 'é€€å‡ºé€‰æ‹©' : 'é€‰æ‹©' }}
              </el-button>
              <span v-if="selectedIds.length" class="selected-count" title="å·²é€‰æ•°é‡" style="margin-right:8px;">å·²é€‰ {{ selectedIds.length }} æ¡</span>
              <!-- ç»Ÿä¸€æŒ‰é’®å¤§å°ï¼šä¸â€œé€‰æ‹©â€ä¿æŒç›¸åŒçš„å°å°ºå¯¸ï¼Œè§†è§‰æ›´åè°ƒ -->
              <el-button size="small" @click="resetFilters">æ¸…ç©º</el-button>
            </el-form-item>
          </el-form>
          <!-- æ‰¹é‡æ“ä½œå·¥å…·æ ï¼šä»…åœ¨é€‰æ‹©æ¨¡å¼æˆ–æœ‰å·²é€‰é¡¹æ—¶æ˜¾ç¤ºï¼›æ”¯æŒå…¨é€‰æœ¬é¡µ/å–æ¶ˆå…¨é€‰/æ‰¹é‡è®¾ä¸ºå…¬å¼€/ç§æœ‰/åˆ é™¤ -->
          <div v-if="selectionMode || selectedIds.length" class="bulk-toolbar">
            <div class="bulk-left">
              <el-button size="small" @click="selectAllOnPage">å…¨é€‰æœ¬é¡µ</el-button>
              <el-button size="small" @click="clearSelection">å–æ¶ˆå…¨é€‰</el-button>
            </div>
            <div class="spacer"></div>
            <div class="bulk-right">
              <el-button size="small" type="primary" :disabled="!selectedIds.length || bulkLoading" @click="bulkSetVisibility(true)">æ‰¹é‡è®¾ä¸ºå…¬å¼€</el-button>
              <el-button size="small" type="info" :disabled="!selectedIds.length || bulkLoading" @click="bulkSetVisibility(false)">æ‰¹é‡è®¾ä¸ºç§æœ‰</el-button>
              <el-button size="small" type="danger" :disabled="!selectedIds.length || bulkLoading" @click="bulkDeleteSelected">æ‰¹é‡åˆ é™¤</el-button>
            </div>
          </div>
        </div>

        <!-- å¹´ä»½åˆ†ç»„æ—¶é—´çº¿ -->
        <div class="year-groups">
          <div v-for="g in yearGroups" :key="g.year" class="year-group">
            <div class="year-header">
              <span class="year-title">{{ g.year }}</span>
            </div>
            <el-timeline>
              <transition-group name="list" tag="div">
              <el-timeline-item
                v-for="n in g.items"
                :key="n.id"
                :timestamp="formatMD(n.createdAt || n.created_at)"
                placement="top">
            <div class="author-above">ä½œè€…ï¼š{{ authorName }}</div>
            <div
              :class="['note-card', { editing: n.editing }]"
              :style="noteCardStyle(n)"
              :data-note-id="n.id"
              @mousedown="startPress(n, $event)"
              @mouseup="cancelPress"
              @mouseleave="cancelPress"
              @touchstart="startPress(n, $event)"
              @touchend="cancelPress"
            >
              <!-- åŠ¨ä½œèœå•ï¼šé•¿æŒ‰å‡ºç°ï¼ˆå›¾æ ‡ç‰ˆï¼‰ -->
              <transition name="overlay">
                <div
                  v-if="n.showActions"
                  class="actions-overlay"
                  @click="closeActions(n)"
                  @mousedown.stop
                  @mouseup.stop
                  @touchstart.stop
                  @touchend.stop
                >
                <div class="action-icon" :title="n.liked ? 'å–æ¶ˆå–œæ¬¢' : 'å–œæ¬¢'" @click.stop="toggleLike(n)">
                  <img :src="n.liked ? 'https://api.iconify.design/mdi/heart.svg?color=%23e25555' : 'https://api.iconify.design/mdi/heart-outline.svg'" alt="like" width="20" height="20" />
                </div>
            <div class="action-icon" :title="n.favorited ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—'" @click.stop="toggleFavorite(n)">
              <img :src="n.favorited ? 'https://api.iconify.design/mdi/bookmark.svg?color=%23409eff' : 'https://api.iconify.design/mdi/bookmark-outline.svg'" alt="favorite" width="20" height="20" />
            </div>
            <div class="action-icon" title="ç¼–è¾‘" @click.stop="editNote(n)">
              <img src="https://api.iconify.design/mdi/pencil.svg" alt="edit" width="20" height="20" />
            </div>
            <div class="action-icon danger" title="åˆ é™¤" @click.stop="deleteNote(n)">
              <img src="https://api.iconify.design/mdi/delete.svg" alt="delete" width="20" height="20" />
            </div>
            </div>
          </transition>

          <!-- éç¼–è¾‘æ€å†…å®¹å±•ç¤º -->
          <template v-if="!n.editing">
          <div class="note-tags top-right" v-if="parsedTags(n.tags).length">
            <el-tag v-for="t in parsedTags(n.tags)" :key="t" size="small" style="margin-left:6px;">#{{ t }}</el-tag>
          </div>
          <!-- é€‰æ‹©æ¡†ï¼šæ”¾åœ¨â€œæ ‡ç­¾â€ä¸‹æ–¹ï¼›ä¿æŒé å³å¯¹é½ã€‚é˜»æ­¢äº‹ä»¶å†’æ³¡é¿å…è§¦å‘é•¿æŒ‰åŠ¨ä½œå±‚æˆ–ç¼–è¾‘æ€åˆ‡æ¢ã€‚ -->
          <div v-if="selectionMode" class="select-box below-tags" @click.stop @mousedown.stop @mouseup.stop @touchstart.stop @touchend.stop>
            <el-checkbox :checked="isSelected(n)" @change="onSelectChange(n, $event)" />
          </div>
          <div class="note-content">{{ n.content }}</div>
          <div class="meta bottom-left">
            <el-tag size="small" :type="n.isPublic ? 'success' : 'info'">{{ n.isPublic ? 'å…¬å¼€' : 'ç§æœ‰' }}</el-tag>
          </div>
          <div class="meta bottom-right">
            <span class="time">æ›´æ–°ï¼š{{ formatTime(n.updatedAt || n.updated_at) }}</span>
          </div>
          </template>

          <!-- ç¼–è¾‘æ€ï¼šå†…å®¹ä¸å…¬å¼€/ç§æœ‰é€‰æ‹© -->
          <template v-else>
            <!-- ç¼–è¾‘æ€ï¼šå³ä¸Šå§‹ç»ˆå±•ç¤ºæºæ ‡ç­¾ï¼ˆæœ‰åˆ™æ˜¾ç¤ºï¼‰ -->
            <div class="note-tags top-right" v-if="parsedTags(n.tags).length">
              <el-tag v-for="t in parsedTags(n.tags)" :key="t" size="small" style="margin-left:6px;">#{{ t }}</el-tag>
            </div>
            <!-- é€‰æ‹©æ¡†ï¼šç¼–è¾‘æ€åŒæ ·ç½®äºâ€œæ ‡ç­¾â€ä¸‹æ–¹ï¼Œä¾¿äºç»Ÿä¸€äº¤äº’ -->
            <div v-if="selectionMode" class="select-box below-tags" @click.stop @mousedown.stop @mouseup.stop @touchstart.stop @touchend.stop>
              <el-checkbox :checked="isSelected(n)" @change="onSelectChange(n, $event)" />
            </div>
            <div class="edit-form">
              <div class="edit-toolbar">
                <span class="label">å†…å®¹</span>
              </div>
              <div class="textarea-highlight-wrapper" :data-note-id="n.id" ref="setWrapperRef(n)">
                <div class="highlight-layer" v-html="highlightHTML(n.contentEdit)"></div>
                <el-input
                  v-model="n.contentEdit"
                  type="textarea"
                  :rows="4"
                  placeholder="å†…å®¹ä¸æ ‡ç­¾ä¸€èµ·è¾“å…¥ï¼›æ ‡ç­¾ä»¥#å¼€å¤´ï¼Œé€—å·åˆ†éš”ã€‚ä¾‹å¦‚ï¼šä»Šå¤©å®Œæˆäº†ä»»åŠ¡ #å·¥ä½œ,#è®¡åˆ’"
                  @focus="onEditFocus(n)"
                  @blur="onEditBlur(n)"
                />
              </div>
            </div>
            <div class="edit-footer">
              <div class="left">
                <el-switch
                  v-model="n.isPublicEdit"
                  active-text="å…¬å¼€"
                  inactive-text="ç§æœ‰"
                  inline-prompt
                  size="small"
                />
              </div>
              <div class="right edit-actions">
                <el-button size="small" @click="cancelEdit(n)">å–æ¶ˆ</el-button>
                <el-button size="small" type="primary" @click="saveEdit(n)">ä¿å­˜</el-button>
              </div>
            </div>
          </template>
        </div>
      
      </el-timeline-item>
      </transition-group>
            </el-timeline>
          </div>
        </div>
      </div>
      <!-- åŠ è½½æ›´å¤šåŒºåŸŸï¼šæŒ‰é’® + è§¦åº•å“¨å…µã€‚æ¡Œé¢ç«¯å¯ç‚¹å‡»ï¼Œç§»åŠ¨ç«¯æ»šåŠ¨åˆ°åº•è‡ªåŠ¨è§¦å‘ -->
      <div class="load-more-container">
        <button class="load-more-btn" :disabled="isLoading || !hasNext" @click="loadMore">
          {{ isLoading ? 'åŠ è½½ä¸­â€¦' : (hasNext ? 'åŠ è½½æ›´å¤š' : 'å·²æ— æ›´å¤š') }}
        </button>
        <!-- è§¦åº•å“¨å…µï¼šè¿›å…¥è§†å£æ—¶è‡ªåŠ¨åŠ è½½ä¸‹ä¸€é¡µï¼›åœ¨æ²¡æœ‰æ›´å¤šæˆ–æ­£åœ¨åŠ è½½æ—¶éšè— -->
        <div v-show="hasNext && !isLoading" ref="loadMoreSentinel" class="load-more-sentinel" aria-hidden="true"></div>
      </div>
    </template>
  </TwoPaneLayout>
  <!-- å³ä¸‹ï¼šç»Ÿä¸€â€œå›åˆ°é¡¶éƒ¨â€æŒ‰é’®ï¼ˆç»ç’ƒæ‹Ÿæ€é£æ ¼ï¼Œå¹³æ»‘æ»šåŠ¨ï¼‰
       è¯´æ˜ï¼š
       - æ›¿æ¢åŸ Element Plus çš„ el-backtopï¼Œæ”¹ç”¨ç«™å†…ç»Ÿä¸€ BackToTop ç»„ä»¶ï¼›
       - é€šè¿‡ target ç»‘å®š TwoPaneLayout çš„å³ä¾§æ»šåŠ¨å®¹å™¨ï¼Œç¡®ä¿åœ¨â€œå³ä¾§æ­£æ–‡æ»šåŠ¨â€æ¨¡å¼ä¸‹æ­£å¸¸æ˜¾ç¤ºä¸æ»šåŠ¨ï¼›
       - threshold æ§åˆ¶å‡ºç°é˜ˆå€¼ï¼ˆåƒç´ ï¼‰ï¼Œright/bottom æ§åˆ¶æŒ‰é’®ä½ç½®ã€‚ -->
  <BackToTop :target="scrollRootEl" :right="80" :bottom="100" :threshold="360" />
</template>

<script setup>
// å¼•å…¥ç»Ÿä¸€å¸ƒå±€ä¸å…¬å…±é¡¶æ ç»„ä»¶ï¼š
// - TwoPaneLayoutï¼šæä¾›â€œå…¨å®½å¸é¡¶é¡¶æ  + å³ä¾§æ­£æ–‡æ»šåŠ¨â€çš„é€šç”¨å¸ƒå±€ç»“æ„ï¼›
// - AppTopBarï¼šå…¬å…±é¡¶æ ï¼Œç»Ÿä¸€å“ç‰Œä¸å¿«æ·å…¥å£ï¼Œæ”¯æŒé€æ˜/æ¯›ç»ç’ƒåˆ‡æ¢ä¸æœç´¢ã€‚
import TwoPaneLayout from '@/components/TwoPaneLayout.vue';
import AppTopBar from '@/components/AppTopBar.vue';
// ç»Ÿä¸€çš„â€œå›åˆ°é¡¶éƒ¨â€ç»„ä»¶ï¼šç»ç’ƒæ‹Ÿæ€é£æ ¼ + å¹³æ»‘æ»šåŠ¨
import BackToTop from '@/components/BackToTop.vue';
import { ref, reactive, onMounted, onUnmounted, computed, watch, nextTick } from 'vue';
import { useRouter } from 'vue-router';
import { http, avatarFullUrl } from '@/api/http';
import { ElMessage, ElMessageBox } from 'element-plus';

const notes = ref([]);
const me = reactive({ username:'', nickname:'', avatarUrl:'', signature:'' });
const avatarUrl = computed(() => avatarFullUrl(me.avatarUrl));
const authorName = computed(() => me.nickname || me.username || 'æˆ‘');
const router = useRouter();

// â€”â€” æœåŠ¡ç«¯åˆ†é¡µçŠ¶æ€ï¼ˆæˆ‘çš„ä¾¿ç­¾é¡µï¼‰â€”â€”
// å½“å‰é¡µç ï¼ˆä» 1 å¼€å§‹ï¼‰
const page = ref(1);
// æ¯é¡µæ¡æ•°ï¼ˆå»ºè®® 20ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½è¿‡å¤šï¼‰
const size = ref(20);
// æ€»æ¡æ•°ï¼ˆç”±åç«¯è¿”å›ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€é¡µï¼‰
const total = ref(0);
// æ˜¯å¦æ­£åœ¨åŠ è½½ï¼ˆé˜²æ­¢å¹¶å‘ï¼‰
const isLoading = ref(false);
// æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€é¡µï¼šå½“å·²åŠ è½½æ•°é‡å°äºæ€»æ•°æ—¶ç»§ç»­åŠ è½½
const hasNext = computed(() => notes.value.length < total.value);
// è§¦åº•åŠ è½½å“¨å…µ
const loadMoreSentinel = ref(null);
let sentinelObserver = null;
// å³ä¾§æ»šåŠ¨å®¹å™¨å¼•ç”¨ï¼šä¾› BackToTop ç»„ä»¶ç»‘å®šæ»šåŠ¨ç›®æ ‡
const scrollRootEl = ref(null);
// ç­¾åå±•å¼€/æ”¶èµ·
const signatureExpanded = ref(false);
const signatureOverflow = ref(false);
const signatureRef = ref(null);
function toggleSignature(){ signatureExpanded.value = !signatureExpanded.value; }
function checkSignatureOverflow(){
  const el = signatureRef.value;
  if (!el) { signatureOverflow.value = false; return; }
  nextTick(() => {
    const wasExpanded = signatureExpanded.value;
    // å¼ºåˆ¶åˆ‡åˆ°æŠ˜å çŠ¶æ€æµ‹é‡å¯è§é«˜åº¦
    el.classList.add('signature-ellipsis-3');
    el.classList.remove('signature-full');
    const collapsedH = el.getBoundingClientRect().height;
    // å¼ºåˆ¶åˆ‡åˆ°å±•å¼€çŠ¶æ€æµ‹é‡å®Œæ•´é«˜åº¦
    el.classList.add('signature-full');
    el.classList.remove('signature-ellipsis-3');
    const expandedH = el.getBoundingClientRect().height;
    // è¿˜åŸåŸå§‹çŠ¶æ€
    if (!wasExpanded){
      el.classList.add('signature-ellipsis-3');
      el.classList.remove('signature-full');
    }
    signatureOverflow.value = expandedH > collapsedH + 1;
  });
}
watch(() => me.signature, () => { signatureExpanded.value = false; checkSignatureOverflow(); });
onMounted(() => { checkSignatureOverflow(); window.addEventListener('resize', checkSignatureOverflow); });
onUnmounted(() => { window.removeEventListener('resize', checkSignatureOverflow); });
watch(signatureExpanded, () => { nextTick(checkSignatureOverflow); });

// è¿‡æ»¤ä¸æ’åºçŠ¶æ€
const filters = reactive({
  visibility: 'all', // all | public | private
  range: null,       // [startDate, endDate]
  tags: [],          // array of tag strings
  query: '',         // content search query
  sortBy: 'time',    // time | likes
  sortOrder: 'desc', // desc | asc
});
function resetFilters(){
  filters.visibility = 'all';
  filters.range = null;
  filters.tags = [];
  filters.query = '';
  filters.sortBy = 'time';
  filters.sortOrder = 'desc';
}

// ==================== å¤šé€‰ä¸æ‰¹é‡æ“ä½œï¼ˆåˆ é™¤ / å…¬å¼€ / ç§æœ‰ï¼‰ ====================
// è®¾è®¡è¯´æ˜ï¼š
// - é€šè¿‡ selectionMode å¼€å…³è¿›å…¥é€‰æ‹©æ¨¡å¼ï¼Œåœ¨æ¯æ¡ä¾¿ç­¾å·¦ä¸Šè§’æ˜¾ç¤ºå¤é€‰æ¡†ï¼›
// - ä½¿ç”¨ selectedIds æ•°ç»„ä¿å­˜å·²é€‰ä¾¿ç­¾ IDï¼›
// - æä¾›â€œå…¨é€‰æœ¬é¡µ/å–æ¶ˆå…¨é€‰/æ‰¹é‡è®¾ä¸ºå…¬å¼€/ç§æœ‰/æ‰¹é‡åˆ é™¤â€ç­‰æ“ä½œï¼›
// - æ‰¹é‡æ“ä½œåŸºäºç°æœ‰å•æ¡æ¥å£ï¼ˆPUT /shiyan/{id}ã€DELETE /shiyan/{id}ï¼‰ï¼Œé€šè¿‡ Promise.allSettled å¹¶å‘æ‰§è¡Œï¼›
// - å®Œæˆåç»™å‡ºæˆåŠŸ/å¤±è´¥ç»Ÿè®¡å¹¶æ›´æ–°æœ¬åœ°åˆ—è¡¨çŠ¶æ€ã€‚

// æ˜¯å¦å¤„äºé€‰æ‹©æ¨¡å¼ï¼ˆæ˜¾ç¤ºé€‰æ‹©æ¡†ä¸æ‰¹é‡å·¥å…·æ ï¼‰
const selectionMode = ref(false);
// å·²é€‰ä¾¿ç­¾ ID åˆ—è¡¨ï¼ˆæ•°ç»„ï¼‰
const selectedIds = ref([]);
// æ‰¹é‡æ“ä½œåŠ è½½çŠ¶æ€ï¼ˆé˜²æ­¢é‡å¤ç‚¹å‡»è§¦å‘å¹¶å‘ï¼‰
const bulkLoading = ref(false);

/** åˆ‡æ¢é€‰æ‹©æ¨¡å¼ï¼šè¿›å…¥æˆ–é€€å‡ºã€‚é€€å‡ºæ—¶æ¸…ç©ºå·²é€‰é¡¹ã€‚ */
function toggleSelectionMode(){
  selectionMode.value = !selectionMode.value;
  if (!selectionMode.value) selectedIds.value = [];
}

/** å½“å‰ä¾¿ç­¾æ˜¯å¦é€‰ä¸­ï¼ˆç”¨äºå¤é€‰æ¡†å‹¾é€‰çŠ¶æ€ï¼‰ */
function isSelected(n){
  return selectedIds.value.includes(n.id);
}

/** å‹¾é€‰çŠ¶æ€æ”¹å˜ï¼ˆå¤é€‰æ¡† changeï¼‰ï¼šæ·»åŠ æˆ–ç§»é™¤é€‰ä¸­é¡¹ã€‚ */
function onSelectChange(n, checked){
  const id = n.id;
  if (checked){
    if (!selectedIds.value.includes(id)) selectedIds.value = selectedIds.value.concat(id);
  }else{
    selectedIds.value = selectedIds.value.filter(x => x !== id);
  }
}

/** å…¨é€‰å½“å‰é¡µï¼ˆå½“å‰å·²åŠ è½½çš„ notes åˆ—è¡¨ï¼‰ï¼›é‡å¤ ID è‡ªåŠ¨å»é‡ã€‚ */
function selectAllOnPage(){
  const ids = notes.value.map(n => n.id);
  const set = new Set([...selectedIds.value, ...ids]);
  selectedIds.value = Array.from(set);
}

/** å–æ¶ˆå…¨é€‰ï¼ˆæ¸…ç©ºé€‰ä¸­ï¼‰å¹¶ä¿ç•™é€‰æ‹©æ¨¡å¼çŠ¶æ€ã€‚ */
function clearSelection(){ selectedIds.value = []; }

/**
 * æ‰¹é‡åˆ é™¤å·²é€‰æ‹¾è¨€ï¼šäºŒæ¬¡ç¡®è®¤ + å¹¶å‘åˆ é™¤ + æœ¬åœ°ç§»é™¤ + ç»Ÿè®¡æç¤º
 */
async function bulkDeleteSelected(){
  if (!selectedIds.value.length || bulkLoading.value) return;
  try{
    // æ–‡æ¡ˆé‡å‘½åï¼šæç¤ºä¸­â€œä¾¿ç­¾â€ç»Ÿä¸€æ”¹ä¸ºâ€œæ‹¾è¨€â€
    await ElMessageBox.confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedIds.value.length} æ¡æ‹¾è¨€å—ï¼Ÿä¸å¯æ¢å¤ã€‚`, 'æ‰¹é‡åˆ é™¤ç¡®è®¤', {
      confirmButtonText: 'åˆ é™¤', cancelButtonText: 'å–æ¶ˆ', type: 'warning'
    });
  }catch{ return; }
  bulkLoading.value = true;
  try{
    const ids = [...selectedIds.value];
    // è·¯å¾„åˆ‡æ¢ï¼šæ‰¹é‡åˆ é™¤ç»Ÿä¸€ä½¿ç”¨ /shiyan/{id}
    const tasks = ids.map(id => http.delete(`/shiyan/${id}`));
    const results = await Promise.allSettled(tasks);
    const successIds = [];
    const failed = [];
    results.forEach((r, i) => {
      const id = ids[i];
      if (r.status === 'fulfilled') successIds.push(id); else failed.push(id);
    });
    if (successIds.length) notes.value = notes.value.filter(n => !successIds.includes(n.id));
    selectedIds.value = selectedIds.value.filter(id => !successIds.includes(id));
    ElMessage.success(`åˆ é™¤æˆåŠŸ ${successIds.length} æ¡ï¼Œå¤±è´¥ ${failed.length} æ¡`);
  }catch(e){
    ElMessage.error('æ‰¹é‡åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
  }finally{
    bulkLoading.value = false;
  }
}

/**
 * æ‰¹é‡è®¾ç½®å…¬å¼€/ç§æœ‰ï¼šå¹¶å‘æ›´æ–° isPublic ä¿ç•™å…¶å®ƒå­—æ®µï¼Œå®Œæˆåæ›´æ–°æœ¬åœ°çŠ¶æ€å¹¶æç¤ºç»Ÿè®¡
 */
async function bulkSetVisibility(isPublic){
  if (!selectedIds.value.length || bulkLoading.value) return;
  bulkLoading.value = true;
  try{
    const idToNote = new Map(notes.value.map(n => [n.id, n]));
    const ids = [...selectedIds.value];
    const tasks = ids.map(id => {
      const n = idToNote.get(id);
      const payload = {
        content: n?.content ?? '',
        tags: (Array.isArray(n?.tags) ? n.tags.join(',') : (n?.tags ?? '')),
        archived: n?.archived ?? false,
        isPublic: isPublic,
        color: (typeof n?.color === 'string' ? n.color.trim() : '')
      };
      // è·¯å¾„åˆ‡æ¢ï¼šæ‰¹é‡æ›´æ–°ç»Ÿä¸€ä½¿ç”¨ /shiyan/{id}
      return http.put(`/shiyan/${id}`, payload);
    });
    const results = await Promise.allSettled(tasks);
    let success = 0, failed = 0;
    results.forEach((r, i) => {
      const id = ids[i];
      const n = idToNote.get(id);
      if (r.status === 'fulfilled'){
        success++;
        const data = r.value?.data;
        const newVal = (data?.isPublic ?? data?.is_public);
        n.isPublic = (typeof newVal === 'boolean') ? newVal : isPublic;
      }else{
        failed++;
      }
    });
    ElMessage.success(`æ‰¹é‡æ›´æ–°å®Œæˆï¼šæˆåŠŸ ${success} æ¡ï¼Œå¤±è´¥ ${failed} æ¡`);
  }catch(e){
    ElMessage.error('æ‰¹é‡æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
  }finally{
    bulkLoading.value = false;
  }
}

// æœç´¢æ¡† Enter åŠ¨ç”»åé¦ˆçŠ¶æ€ä¸è§¦å‘æ–¹æ³•
const searchPulse = ref(false);
function triggerSearchPulse(){
  // é€šè¿‡åˆ‡æ¢ç±»åæ¥è§¦å‘ä¸€æ¬¡æ€§åŠ¨ç”»
  searchPulse.value = false;
  requestAnimationFrame(() => {
    searchPulse.value = true;
    setTimeout(() => { searchPulse.value = false; }, 400);
  });
}

function parsedTags(tags){
  if (Array.isArray(tags)) return tags;
  if (typeof tags === 'string') return tags.split(',').map(t => t.trim().replace(/^#/, '')).filter(Boolean);
  return [];
}

function formatTime(t){
  if (!t) return '';
  // å…¼å®¹åç«¯è¿”å›çš„ LocalDateTime å­—ç¬¦ä¸²
  try { return new Date(t).toLocaleString(); } catch { return String(t); }
}

// æœˆ-æ—¥ æ—¶:åˆ† æ ¼å¼ï¼ˆä¸­æ–‡æ ·å¼ï¼‰
function pad(n){ return String(n).padStart(2, '0'); }
function formatMD(t){
  if (!t) return '';
  try{
    const d = new Date(t);
    if (isNaN(d.getTime())) return '';
    const M = pad(d.getMonth()+1);
    const D = pad(d.getDate());
    const h = pad(d.getHours());
    const m = pad(d.getMinutes());
    return `${M}æœˆ${D}æ—¥ ${h}:${m}`;
  }catch{ return ''; }
}

function goMessages(){ router.push('/messages'); }
function goLikes(){ router.push('/likes'); }
function goFavorites(){ router.push('/favorites'); }
function goHistory(){ router.push('/history'); }

async function loadMe(){
  try{
  // è¯´æ˜ï¼šæˆ‘çš„ä¾¿ç­¾é¡µåœ¨åˆå§‹åŒ–æ—¶è·å–ç”¨æˆ·ä¿¡æ¯ã€‚
  // è‹¥åœ¨æœªç™»å½•æˆ–åç«¯çŸ­æš‚æ ¡éªŒå¤±è´¥è¿”å› 401ï¼Œè¿™é‡Œé‡‡ç”¨é™é»˜å¤„ç†ï¼Œé¿å…è§¦å‘å…¨å±€ 401 é‡å®šå‘å’Œå¹²æ‰°å¯¼èˆªã€‚
  const { data } = await http.get('/account/me', { suppress401Redirect: true });
    Object.assign(me, data);
  }catch(e){ /* å¿½ç•¥é”™è¯¯ */ }
}

// å°†åç«¯è¿”å›çš„ä¾¿ç­¾é¡¹æ˜ å°„ä¸ºé¡µé¢å†…éƒ¨ç»“æ„ï¼Œå¹¶ç´¯åŠ åˆ°åˆ—è¡¨
function appendMappedItems(items){
  if (!Array.isArray(items) || items.length === 0) return;
  const mapped = items.map(it => ({
    ...it,
    isPublic: it.isPublic ?? it.is_public ?? false,
    likeCount: Number(it.likeCount ?? it.like_count ?? 0),
    liked: Boolean(it.liked ?? it.likedByMe ?? it.liked_by_me ?? false),
    favoriteCount: Number(it.favoriteCount ?? it.favorite_count ?? 0),
    favorited: Boolean(it.favoritedByMe ?? it.favorited_by_me ?? it.favorited ?? false),
    showActions: false,
    editing: false,
    contentEdit: it.content,
    isPublicEdit: it.isPublic ?? it.is_public ?? false,
  }));
  notes.value = notes.value.concat(mapped);
}

// æ‹‰å–æŒ‡å®šé¡µçš„æ•°æ®ï¼Œå¹¶ç´¯åŠ åˆ°åˆ—è¡¨
async function fetchPage(targetPage){
  if (isLoading.value) return;
  isLoading.value = true;
  try{
    // æ¥å£è·¯å¾„é‡å‘½åï¼šç»Ÿä¸€æ”¹ä¸º /shiyanï¼›åç«¯ä¿ç•™ /notes å…¼å®¹
    const { data } = await http.get('/shiyan', {
      params: { size: size.value, page: targetPage, mineOnly: true },
      suppress401Redirect: true,
    });
    const items = Array.isArray(data) ? data : (data?.items ?? data?.records ?? []);
    const t = data?.total ?? data?.count ?? 0;
    total.value = Number.isFinite(t) ? Number(t) : (notes.value.length + (items?.length || 0));
    appendMappedItems(items || []);
    page.value = targetPage;
  }catch(e){
    // æ–‡æ¡ˆé‡å‘½åï¼šå°†â€œä¾¿ç­¾â€ç»Ÿä¸€æ”¹ä¸ºâ€œæ‹¾è¨€â€
    ElMessage.error('åŠ è½½æˆ‘çš„æ‹¾è¨€å¤±è´¥');
  }finally{
    isLoading.value = false;
  }
}

// é‡æ–°åŠ è½½ï¼ˆé‡ç½®åˆ—è¡¨å¹¶æ‹‰å–ç¬¬ 1 é¡µï¼‰
async function reload(){
  total.value = 0;
  page.value = 1;
  notes.value = [];
  await fetchPage(1);
}

// åŠ è½½ä¸‹ä¸€é¡µ
async function loadMore(){
  if (!hasNext.value || isLoading.value) return;
  await fetchPage(page.value + 1);
}

// åˆå§‹åŒ–è§¦åº•åŠ è½½ï¼šå½“å“¨å…µè¿›å…¥è§†å£æ—¶è‡ªåŠ¨è§¦å‘ä¸‹ä¸€é¡µåŠ è½½
async function setupInfiniteScroll(){
  await nextTick();
  if (!loadMoreSentinel.value) return;
  if (sentinelObserver){ try{ sentinelObserver.disconnect(); }catch{} }
  // ä¿®å¤è¯´æ˜ï¼šTwoPaneLayout çš„å³ä¾§ä¸»åŒºåŸŸæ˜¯ç‹¬ç«‹æ»šåŠ¨å®¹å™¨ï¼ˆoverflow:autoï¼‰ã€‚
  // è‹¥ IO çš„ root ç»‘å®šä¸ºæµè§ˆå™¨è§†å£ï¼ˆroot=nullï¼‰ï¼Œåˆ™å½“é¡µé¢æœ¬èº«ä¸æ»šåŠ¨æ—¶ï¼Œå“¨å…µä¸ä¼šè¿›å…¥è§†å£ï¼Œå¯¼è‡´æ— æ³•è§¦å‘ä¸‹ä¸€é¡µåŠ è½½ã€‚
  // è¿™é‡ŒåŠ¨æ€æŸ¥æ‰¾æœ€è¿‘çš„å¯æ»šåŠ¨çˆ¶å®¹å™¨å¹¶ä½œä¸º IO çš„ rootï¼Œé…åˆè¾ƒå¤§çš„ rootMargin æå‰è§¦å‘åŠ è½½ï¼Œæå‡ä½“éªŒã€‚
  function getScrollParent(el){
    let node = el?.parentElement;
    while (node){
      const style = window.getComputedStyle(node);
      const overflowY = style.overflowY;
      if (overflowY === 'auto' || overflowY === 'scroll') return node;
      node = node.parentElement;
    }
    return null;
  }
  const root = getScrollParent(loadMoreSentinel.value);
  sentinelObserver = new IntersectionObserver((entries) => {
    const entry = entries[0];
    if (entry?.isIntersecting){ loadMore(); }
  }, { root, rootMargin: '200px', threshold: 0 });
  sentinelObserver.observe(loadMoreSentinel.value);
}

// è·å– TwoPaneLayout çš„å³ä¾§æ»šåŠ¨å®¹å™¨ï¼ˆæ²¿çˆ¶é“¾æŸ¥æ‰¾æœ€è¿‘çš„ overflow:auto/scrollï¼‰
// è¯´æ˜ï¼šæ¨¡æ¿ä¸­çš„ loadMoreSentinel ä½äºåˆ—è¡¨åº•éƒ¨ï¼Œèƒ½å¤Ÿç”¨äºå®šä½å…¶æœ€è¿‘çš„æ»šåŠ¨çˆ¶å…ƒç´ ã€‚
function findScrollParent(el){
  let node = el?.parentElement;
  while (node){
    const style = window.getComputedStyle(node);
    const overflowY = style.overflowY;
    if (overflowY === 'auto' || overflowY === 'scroll') return node;
    node = node.parentElement;
  }
  return null;
}

function parseHexColor(hex){
  if (!hex || typeof hex !== 'string') return null;
  const m = hex.trim().match(/^#?([0-9a-fA-F]{6})$/);
  if (!m) return null;
  const v = m[1];
  const r = parseInt(v.slice(0,2), 16);
  const g = parseInt(v.slice(2,4), 16);
  const b = parseInt(v.slice(4,6), 16);
  return { r, g, b };
}
function luminance({r,g,b}){
  return 0.2126*(r/255) + 0.7152*(g/255) + 0.0722*(b/255);
}
function noteCardStyle(n){
  const rgb = parseHexColor(n.color);
  if (!rgb) return {};
  const fg = luminance(rgb) > 0.6 ? '#303133' : '#ffffff';
  return {
    borderLeft: `6px solid rgba(${rgb.r},${rgb.g},${rgb.b},0.6)`,
    background: (typeof n.color === 'string' ? n.color.trim() : `rgba(${rgb.r},${rgb.g},${rgb.b},0.18)`),
    '--fgColor': fg
  };
}

onMounted(async () => {
  loadMe();
  await reload();
  await setupInfiniteScroll();
  // ç»‘å®šå›åˆ°é¡¶éƒ¨æ»šåŠ¨å®¹å™¨ï¼šåœ¨ä¸‹ä¸€æ¸²æŸ“å¸§è·å–å¹¶èµ‹å€¼ï¼Œç¡®ä¿å…ƒç´ å·²æŒ‚è½½
  await nextTick();
  scrollRootEl.value = findScrollParent(loadMoreSentinel.value);
});

// å¸é¡¶çŠ¶æ€æ£€æµ‹ï¼ˆç”¨äºè§†è§‰å¼ºè°ƒï¼‰
const filtersRef = ref(null);
const isStuck = ref(false);
const filtersHeight = ref(0);
function updateStickyState(){
  const el = filtersRef.value;
  if (!el) return;
  const top = el.getBoundingClientRect().top;
  isStuck.value = top <= 0;
  // åŒæ­¥è¿‡æ»¤æ å½“å‰é«˜åº¦ï¼Œç”¨äºå¹´ä»½å¸é¡¶åç§»
  filtersHeight.value = el.offsetHeight || 0;
}
onMounted(() => {
  window.addEventListener('scroll', updateStickyState, { passive: true });
  updateStickyState();
  // ç›‘å¬è¿‡æ»¤æ å°ºå¯¸å˜åŒ–ï¼ŒåŠ¨æ€æ›´æ–°é«˜åº¦å˜é‡
  const el = filtersRef.value;
  if (el && 'ResizeObserver' in window){
    const ro = new ResizeObserver(() => {
      filtersHeight.value = el.offsetHeight || 0;
    });
    ro.observe(el);
  }
});
onUnmounted(() => {
  window.removeEventListener('scroll', updateStickyState);
});

// ç»„ä»¶å¸è½½æ—¶æ¸…ç†è§¦åº•è§‚å¯Ÿå™¨ï¼Œé¿å…æ³„æ¼
onUnmounted(() => {
  if (sentinelObserver){ try{ sentinelObserver.disconnect(); }catch{} }
  sentinelObserver = null;
});

// æ‰€æœ‰æ ‡ç­¾é›†åˆï¼ˆå»é‡ï¼‰
const allTags = computed(() => {
  const set = new Set();
  for (const n of notes.value){
    for (const t of parsedTags(n.tags)) set.add(t);
  }
  return Array.from(set);
});

// è¿‡æ»¤ä¸æ’åºåçš„ç»“æœ
const filteredNotes = computed(() => {
  let arr = notes.value.slice();
  // è¿‡æ»¤ï¼šå…¬å¼€æ€§
  if (filters.visibility !== 'all'){
    const target = filters.visibility === 'public';
    arr = arr.filter(n => Boolean(n.isPublic) === target);
  }
  // è¿‡æ»¤ï¼šæ—¶é—´èŒƒå›´ï¼ˆæŒ‰æ›´æ–°æ—¶é—´ï¼Œæœ‰åˆ™ç”¨ï¼Œå¦åˆ™ç”¨åˆ›å»ºæ—¶é—´ï¼‰
  if (Array.isArray(filters.range) && filters.range.length === 2 && filters.range[0] && filters.range[1]){
    const start = new Date(filters.range[0]).getTime();
    const end = new Date(filters.range[1]).getTime();
    arr = arr.filter(n => {
      const t = new Date(n.createdAt || n.created_at || 0).getTime();
      return t >= start && t <= end;
    });
  }
  // è¿‡æ»¤ï¼šæ ‡ç­¾ï¼ˆåŒ…å«ä»»æ„ä¸€ä¸ªæ‰€é€‰æ ‡ç­¾ï¼‰
  if (Array.isArray(filters.tags) && filters.tags.length > 0){
    arr = arr.filter(n => {
      const tags = parsedTags(n.tags);
      return filters.tags.some(t => tags.includes(t));
    });
  }
  // è¿‡æ»¤ï¼šå†…å®¹å…³é”®è¯ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰
  if (filters.query && typeof filters.query === 'string' && filters.query.trim()){
    const q = filters.query.trim().toLowerCase();
    arr = arr.filter(n => String(n.content || '').toLowerCase().includes(q));
  }
  // æ’åº
  const by = filters.sortBy;
  const dir = filters.sortOrder === 'asc' ? 1 : -1;
  arr.sort((a,b) => {
    let av, bv;
    if (by === 'likes'){
      av = Number(a.likeCount || 0);
      bv = Number(b.likeCount || 0);
    }else{
      av = new Date(a.createdAt || a.created_at || 0).getTime();
      bv = new Date(b.createdAt || b.created_at || 0).getTime();
    }
    return (av - bv) * dir;
  });
  return arr;
});

// æŒ‰å¹´ä»½åˆ†ç»„ï¼ˆä¿æŒ filteredNotes çš„æ’åºé¡ºåºï¼‰
const yearGroups = computed(() => {
  const map = new Map();
  for (const n of filteredNotes.value){
    const t = new Date(n.createdAt || n.created_at || 0);
    const year = isNaN(t.getTime()) ? 'æœªçŸ¥' : t.getFullYear();
    if (!map.has(year)) map.set(year, []);
    map.get(year).push(n);
  }
  // ä¿æŒå‡ºç°é¡ºåº
  const groups = [];
  for (const [year, items] of map.entries()) groups.push({ year, items });
  return groups;
});

function toggleOrder(){
  filters.sortOrder = (filters.sortOrder === 'desc' ? 'asc' : 'desc');
}

// é•¿æŒ‰åŠ¨ä½œèœå•
const pressTimer = ref(null);
const activeNoteId = ref(null);
function onDocClick(e){
  if (!activeNoteId.value) return;
  const card = document.querySelector(`[data-note-id="${activeNoteId.value}"]`);
  if (!card || !card.contains(e.target)) {
    const note = notes.value.find(x => x.id === activeNoteId.value);
    if (note) note.showActions = false;
    activeNoteId.value = null;
    document.removeEventListener('click', onDocClick, true);
  }
}
function startPress(n){
  // è‹¥å·²æ˜¾ç¤ºåŠ¨ä½œèœå•ï¼Œé¿å…é‡å¤è§¦å‘å¹¶éšè—
  if (n.showActions) return;
  // ç¼–è¾‘æ€ä¸‹ä¸æ˜¾ç¤ºé•¿æŒ‰èœå•
  if (n.editing) return;
  cancelPress();
  pressTimer.value = setTimeout(() => {
    n.showActions = true;
    activeNoteId.value = n.id;
    document.addEventListener('click', onDocClick, true);
  }, 600);
}
function cancelPress(){
  if (pressTimer.value){
    clearTimeout(pressTimer.value);
    pressTimer.value = null;
  }
}

function editNote(n){
  n.showActions = false;
  n.editing = true;
  n.contentEdit = n.content;
  n.isPublicEdit = n.isPublic;
  // å°†ç¼ºå¤±çš„æ ‡ç­¾æ‹¼å…¥å†…å®¹æœ«å°¾ï¼Œä¾¿äºç›´æ¥åœ¨å†…å®¹ä¸­ç¼–è¾‘
  const existingArr = parsedTags(n.tags);
  const inContentArr = parseTagsFromText(n.contentEdit);
  const missing = existingArr.filter(t => !inContentArr.includes(t));
  if (missing.length){
    const suffix = missing.map(t => `#${t}`).join(',');
    n.contentEdit = (n.contentEdit || '').trim();
    // å°†ç¼ºå¤±çš„æ ‡ç­¾æ‹¼æ¥åˆ°å†…å®¹çš„ä¸‹ä¸€è¡Œï¼Œä¾¿äºè§†è§‰åŒºåˆ†
    n.contentEdit = n.contentEdit ? `${n.contentEdit}\n${suffix}` : suffix;
  }
}
function cancelEdit(n){
  n.editing = false;
}
async function saveEdit(n){
  try{
    const parsedArr = parseTagsFromText(n.contentEdit);
    const existingArr = parsedTags(n.tags);
    const useParsed = parsedArr.length > 0;
    const finalTagsArr = useParsed ? parsedArr : existingArr;
    const contentClean = useParsed ? stripTagsFromText(n.contentEdit) : n.contentEdit;
    const payload = {
      content: contentClean,
      tags: finalTagsArr.join(','),
      archived: n.archived ?? false,
      // è¯´æ˜ï¼šåç«¯ NoteRequest.java ä½¿ç”¨ camelCase å­—æ®µ isPublicï¼Œ
      // ä¹‹å‰å‘é€ is_publicï¼ˆsnake_caseï¼‰æœªè¢«ç»‘å®šï¼Œå¯¼è‡´å…¬å¼€çŠ¶æ€ä¸¢å¤±å¹¶æŒ‰é»˜è®¤â€œç§æœ‰â€ä¿å­˜ã€‚
      // è¿™é‡Œæ”¹ä¸º isPublicï¼Œç¡®ä¿åç«¯æ­£ç¡®æŒä¹…åŒ–ç”¨æˆ·çš„å…¬å¼€é€‰æ‹©ã€‚
      isPublic: n.isPublicEdit,
      color: (typeof n.color === 'string' ? n.color.trim() : '')
    };
    // è·¯å¾„åˆ‡æ¢ï¼šç»Ÿä¸€ä½¿ç”¨ /shiyan/{id}
    const { data } = await http.put(`/shiyan/${n.id}`, payload);
    // åç«¯å¯èƒ½è¿”å›æ›´æ–°åçš„ä¾¿ç­¾ï¼Œè‹¥æ— åˆ™ä½¿ç”¨ç¼–è¾‘å€¼å›å¡«
    const updated = data || payload;
    n.content = updated.content ?? contentClean;
    n.isPublic = (updated.isPublic ?? updated.is_public) ?? n.isPublicEdit;
    n.tags = updated.tags ?? finalTagsArr.join(',');
    n.editing = false;
    ElMessage.success('å·²ä¿å­˜ä¿®æ”¹');
  }catch(e){
    ElMessage.error('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
  }
}

async function deleteNote(n){
  try{
    // æ–‡æ¡ˆé‡å‘½åï¼šå°†â€œä¾¿ç­¾â€ç»Ÿä¸€æ”¹ä¸ºâ€œæ‹¾è¨€â€
    await ElMessageBox.confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ‹¾è¨€å—ï¼Ÿ', 'æç¤º', {
      confirmButtonText: 'åˆ é™¤',
      cancelButtonText: 'å–æ¶ˆ',
      type: 'warning'
    });
    // è·¯å¾„åˆ‡æ¢ï¼šç»Ÿä¸€ä½¿ç”¨ /shiyan/{id}
    await http.delete(`/shiyan/${n.id}`);
    notes.value = notes.value.filter(m => m.id !== n.id);
    ElMessage.success('å·²åˆ é™¤');
  }catch(e){
    // å–æ¶ˆæˆ–é”™è¯¯æ—¶ä¸æç¤ºé”™è¯¯ä¿¡æ¯
  }finally{
    n.showActions = false;
    if (activeNoteId.value === n.id) {
      activeNoteId.value = null;
      document.removeEventListener('click', onDocClick, true);
    }
  }
}

function closeActions(n){
  n.showActions = false;
  if (activeNoteId.value === n.id) {
    activeNoteId.value = null;
    document.removeEventListener('click', onDocClick, true);
  }
}

function parseTagsFromText(s){
  if (!s || typeof s !== 'string') return [];
  // å…¼å®¹æ€§ä¿®å¤è¯´æ˜ï¼š
  // åŸæ­£åˆ™ä½¿ç”¨äº† Unicode å±æ€§è½¬ä¹‰ \p{L}ï¼ˆåŒ¹é…æ‰€æœ‰å­—æ¯ç±»ï¼‰ï¼Œè™½ç„¶ç°ä»£æµè§ˆå™¨æ”¯æŒï¼Œä½†åœ¨éƒ¨åˆ†ç¯å¢ƒä¸‹ä¼šå¯¼è‡´è¯­æ³•é”™è¯¯ï¼ˆSyntaxError: Invalid or unexpected tokenï¼‰ã€‚
  // ä¸ºä¿è¯åœ¨æ‰€æœ‰å¸¸è§æµè§ˆå™¨ä¸­å¯ç”¨ï¼Œè¿™é‡Œæ”¹ç”¨æ˜¾å¼çš„å­—ç¬¦èŒƒå›´ï¼š
  // - è‹±æ–‡ä¸æ•°å­—ï¼šA-Za-z0-9
  // - ä¸‹åˆ’çº¿ä¸è¿å­—ç¬¦ï¼š_-
  // - ä¸­æ–‡ï¼ˆåŸºæœ¬æ±‰å­—ï¼‰ï¼š\u4e00-\u9fff
  // å¦‚æœåç»­éœ€è¦æ›´å¹¿è¦†ç›–ï¼ˆå¦‚æ—¥æ–‡ã€éŸ©æ–‡ã€æ›´å¤š Unicode å¹³é¢ï¼‰ï¼Œå¯åœ¨æ­¤èŒƒå›´ä¸Šæ‰©å±•ã€‚
  const re = /#([A-Za-z0-9_\u4e00-\u9fff-]+)/g;
  const set = new Set();
  let m;
  while ((m = re.exec(s))){
    const tag = (m[1] || '').trim();
    if (tag) set.add(tag);
  }
  return Array.from(set);
}
function stripTagsFromText(s){
  if (!s || typeof s !== 'string') return '';
  // ç§»é™¤ä»¥#å¼€å¤´çš„æ ‡ç­¾ä»¥åŠå…¶åçš„é€—å·ï¼ˆè‹¥æœ‰ï¼‰ï¼Œå¹¶è§„èŒƒç©ºç™½
  // å…¼å®¹æ€§ä¿®å¤ï¼šç§»é™¤ \p{L} å±æ€§è½¬ä¹‰ï¼Œæ”¹ä¸ºæ˜¾å¼å­—ç¬¦èŒƒå›´ï¼Œé¿å…åœ¨éƒ¨åˆ†æµè§ˆå™¨è§£ææ—¶æŠ¥è¯­æ³•é”™è¯¯ã€‚
  return s
    .replace(/\s*#([A-Za-z0-9_\u4e00-\u9fff-]+)\s*(,\s*)?/g, ' ')
    .replace(/\s{2,}/g, ' ')
    .trim();
}

// å–œæ¬¢ä¸æ”¶è—
async function toggleLike(n){
  if (n.likeLoading) return;
  n.likeLoading = true;
  try{
    // è·¯å¾„åˆ‡æ¢ï¼šç»Ÿä¸€ä½¿ç”¨ /shiyan/{id}/like|unlike
    const url = n.liked ? `/shiyan/${n.id}/unlike` : `/shiyan/${n.id}/like`;
    const { data } = await http.post(url);
    n.likeCount = Number(data?.count ?? data?.like_count ?? (n.likeCount || 0));
    n.liked = Boolean((data?.likedByMe ?? data?.liked_by_me ?? n.liked));
  }catch(e){
    ElMessage.error('æ“ä½œå¤±è´¥');
  }finally{
    n.likeLoading = false;
  }
}

async function toggleFavorite(n){
  if (n.favoriteLoading) return;
  n.favoriteLoading = true;
  try{
    // è·¯å¾„åˆ‡æ¢ï¼šç»Ÿä¸€ä½¿ç”¨ /shiyan/{id}/favorite|unfavorite
    const url = n.favorited ? `/shiyan/${n.id}/unfavorite` : `/shiyan/${n.id}/favorite`;
    const { data } = await http.post(url);
    n.favoriteCount = Number(data?.count ?? data?.favorite_count ?? (n.favoriteCount || 0));
    n.favorited = Boolean((data?.favoritedByMe ?? data?.favorited_by_me ?? n.favorited));
  }catch(e){
    ElMessage.error('æ“ä½œå¤±è´¥');
  }finally{
    n.favoriteLoading = false;
  }
}

// è½»é‡é«˜äº®ï¼šåœ¨ç¼–è¾‘æ€å¯¹æ­£æ–‡ä¸­çš„ #æ ‡ç­¾ åšèƒŒæ™¯é«˜äº®
const wrapperRefs = new Map();
function setWrapperRef(n){
  return (el) => {
    if (el) wrapperRefs.set(n.id, el); else wrapperRefs.delete(n.id);
  };
}
function escapeHtml(str){
  return String(str || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}
function highlightHTML(s){
  const text = typeof s === 'string' ? s : '';
  // å…¼å®¹æ€§ä¿®å¤ï¼šåŒä¸Šï¼Œç§»é™¤ \p{L}ï¼Œé‡‡ç”¨æ›´å¹¿ä½†æ˜¾å¼çš„å­—ç¬¦èŒƒå›´ä»¥æå‡è·¨æµè§ˆå™¨ç¨³å®šæ€§ã€‚
  const re = /#([A-Za-z0-9_\u4e00-\u9fff-]+)/g;
  let out = '';
  let last = 0;
  for (const m of text.matchAll(re)){
    const i = m.index ?? 0;
    const full = m[0] ?? '';
    out += escapeHtml(text.slice(last, i));
    out += `<span class="hl-tag">${escapeHtml(full)}</span>`;
    last = i + full.length;
  }
  out += escapeHtml(text.slice(last));
  return out;
}

// â€”â€” ç²˜è´´ä¿®å¤ï¼šå°†æ¥æºäºèŠå¤©åº”ç”¨çš„â€œå›¾ç‰‡è¡¨æƒ…/è´´çº¸â€è½¬æ¢ä¸º Unicode Emoji â€”â€”
// è¯´æ˜ï¼šéƒ¨åˆ†èŠå¤©åº”ç”¨å¤åˆ¶åˆ°å‰ªè´´æ¿æ—¶æºå¸¦ HTMLï¼Œ<img> æ‰¿è½½è¡¨æƒ…å›¾ç‰‡ï¼›ç›´æ¥ç²˜è´´åˆ° textarea ä¼šä¸¢å¤±å›¾ç‰‡ã€‚
// æ–¹æ¡ˆï¼šåœ¨æ•è·é˜¶æ®µç›‘å¬ document çš„ paste äº‹ä»¶ï¼Œè‹¥ç›®æ ‡ä½äºæœ¬é¡µç¼–è¾‘è¾“å…¥æ¡†ï¼Œåˆ™è§£æå‰ªè´´æ¿ HTMLï¼Œ
//       å°† <img ... alt|title|aria-label|data-emoji> è½¬æ¢ä¸ºå¯¹åº”çš„ Unicode Emoji å­—ç¬¦ï¼Œå¹¶å…¼å®¹ä¸­æ–‡åˆ«åã€‚
const focusedEditingId = ref(null);
function onEditFocus(it){ focusedEditingId.value = it?.id ?? null; }
function onEditBlur(){ focusedEditingId.value = null; }

// å¸¸è§/çƒ­é—¨æ˜ å°„ï¼šè‹±æ–‡æ•°æ®åä¸ä¸­æ–‡åˆ«ååˆ° Unicode Emoji
const emojiMap = {
  // ç»å…¸ç¬‘è„¸
  smile: 'ğŸ˜Š', happy: 'ğŸ˜„', grin: 'ğŸ˜', laugh: 'ğŸ˜†', joy: 'ğŸ˜‚', wink: 'ğŸ˜‰', blush: 'ğŸ˜Š', smirk: 'ğŸ˜',
  neutral_face: 'ğŸ˜', expressionless: 'ğŸ˜‘', unamused: 'ğŸ˜’', relieved: 'ğŸ˜Œ',
  surprised: 'ğŸ˜®', astonished: 'ğŸ˜²', scream: 'ğŸ˜±',
  sad: 'â˜¹ï¸', crying: 'ğŸ˜¢', sob: 'ğŸ˜­', weary: 'ğŸ˜©', tired: 'ğŸ˜«', disappointed: 'ğŸ˜',
  angry: 'ğŸ˜ ', rage: 'ğŸ¤¬', confounded: 'ğŸ˜–',
  thinking: 'ğŸ¤”', facepalm: 'ğŸ¤¦', shushing_face: 'ğŸ¤«', lying_face: 'ğŸ¤¥', zipper_mouth: 'ğŸ¤',
  // çˆ±å¿ƒ/åº†ç¥
  heart: 'â¤ï¸', hearts: 'ğŸ’•', heart_eyes: 'ğŸ˜', kiss: 'ğŸ˜˜', kissing_heart: 'ğŸ˜˜',
  broken_heart: 'ğŸ’”', two_hearts: 'ğŸ’•', sparkling_heart: 'ğŸ’–',
  sparkles: 'âœ¨', star: 'â­', stars: 'ğŸŒŸ', party_popper: 'ğŸ‰', tada: 'ğŸ‰', gift: 'ğŸ', balloon: 'ğŸˆ', ribbon: 'ğŸ€', confetti_ball: 'ğŸŠ',
  // æ‰‹åŠ¿
  thumbs_up: 'ğŸ‘', thumbsup: 'ğŸ‘', like: 'ğŸ‘', thumbs_down: 'ğŸ‘', clap: 'ğŸ‘', pray: 'ğŸ™',
  ok_hand: 'ğŸ‘Œ', victory_hand: 'âœŒï¸', v: 'âœŒï¸', wave: 'ğŸ‘‹', raised_hand: 'âœ‹', fist: 'âœŠ', rock: 'ğŸ¤˜', handshake: 'ğŸ¤',
  // è‡ªç„¶/æ¤ç‰©
  tulip: 'ğŸŒ·', rose: 'ğŸŒ¹', cherry_blossom: 'ğŸŒ¸', sunflower: 'ğŸŒ»', hibiscus: 'ğŸŒº', bouquet: 'ğŸ’',
  sun: 'â˜€ï¸', moon: 'ğŸŒ™', cloud: 'â˜ï¸', fire: 'ğŸ”¥', rainbow: 'ğŸŒˆ', leaf: 'ğŸƒ', butterfly: 'ğŸ¦‹',
  // å…¶å®ƒå¸¸ç”¨å›¾æ ‡
  dog: 'ğŸ¶', cat: 'ğŸ±', coffee: 'â˜•', cake: 'ğŸ°', beer: 'ğŸº', camera: 'ğŸ“·', music: 'ğŸµ', book: 'ğŸ“š', pencil: 'âœï¸', check: 'âœ”ï¸', cross: 'âŒ', warning: 'âš ï¸', info: 'â„¹ï¸', question: 'â“', exclamation: 'â—', rocket: 'ğŸš€',
  // ä¸­æ–‡åˆ«åï¼ˆå¾®ä¿¡/QQ/è´´å§ç­‰å¸¸è§ï¼‰
  'å¾®ç¬‘': 'ğŸ˜Š', 'å¼€å¿ƒ': 'ğŸ˜Š', 'å¤§ç¬‘': 'ğŸ˜„', 'åç¬‘': 'ğŸ˜', 'ç¬‘å“­': 'ğŸ˜‚', 'çœ¨çœ¼': 'ğŸ˜‰', 'æ‚è„¸': 'ğŸ¤¦', 'å°´å°¬': 'ğŸ˜¬', 'å®³ç¾': 'â˜ºï¸',
  'å¯çˆ±': 'ğŸ˜Š', 'é…·': 'ğŸ˜', 'æ€è€ƒ': 'ğŸ¤”', 'æƒŠè®¶': 'ğŸ˜²', 'éœ‡æƒŠ': 'ğŸ˜±', 'éš¾è¿‡': 'â˜¹ï¸', 'å¤§å“­': 'ğŸ˜­', 'å§”å±ˆ': 'ğŸ˜¢', 'æ— è¯­': 'ğŸ˜‘', 'é—­å˜´': 'ğŸ¤',
  'å¿ƒ': 'â¤ï¸', 'çˆ±å¿ƒ': 'â¤ï¸', 'çº¢å¿ƒ': 'â¤ï¸', 'å¿ƒç¢': 'ğŸ’”', 'æ¯”å¿ƒ': 'ğŸ’•', 'æ˜Ÿæ˜Ÿ': 'â­', 'é—ªè€€': 'âœ¨',
  'ç‚¹èµ': 'ğŸ‘', 'èµ': 'ğŸ‘', 'ä¸èµ': 'ğŸ‘', 'é¼“æŒ': 'ğŸ‘', 'ç¥ˆç¥·': 'ğŸ™', 'æ¡æ‰‹': 'ğŸ¤', 'å†è§': 'ğŸ‘‹', 'è€¶': 'âœŒï¸', 'ok': 'ğŸ‘Œ',
  'ç¤¼ç‰©': 'ğŸ', 'åº†ç¥': 'ğŸ‰', 'æ°”çƒ': 'ğŸˆ', 'å¤ªé˜³': 'â˜€ï¸', 'æœˆäº®': 'ğŸŒ™', 'å½©è™¹': 'ğŸŒˆ', 'å¶å­': 'ğŸƒ', 'è´è¶': 'ğŸ¦‹',
  // ç½‘ç»œå¸¸è§åˆ«å
  'doge': 'ğŸ¶', 'æ³ªç›®': 'ğŸ˜­', 'æ‘¸é±¼': 'ğŸŸ', 'ç‡ƒ': 'ğŸ”¥', 'çœŸæ£’': 'ğŸ‘', 'ç‰›': 'ğŸ®'
};

function htmlToTextWithEmoji(html){
  try{
    const div = document.createElement('div');
    div.innerHTML = html;
    div.querySelectorAll('img').forEach(img => {
      const alt = img.getAttribute('alt') || '';
      const title = img.getAttribute('title') || '';
      const aria = img.getAttribute('aria-label') || '';
      const dataEmoji = img.getAttribute('data-emoji') || img.getAttribute('data-name') || '';
      let rep = '';
      const cand = [alt, title, aria, dataEmoji].map(s => String(s).replace(/[\[\]]/g,'').trim()).filter(Boolean);
      for (const c of cand){
        if (/[\u2600-\u27BF\uD83C-\uDBFF\uDC00-\uDFFF]/.test(c)) { rep = c; break; }
        if (emojiMap[c]) { rep = emojiMap[c]; break; }
      }
      const span = document.createElement('span');
      span.textContent = rep || '';
      img.replaceWith(span);
    });
    // ç§»é™¤å¯èƒ½çš„è„šæœ¬å¹¶è·å–çº¯æ–‡æœ¬
    div.querySelectorAll('script,style').forEach(el => el.remove());
    return div.textContent || div.innerText || '';
  }catch{ return ''; }
}

function handlePaste(e){
  try{
    // ä»…åœ¨å½“å‰é¡µé¢ç¼–è¾‘æ€è¾“å…¥æ¡†å†…å¤„ç†
    if (!focusedEditingId.value) return;
    const target = e.target;
    const wrapper = document.querySelector(`[data-note-id="${focusedEditingId.value}"]`);
    if (!wrapper || !wrapper.contains(target)) return;
    const cb = e.clipboardData || window.clipboardData;
    if (!cb) return;
    const html = cb.getData?.('text/html') || '';
    if (!html) return; // æ—  HTML å†…å®¹åˆ™äº¤ç”±é»˜è®¤ç²˜è´´å¤„ç†
    const converted = htmlToTextWithEmoji(html);
    if (!converted) return;
    e.preventDefault();
    const ta = wrapper.querySelector('textarea');
    if (!ta) return;
    const start = ta.selectionStart ?? ta.value.length;
    const end = ta.selectionEnd ?? start;
    const before = ta.value.slice(0, start);
    const after = ta.value.slice(end);
    const ins = converted;
    ta.value = `${before}${ins}${after}`;
    const newVal = ta.value;
    // åŒæ­¥ v-model
    const note = notes.value.find(x => x.id === focusedEditingId.value);
    if (note) note.contentEdit = newVal;
    // æ¢å¤å…‰æ ‡åˆ°æ’å…¥æœ«å°¾
    const pos = before.length + ins.length;
    ta.setSelectionRange(pos, pos);
    ta.dispatchEvent(new Event('input', { bubbles: true }));
  }catch{}
}

onMounted(() => {
  document.addEventListener('paste', handlePaste, true);
});
onUnmounted(() => {
  document.removeEventListener('paste', handlePaste, true);
});
</script>

<style scoped>
 /* ç§»é™¤æœ¬åœ°é¡¶æ ç›¸å…³æ ·å¼ï¼ˆä½¿ç”¨å…¬å…±é¡¶æ  AppTopBarï¼‰ */
 /* å…¶å®ƒæ ·å¼ä¿æŒä¸å˜ï¼Œæ­£æ–‡ä»åœ¨å³ä¾§æ»šåŠ¨å®¹å™¨ä¸­è¿›è¡Œæ»šåŠ¨ä¸ç²˜é¡¶ */
.note-card { background:#fff; border-radius:12px; padding:12px 12px 32px; box-shadow:0 4px 12px rgba(0,0,0,0.08); position:relative; }
.note-card.editing { box-shadow:0 0 0 3px rgba(64,158,255,0.14), 0 4px 12px rgba(0,0,0,0.08); }
.note-content { white-space:pre-wrap; line-height:1.7; color:#303133; margin:4px 0 6px; }
.note-card.editing .note-content { color: var(--fgColor, #303133); }
.note-tags { display:flex; flex-wrap:wrap; gap:6px; }
.note-tags.top-right { position:absolute; top:8px; right:12px; }
.meta.bottom-left { position:absolute; left:12px; bottom:10px; }
.meta.bottom-right { position:absolute; right:12px; bottom:10px; color:#606266; font-size:12px; }
.author-above { color:#606266; font-size:12px; margin: 0 0 6px 0; }

/* å¹´ä»½åˆ†ç»„æ ·å¼ï¼ˆå±‚æ¬¡æ›´æ˜æ˜¾ï¼‰ */
.year-group { margin-bottom: 16px; }
.year-header { display:flex; align-items:center; padding:10px 12px; border-radius:12px; background:#ffffff; box-shadow: 0 6px 20px rgba(0,0,0,0.06); position: sticky; top: calc(var(--filtersH, 48px) + 6px); z-index: 10; }
.year-title { font-size:22px; font-weight:700; color:#303133; letter-spacing:0.5px; }
.year-header::before { content:''; display:block; width:6px; height:24px; border-radius:6px; background:#409eff; margin-right:10px; opacity:0.85; }

/* é•¿æŒ‰åŠ¨ä½œèœå•è¦†ç›–å±‚ */
.actions-overlay {
  position:absolute;
  inset:0;
  background: rgba(0,0,0,0.08);
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  border-radius:12px;
}

.edit-actions { display:flex; gap:8px; align-items:center; }

/* å›¾æ ‡åŠ¨ä½œæŒ‰é’® */
.action-icon {
  width:40px; height:40px; border-radius:50%; background:#fff;
  box-shadow:0 6px 16px rgba(0,0,0,0.12);
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
}
.action-icon.danger { background:#fff0f0; }
.action-icon:hover { transform: translateY(-1px); transition: transform 0.12s ease; }

/* ç¼–è¾‘æ€å¸ƒå±€ä¼˜åŒ– */
.edit-form { display:flex; flex-direction:column; gap:10px; padding-bottom:38px; }
.edit-toolbar { display:flex; align-items:center; gap:8px; }
.edit-toolbar .spacer { flex:1; }
.edit-toolbar .label { font-size:12px; color:#606266; }
.edit-row { display:flex; align-items:center; gap:8px; }
.edit-row .label { font-size:12px; color:#606266; }
.tags-preview { display:flex; flex-wrap:wrap; gap:6px; }
.edit-footer { position:absolute; left:12px; right:12px; bottom:10px; display:flex; align-items:center; justify-content:space-between; }
.edit-footer .left { display:flex; align-items:center; }
.edit-footer .edit-actions { gap:8px; }

/* è¿‡æ»¤æ æ ·å¼ä¼˜åŒ– */
.filters { background:#fff; border-radius:12px; padding:10px 12px; box-shadow:0 4px 12px rgba(0,0,0,0.06); margin-bottom:12px; }
.filters-form :deep(.el-form-item) { margin-bottom: 0; margin-right: 26px; }
.order-toggle { padding:4px 8px; }
.sort-inline { display:inline-flex; align-items:center; gap:8px; }
.filters-form { display:flex; flex-wrap:wrap; align-items:center; }
.top-row { display:flex; align-items:center; justify-content:space-between; width:100%; flex: 1 1 100%; }
.top-left { display:flex; flex-wrap:wrap; align-items:center; flex: 1 1 auto; min-width: 0; }
.top-right { display:flex; align-items:center; flex: 0 0 auto; }
.filters-form .pull-right { margin-left:auto; margin-right:0; }
.filters-form .flex-break { flex-basis: 100%; height: 0; }
/* æœç´¢é¡¹æŒ‰å†…å®¹è‡ªé€‚åº”å®½åº¦ï¼ˆæ¶ˆé™¤å³ä¾§ç©ºç™½å ä½ï¼‰ï¼Œä»ä¿ç•™å³å¯¹é½ */
.filters-form .aligned-340 { flex: 0 0 auto; width: auto; min-width: 240px; margin-right:0; }
@media (max-width: 480px){
  .filters-form .aligned-340 { min-width: 200px; }
}
/* å¼ºåˆ¶ç»Ÿä¸€æ ‡ç­¾å®½åº¦ï¼Œé¿å…å› æ ·å¼è¦†ç›–å¯¼è‡´åå·® */
.filters-form :deep(.el-form-item__label){ width: 80px !important; }

/* æ‰¹é‡å·¥å…·æ æ ·å¼ï¼šå·¦å³åˆ†å¸ƒï¼Œè·Ÿéšè¿‡æ»¤æ ç²˜é¡¶ï¼Œé¿å…é®æŒ¡ */
.bulk-toolbar { display:flex; align-items:center; gap:8px; padding:8px 0 0; }
.bulk-toolbar .bulk-left { display:flex; gap:8px; }
.bulk-toolbar .bulk-right { display:flex; gap:8px; }
.bulk-toolbar .spacer { flex:1; }
.selected-count { margin-left:8px; font-size:12px; color:#606266; }

/* å¸é¡¶æ•ˆæœ */
.filters { position: sticky; top: 0; z-index: 20; }
.filters.is-stuck { backdrop-filter: saturate(180%) blur(8px); background: rgba(255,255,255,0.85); box-shadow: 0 6px 20px rgba(0,0,0,0.12); border: 1px solid rgba(0,0,0,0.06); }

/* åˆ—è¡¨è¿‡æ¸¡åŠ¨ç”»ï¼ˆé‡æ’/è¿›å‡ºï¼‰ */
.list-enter-active, .list-leave-active { transition: all .25s ease; will-change: transform, opacity; }
.list-enter-from, .list-leave-to { opacity: 0; transform: translateY(8px) scale(0.98); }
.list-move { transition: transform .25s ease; }

/* é•¿æŒ‰åŠ¨ä½œèœå•è¿‡æ¸¡ */
.overlay-enter-active, .overlay-leave-active { transition: opacity .18s ease, transform .18s ease; }
.overlay-enter-from, .overlay-leave-to { opacity: 0; transform: scale(0.98); }

/* ç¼–è¾‘æ€ï¼š#æ ‡ç­¾è½»å¾®é«˜äº®ï¼ˆä¸å é¢å¤–ç©ºé—´ï¼‰ */
.textarea-highlight-wrapper { position: relative; }
.textarea-highlight-wrapper .highlight-layer {
  position: absolute; inset: 0;
  padding: 6px 12px; /* å¯¹é½ textarea å†…è¾¹è· */
  white-space: pre-wrap; word-break: break-word;
  pointer-events: none; /* ä¸æ‹¦æˆªè¾“å…¥ */
  color: transparent; /* æ™®é€šæ–‡æœ¬é€æ˜ï¼Œä»…æ˜¾ç¤ºé«˜äº®ç‰‡æ®µ */
}
.textarea-highlight-wrapper .highlight-layer .hl-tag {
  background: rgba(64,158,255,0.15);
  border-radius: 4px;
  padding: 0 2px;
  color: #409eff;
}
.edit-form :deep(.el-textarea__inner) {
  background: transparent !important;
  color: var(--fgColor, #303133) !important;
  caret-color: var(--fgColor, #303133);
}

/* é€‰æ‹©æ¡†ï¼ˆå·¦ä¸Šè§’ï¼‰æ ·å¼ï¼šä¿æŒä¸å¡ç‰‡ä¸€è‡´çš„åœ†è§’ä¸å±‚çº§ */
.select-box { position:absolute; right:12px; z-index: 5; background: rgba(255,255,255,0.92); border-radius: 8px; padding: 2px 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
/* æ”¾åœ¨æ ‡ç­¾ä¸‹æ–¹ï¼šæ ‡ç­¾é«˜åº¦çº¦ä¸º 24~28pxï¼Œè€ƒè™‘å†…è¾¹è·ä¸é—´è·ï¼Œå– 38px ä½œä¸ºåç§»é‡ï¼Œé¿å…é‡å  */
.select-box.below-tags { top: 38px; }
/* æœç´¢æ¡†ç¾åŒ– */
.search-input :deep(.el-input__wrapper) {
  border-radius: 999px;
  background: #f5f7fa;
  box-shadow: none;
  transition: box-shadow .15s ease, background-color .15s ease;
}
.search-input :deep(.el-input__wrapper:hover) {
  background: #f4f6f9;
}
.search-input :deep(.el-input__wrapper.is-focus) {
  background: #ffffff;
  box-shadow: 0 0 0 2px rgba(64,158,255,0.25), 0 4px 10px rgba(0,0,0,0.06);
}
.search-input :deep(.el-input__prefix) {
  margin-right: 4px;
  opacity: 0.7;
}
.search-input :deep(input::placeholder) {
  color: #909399;
}
/* Enter è½»å¾®åŠ¨ç”»åé¦ˆï¼ˆæŸ”å’Œæ‰©æ•£é˜´å½±ï¼‰ */
.search-input.pulse :deep(.el-input__wrapper){
  animation: pulseRing 400ms ease;
}
@keyframes pulseRing{
  0%{ box-shadow: 0 0 0 0 rgba(64,158,255,0.35); }
  100%{ box-shadow: 0 0 0 8px rgba(64,158,255,0); }
}

/* å³ä¸‹å›åˆ°é¡¶éƒ¨æŒ‰é’®ç¾åŒ– */
.container :deep(.el-backtop){ z-index: 120; background: transparent; box-shadow: none; }
.backtop-btn{
  width: 44px; height: 44px; border-radius: 999px;
  background: linear-gradient(135deg, #409eff, #66b1ff);
  display:flex; align-items:center; justify-content:center; color:#fff;
  box-shadow: 0 8px 24px rgba(64,158,255,0.30), 0 2px 6px rgba(0,0,0,0.12);
  transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
}
.backtop-btn:hover{ transform: translateY(-2px); box-shadow: 0 12px 28px rgba(64,158,255,0.38), 0 4px 10px rgba(0,0,0,0.14); }
.backtop-btn:active{ transform: translateY(0); filter: brightness(0.96); }
/* ä¸ªäººèµ„æ–™æ‘˜è¦ï¼ˆå¤´åƒ + æ–‡æœ¬ï¼‰æ ·å¼ */
.profile-summary { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; background: transparent; border-radius:12px; padding:12px; box-shadow:none; margin-bottom:12px; }
.profile-summary .avatar-lg { width:260px; height:260px; max-width:260px; max-height:260px; display:block; border-radius:50%; object-fit:cover; overflow:hidden; flex-shrink:0; border:3px solid #fff; box-shadow:0 4px 12px rgba(0,0,0,0.12); background:#fff; }
.profile-summary .text { display:flex; flex-direction:column; align-items:center; text-align:center; min-width:0; max-width:360px; gap:6px; }
.profile-summary .nickname { font-weight:700; color:#303133; font-size:20px; letter-spacing:0.3px; line-height:1.2; }
.profile-summary .nickname::after { content:''; display:block; width:28px; height:3px; border-radius:3px; background:#409eff; opacity:0.85; margin:6px auto 0; }
.profile-summary .signature { color:#606266; font-size:14px; font-style:italic; line-height:1.6; opacity:0.9; }
.signature-ellipsis-3 { display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 3; overflow: hidden; word-break: break-word; white-space: pre-line; }
.signature-full { -webkit-line-clamp: unset; display: block; overflow: visible; white-space: pre-line; }
.sig-toggle { color: var(--el-color-primary); font-size:13px; cursor:pointer; user-select:none; margin-top:4px; }
.signature-ellipsis { display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; overflow: hidden; word-break: break-word; white-space: pre-line; }

/* åŠ è½½æ›´å¤šåŒºåŸŸæ ·å¼ï¼ˆä¸ Likes/Favorites é¡µé¢ä¿æŒä¸€è‡´ä½“éªŒï¼‰ */
.load-more-container { display:flex; flex-direction:column; align-items:center; gap:8px; margin: 16px 0 32px; }
.load-more-btn { padding:8px 16px; border-radius:6px; border:1px solid #dcdfe6; background:#f5f7ff; color:#409eff; cursor:pointer; }
.load-more-btn:disabled { opacity:0.6; cursor:not-allowed; }
.load-more-sentinel { width:100%; max-width:640px; height:1px; }
</style>
<!--
  æˆ‘çš„æ‹¾è¨€è§†å›¾ï¼ˆMyNotesï¼‰
  è¯´æ˜ï¼š
  - å¤ç”¨ TwoPaneLayout ä¸ AppTopBarï¼Œå³ä¾§ä¸ºä¸ªäººèµ„æ–™ã€è¿‡æ»¤æ ä¸åˆ—è¡¨ï¼›
  - éœ€è¦ç™»å½•ï¼šç”±è·¯ç”± `meta.requiresAuth` æ§åˆ¶ï¼Œè¿›å…¥å‰æ ¡éªŒæœ¬åœ° tokenï¼›
  - æœåŠ¡ç«¯åˆ†é¡µï¼šä½¿ç”¨ page/size/total æ§åˆ¶ç¿»é¡µä¸â€œæ˜¯å¦è¿˜æœ‰ä¸‹ä¸€é¡µâ€ï¼›
  - äº¤äº’ï¼šæ”¯æŒæ‰¹é‡æ“ä½œã€å›åˆ°é¡¶éƒ¨ã€è§¦åº•åŠ è½½ï¼Œé¿å…å¹¶å‘ä¸é‡å¤åŠ è½½ã€‚
-->