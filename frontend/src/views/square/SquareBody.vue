<!--
  SquareBody ç»„ä»¶ï¼ˆå¹¿åœºæ­£æ–‡ï¼‰
  èŒè´£ï¼š
  - æ¸²æŸ“åç«¯åˆ†ç±»ä¸ç«™ç‚¹å¡ç‰‡ï¼Œæ”¯æŒåˆ†åŒºæ ‡é¢˜å¸é™„ä¸æ»šåŠ¨å®šä½ï¼›
  - é¡¶éƒ¨å“ç‰ŒåŒºä¸å‰¯æ ‡é¢˜ï¼Œå¢å¼ºè¯†åˆ«ä¸å¯è®¿é—®æ€§ã€‚
  è”åŠ¨ä¸æ»šåŠ¨ï¼š
  - æš´éœ² scrollTo(id) ä¾›ä¾§æ è°ƒç”¨ï¼Œå®ç°ç²¾ç¡®æ»šåŠ¨å®šä½ä¸åç§»æ§åˆ¶ï¼›
  - ä½¿ç”¨ contentRef ä½œä¸ºå”¯ä¸€æ»šåŠ¨å®¹å™¨ï¼Œé¿å…åŒæ»šåŠ¨ä¸æµ‹é‡è¯¯å·®ã€‚
  æ€§èƒ½ä¸ä½“éªŒï¼š
  - åˆç†çš„å¡ç‰‡å¸ƒå±€ä¸é˜´å½±ï¼Œç§»åŠ¨ç«¯é€‚é…ï¼›
  - åˆ†ç±»æ•°æ®æ‡’åŠ è½½ä¸åˆ†å—æ¸²æŸ“ï¼Œå‡è½»é¦–å±å‹åŠ›ã€‚
-->
<template>
  <!-- é¡µé¢ä¸»ä½“å®¹å™¨ï¼šè´Ÿè´£å¸ƒå±€ã€æ»šåŠ¨ç­‰æ ¸å¿ƒåŠŸèƒ½ -->
  <div class="container">
    <!-- é¡µé¢å¤´éƒ¨ï¼šæ‹¾è¨€å¹¿åœºæ ‡é¢˜ -->
    <header class="square-header">
      <!-- æ ‡é¢˜åŒºç¾åŒ–ï¼šå¢åŠ å“ç‰Œå›¾æ ‡å®¹å™¨ã€æ¸å˜æ ‡é¢˜ä¸å‰¯æ ‡é¢˜
           è®¾è®¡ç›®æ ‡ï¼š
           - åœ¨ä¸æ”¹å˜æ•´ä½“å¸ƒå±€çš„å‰æä¸‹ï¼Œæå‡é¡µé¢è¯†åˆ«åº¦ä¸è´¨æ„Ÿï¼›
           - ä½¿ç”¨è½»é‡é˜´å½±ä¸æŸ”å’Œæ¸å˜ï¼Œä¿è¯ä¸å†…å®¹åŒºçš„åè°ƒï¼›
           - æ–‡æœ¬ä¸å›¾æ ‡å‡å¯è®¿é—®ï¼ˆARIA æ ‡ç­¾ï¼‰ï¼Œå…¼é¡¾è¯­ä¹‰ä¸å…¼å®¹ã€‚ -->
      <!-- æ–‡æ¡ˆé‡å‘½åï¼šå“ç‰Œç»Ÿä¸€ä¸ºâ€œæ‹¾Â·è¨€â€ -->
      <div class="brand" aria-label="æ‹¾Â·è¨€ Â· å¹¿åœº æ ‡é¢˜åŒº">
        <!-- å“ç‰Œå›¾æ ‡å®¹å™¨ï¼šåœ†è§’èƒŒæ™¯ + è½»å¾®é˜´å½±ï¼Œå¼ºè°ƒè§†è§‰ç„¦ç‚¹ -->
        <div class="logo-wrap" aria-hidden="true">
          <img src="https://api.iconify.design/mdi/notebook-outline.svg" alt="logo" width="24" height="24" />
        </div>
        <!-- æ ‡é¢˜ä¸å‰¯æ ‡é¢˜ï¼šä¸»æ ‡é¢˜é‡‡ç”¨æ¸å˜æ–‡æœ¬ï¼Œå‰¯æ ‡é¢˜ä¸ºè½»æç¤ºè¯­ -->
        <div class="title-wrap">
          <h1 class="title">æ‹¾è¨€ Â· å¹¿åœº</h1>
          <p class="subtitle">ç²¾é€‰ç«™ç‚¹ä¸å·¥å…·ï¼Œå‘ç°æ›´é«˜æ•ˆçš„çµæ„Ÿ</p>
        </div>
      </div>
    </header>

    <section class="layout">
      <!-- ä¸»è¦å†…å®¹åŒºåŸŸï¼šæ»šåŠ¨å®¹å™¨ -->
      <div class="content-scroll" ref="contentRef">
        <!-- åŠ¨æ€å¯¼èˆªæ¸²æŸ“ï¼šæ ¹æ®åç«¯åˆ†ç±»æ•°æ®ç”Ÿæˆå¡ç‰‡ -->
        <!-- è¯´æ˜ï¼š
             - å½“ useNavigation æˆåŠŸåŠ è½½åˆ°åˆ†ç±»æ—¶ï¼Œæ ¹æ®å¯¼èˆªç»“æ„åŠ¨æ€æ¸²æŸ“å³ä¾§å¡ç‰‡ï¼›
             - ä¸€çº§åˆ†ç±»æ— å­åˆ†ç±»ï¼šç›´æ¥æ¸²æŸ“ä¸€ä¸ªå¡ç‰‡ï¼›æœ‰å­åˆ†ç±»ï¼šä¸ºæ¯ä¸ªå­åˆ†ç±»æ¸²æŸ“å¡ç‰‡ï¼›
             - ä½¿ç”¨ NavigationSiteList ç»„ä»¶ï¼Œæ”¯æŒéª¨æ¶åŠ è½½ã€åˆ†é¡µã€ç§»åŠ¨ç«¯åŠ è½½æ›´å¤šã€ç‚¹å‡»è®¡æ•°ç­‰åŠŸèƒ½ã€‚ -->
        <template v-if="navigationSections && navigationSections.length">
          <div v-for="section in navigationSections" :key="section.id">
            <!-- æœ‰å­åˆ†ç±»ï¼šä¸ºæ¯ä¸ªå­åˆ†ç±»æ¸²æŸ“ç‹¬ç«‹å¡ç‰‡ -->
            <template v-if="section.children && section.children.length">
              <!-- å­åˆ†ç±»å¡ç‰‡ï¼šå‰¯æ ‡é¢˜ç»‘å®šä¸ºå­åˆ†ç±»çš„æè¿°ï¼›è‹¥æ— æè¿°åˆ™å›é€€ä¸ºâ€œæ¨èç«™ç‚¹â€ -->
              <NavigationSiteList
                v-for="child in section.children"
                :key="child.id"
                :id="child.id"
                :title="child.label"
                :subtitle="child.description || 'æ¨èç«™ç‚¹'"
                :categoryId="child.categoryId"
                :deferLoad="!(activeId === child.id || forceLoadIds.has(child.id))"
              />
            </template>
            <!-- æ— å­åˆ†ç±»ï¼šç›´æ¥æ¸²æŸ“çˆ¶åˆ†ç±»å¡ç‰‡ -->
            <template v-else>
              <!-- çˆ¶åˆ†ç±»å¡ç‰‡ï¼šå‰¯æ ‡é¢˜ç»‘å®šä¸ºè¯¥åˆ†ç±»çš„æè¿°ï¼›è‹¥æ— æè¿°åˆ™å›é€€ä¸ºâ€œæ¨èç«™ç‚¹â€ -->
              <NavigationSiteList
                :id="section.id"
                :title="section.label"
                :subtitle="section.description || 'æ¨èç«™ç‚¹'"
                :categoryId="section.categoryId"
                :deferLoad="!(activeId === section.id || forceLoadIds.has(section.id))"
              />
            </template>
          </div>
        </template>

        <!-- åå¤‡æ˜¾ç¤ºï¼šå½“å¯¼èˆªæ•°æ®åŠ è½½å¤±è´¥æˆ–ä¸ºç©ºæ—¶æ˜¾ç¤ºæç¤º -->
        <template v-else>
          <div class="empty-state">
            <div class="empty-icon">ğŸ“‹</div>
            <div class="empty-title">æ­£åœ¨åŠ è½½å¯¼èˆªåˆ†ç±»...</div>
            <div class="empty-desc">å¦‚æœé•¿æ—¶é—´æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥åç«¯å¯¼èˆªæ¥å£æ˜¯å¦æ­£å¸¸</div>
          </div>
        </template>
      </div>
    </section>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted, computed, watch, reactive } from 'vue'
/**
 * å˜æ›´è¯´æ˜ï¼ˆè¯¦ç»†æ³¨é‡Šï¼‰ï¼š
 * ä¸ºè§£å†³â€œä¾§è¾¹æ å­å¯¼èˆªç‚¹å‡»åæ‰“å¼€å…¶ä»–å¯¼èˆªâ€çš„é—®é¢˜ï¼Œ
 * æœ¬ç»„ä»¶æ–°å¢ props.sectionsï¼Œå¹¶ä¼˜å…ˆä½¿ç”¨çˆ¶ç»„ä»¶ä¼ å…¥çš„å¯¼èˆªæ•°æ®è¿›è¡Œæ¸²æŸ“ä¸æ»šåŠ¨å®šä½ã€‚
 * èƒŒæ™¯ä¸åŸå› ï¼š
 * - Square.vue ä¸ SquareBody.vue ä¹‹å‰å„è‡ªè°ƒç”¨ useNavigation()ï¼Œ
 *   ç”±äºç»„åˆå¼å‡½æ•°æ˜¯æŒ‰è°ƒç”¨å®ä¾‹åŒ–ï¼Œä¸¤ä¸ªç»„ä»¶ä¼šæŒæœ‰â€œå„è‡ªç‹¬ç«‹çš„çŠ¶æ€æºâ€ã€‚
 * - åœ¨åˆ†ç±»æ•°æ®å¼‚æ­¥åŠ è½½æˆ–å›é€€ä¸ºé»˜è®¤ç¡¬ç¼–ç æ•°æ®çš„æ—¶åºå·®å¼‚ä¸‹ï¼Œ
 *   å·¦ä¾§ SideNav ä¸å³ä¾§å¡ç‰‡ä½¿ç”¨çš„ sections å¯èƒ½ä¸ä¸€è‡´ï¼ˆå¦‚ä¸€æ–¹æ˜¯é»˜è®¤ã€å¦ä¸€æ–¹æ˜¯åç«¯æ•°æ®ï¼‰ã€‚
 * - å½“ç”¨æˆ·ç‚¹å‡»å­å¯¼èˆªæ—¶ï¼Œä¼ é€’çš„ id ä¸å³ä¾§å®é™…æ¸²æŸ“çš„å¡ç‰‡ id ä¸ä¸€è‡´ï¼Œ
 *   å¯¼è‡´ scrollTo('#'+id) å‘½ä¸­é”™è¯¯å…ƒç´ æˆ–æ‰¾ä¸åˆ°ç›®æ ‡ï¼Œä»è€Œå‡ºç°â€œæ»šåˆ°å…¶ä»–å¯¼èˆªâ€çš„ç°è±¡ã€‚
 * è§£å†³æ–¹æ¡ˆï¼š
 * - é€šè¿‡ props.sections æ¥æ”¶å¹¶å¤ç”¨çˆ¶ç»„ä»¶ä¸­ SideNav ä½¿ç”¨çš„åŒä¸€ä»½å¯¼èˆªæ•°æ®ï¼Œ
 *   ä¿è¯å·¦å³ä¸¤ä¾§çš„ id ä¸ç»“æ„å®Œå…¨ä¸€è‡´ï¼Œé¿å…å› å¤šæºçŠ¶æ€é€ æˆçš„é”™é…ã€‚
 * - å½“æœªä¼ å…¥ sectionsï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰æ—¶ï¼Œæ‰å›é€€ä¸ºå†…éƒ¨ useNavigation çš„ sideNavSectionsã€‚
 */
import { useRoute } from 'vue-router'
import { getToken } from '@/utils/auth'
import NavigationSiteList from '@/components/NavigationSiteList.vue'
import { useNavigation } from '@/composables/useNavigation'

// æš´éœ²äº‹ä»¶ï¼šå‘çˆ¶ç»„ä»¶æ›´æ–°å½“å‰é«˜äº®é¡¹ï¼Œä»¥è”åŠ¨å·¦ä¾§ SideNav çš„ v-model
const emit = defineEmits(['update:activeId'])

// è·¯ç”±å¼•ç”¨ï¼šåœ¨ setup é˜¶æ®µåˆ›å»ºï¼Œé¿å… onMounted å†…éƒ¨æœªåˆå§‹åŒ–å¯¼è‡´çš„ç©ºå¼•ç”¨
const route = useRoute()

// Propsï¼šå¯é€‰ç”±çˆ¶ç»„ä»¶ä¼ å…¥çš„å¯¼èˆªæ•°æ®ï¼ˆä¼˜å…ˆä½¿ç”¨ä»¥ä¿è¯å·¦å³ä¸€è‡´ï¼‰
const props = defineProps({
  /**
   * sectionsï¼šçˆ¶ç»„ä»¶ä¼ å…¥çš„å¯¼èˆªç»“æ„æ•°ç»„
   * ç»“æ„ç¤ºä¾‹ï¼š
   * [
   *   { id: 'category-1', label: 'å¼€å‘å·¥å…·', children: [ { id:'category-7', label:'åœ¨çº¿ç¼–è¾‘å™¨' } ] },
   *   { id: 'site', label: 'èšåˆæ‹¾è¨€' }
   * ]
   */
  sections: { type: Array, default: () => [] },
  /**
   * queryï¼šæœç´¢å…³é”®è¯ï¼ˆä¿ç•™åŸåŠŸèƒ½ï¼‰
   */
  query: { type: String, default: '' }
})

// å†…éƒ¨å¯¼èˆªæ•°æ®ç®¡ç†ï¼šä»…åœ¨æœªä¼ å…¥ props.sections æ—¶å¯ç”¨
const { sideNavSections: internalSections, fetchCategories } = useNavigation()

// ç»Ÿä¸€çš„å¯¼èˆªæ•°æ®å…¥å£ï¼šä¼˜å…ˆä½¿ç”¨ props.sectionsï¼Œå…¶æ¬¡ä½¿ç”¨ internalSections
const navigationSections = computed(() => {
  const arr = Array.isArray(props.sections) ? props.sections : []
  return arr.length ? arr : (internalSections?.value || [])
})

// å“åº”å¼çŠ¶æ€ç®¡ç†
const tokenRef = ref('')
const isLoggedIn = computed(() => !!(tokenRef.value && tokenRef.value.trim()))
const activeId = ref('site')
const contentRef = ref(null)
/**
 * forceLoadIdsï¼šå¼ºåˆ¶é¢„åŠ è½½é›†åˆï¼ˆå“åº”å¼ Setï¼‰
 * ç”¨é€”ï¼š
 * - é¦–å±ï¼šå¯¹â€œå¯è§åŒºåŸŸ + å°‘é‡é¢„å¤‡æ•°æ®â€çš„å¡ç‰‡ï¼ŒåŠ å…¥æ­¤é›†åˆä»¥å…³é—­æ‡’åŠ è½½ï¼Œç«‹å³åŠ è½½æ•°æ®ï¼›
 * - ç©ºé—²åå°ï¼šåœ¨æµè§ˆå™¨ç©ºé—²æ—¶é€æ­¥æŠŠåç»­å¡ç‰‡åŠ å…¥æ­¤é›†åˆï¼Œåå°é¢„å–ï¼Œæå‡åç»­æ»šåŠ¨ä½“éªŒï¼›
 * - ä¼˜å…ˆåŠ è½½ï¼šå½“ç”¨æˆ·ç‚¹å‡»æŸå¯¼èˆªé¡¹æ—¶ï¼ˆå·²é€šè¿‡ activeId è§¦å‘ï¼‰ï¼Œä¹Ÿå¯ä»¥å†ªç­‰åœ°åŠ å…¥é›†åˆä»¥ä¿è¯å³æ—¶åŠ è½½ã€‚
 * è¯´æ˜ï¼š
 * - Vue 3 å¯¹ Map/Set æœ‰åŸç”Ÿå“åº”å¼æ”¯æŒï¼›æ­¤å¤„ä½¿ç”¨ reactive(new Set()) ä»¥ç¡®ä¿æ¨¡æ¿ä¸­ has() èƒ½è§¦å‘æ›´æ–°ï¼›
 */
const forceLoadIds = reactive(new Set())

/**
 * é¢„å–å‚æ•°ï¼ˆå¯æŒ‰éœ€å¾®è°ƒï¼‰ï¼š
 * - INITIAL_PREFETCHï¼šåˆå§‹åŠ è½½çš„â€œå°‘é‡é¢„å¤‡æ•°æ®â€æ•°é‡ï¼ˆé™¤å½“å‰æ´»è·ƒå¡ç‰‡å¤–ï¼‰ï¼›
 * - IDLE_CHUNKï¼šåå°ç©ºé—²æ¯æ¬¡é¢„å–çš„å¡ç‰‡æ•°é‡ï¼›
 */
const INITIAL_PREFETCH = 3
const IDLE_CHUNK = 2

/**
 * allCardIdsï¼šæŒ‰æ¸²æŸ“é¡ºåºæ‰å¹³åŒ–åçš„å¡ç‰‡ id åˆ—è¡¨
 * ç»“æ„ï¼šä¼˜å…ˆä½¿ç”¨ props.sectionsï¼ˆä¿è¯ä¸ä¾§æ ä¸€è‡´ï¼‰ï¼Œæœ‰å­åˆ†ç±»åˆ™å–å­åˆ†ç±» idï¼Œå¦åˆ™å–çˆ¶åˆ†ç±» id
 */
const allCardIds = computed(() => {
  const res = []
  const sections = navigationSections.value || []
  for (const s of sections) {
    if (s?.children?.length) {
      for (const c of s.children) {
        if (c?.id) res.push(c.id)
      }
    } else {
      if (s?.id) res.push(s.id)
    }
  }
  return res
})

// èƒŒæ™¯ç©ºé—²è°ƒåº¦å¥æŸ„ï¼ˆå…¼å®¹ rIC ä¸ setTimeoutï¼‰ä¸è¿›åº¦ç´¢å¼•
let idleHandle = null
const prefetchIndex = ref(0)

/**
 * åˆå§‹åŒ–åˆ†å±‚é¢„åŠ è½½ï¼š
 * - å°†å½“å‰æ´»è·ƒé¡¹ä¸å‰è‹¥å¹²ä¸ªå¡ç‰‡åŠ å…¥ forceLoadIdsï¼Œç«‹å³åŠ è½½ï¼›
 * - å¯åŠ¨åå°ç©ºé—²é¢„å–ï¼Œåœ¨ä¸æ‰“æ‰°ä¸»çº¿ç¨‹çš„æƒ…å†µä¸‹é€æ­¥åŠ è½½å‰©ä½™å¡ç‰‡ã€‚
 */
function initLayeredPrefetch(){
  try {
    // 1) å½“å‰æ´»è·ƒé¡¹ä¼˜å…ˆï¼šç‚¹å‡»/é»˜è®¤é€‰ä¸­é¡¹å¿…é¡»ç«‹å³åŠ è½½
    if (activeId.value) forceLoadIds.add(activeId.value)

    // 2) åˆå§‹å°‘é‡é¢„å¤‡æ•°æ®ï¼šæŒ‰æ¸²æŸ“é¡ºåºé€‰å–å‰ N ä¸ªå¡ç‰‡
    const ids = allCardIds.value
    prefetchIndex.value = 0
    const take = Math.min(INITIAL_PREFETCH, Math.max(0, ids.length - prefetchIndex.value))
    for (let i = 0; i < take; i++) {
      const id = ids[prefetchIndex.value++]
      if (id) forceLoadIds.add(id)
    }

    // 3) å¯åŠ¨ç©ºé—²åå°é¢„å–ï¼šé€å—å°†åç»­å¡ç‰‡åŠ å…¥é¢„å–é›†åˆ
    startIdlePrefetch()
  } catch (e) {
    console.warn('åˆå§‹åŒ–åˆ†å±‚é¢„åŠ è½½å¤±è´¥ï¼Œç»§ç»­å¸¸è§„æ‡’åŠ è½½ï¼š', e)
  }
}

/**
 * ç©ºé—²åå°é¢„å–ï¼šåœ¨æµè§ˆå™¨ç©ºé—²æ—¶é€æ­¥åŠ è½½åç»­å¡ç‰‡
 * ç­–ç•¥ï¼šæ¯æ¬¡ç©ºé—²æœŸåŠ å…¥å°‘é‡ï¼ˆIDLE_CHUNKï¼‰å¡ç‰‡åˆ° forceLoadIdsï¼Œç›´åˆ°è€—å°½
 * å…¼å®¹ï¼šä¼˜å…ˆä½¿ç”¨ requestIdleCallbackï¼Œè‹¥ä¸å¯ç”¨åˆ™å›é€€ setTimeout
 */
function startIdlePrefetch(){
  const ids = allCardIds.value
  const runner = (deadline) => {
    try {
      let added = 0
      while (added < IDLE_CHUNK && prefetchIndex.value < ids.length) {
        const id = ids[prefetchIndex.value++]
        if (id && !forceLoadIds.has(id)) {
          forceLoadIds.add(id)
          added++
        }
        // è‹¥å‰©ä½™ç©ºé—²æ—¶é—´ä¸è¶³åˆ™æå‰é€€å‡ºï¼Œç•™åˆ°ä¸‹ä¸€è½®
        if (deadline && typeof deadline.timeRemaining === 'function' && deadline.timeRemaining() < 8) {
          break
        }
      }
    } catch (e) {
      // å¿½ç•¥ï¼Œä¿æŒåç»­è½®æ¬¡ç»§ç»­
    } finally {
      // è‹¥å°šæœªè¦†ç›–å…¨éƒ¨å¡ç‰‡ï¼Œç»§ç»­å®‰æ’ä¸‹ä¸€è½®
      if (prefetchIndex.value < ids.length) {
        scheduleNextIdle()
      } else {
        idleHandle = null
      }
    }
  }

  function scheduleNextIdle(){
    try {
      if ('requestIdleCallback' in window) {
        idleHandle = window.requestIdleCallback(runner, { timeout: 1200 })
      } else {
        // å›é€€ä¸ºè½»é‡å®šæ—¶å™¨ï¼Œé¿å…å ç”¨ä¸»çº¿ç¨‹ï¼šå»¶è¿Ÿä¸€æ®µæ—¶é—´å†æ‰§è¡Œä¸€å°å—
        idleHandle = setTimeout(() => runner(), 800)
      }
    } catch (e) {
      // æç«¯ç¯å¢ƒï¼šç›´æ¥åŒæ­¥æ¨è¿›å°‘é‡ï¼Œé¿å…å®Œå…¨åœæ»
      runner()
    }
  }

  scheduleNextIdle()
}

// å·¥å…·å‡½æ•°ï¼šåˆ·æ–°ç™»å½•çŠ¶æ€
function refreshAuth(){
  try{ 
    tokenRef.value = String(getToken() || '') 
  } catch { 
    tokenRef.value = '' 
  }
}

// æ»šåŠ¨æ§åˆ¶å‡½æ•°ï¼šè·å–æ»šåŠ¨å®¹å™¨
function getScrollContainer(){
  const base = contentRef.value
  if (!base) return null
  let el = base
  while (el && el !== document.body){
    try{
      const s = getComputedStyle(el)
      const oy = String(s.overflowY || '').toLowerCase()
      if (oy === 'auto' || oy === 'scroll') return el
    }catch{ /* å¿½ç•¥å¼‚å¸¸ï¼Œç»§ç»­å‘ä¸ŠæŸ¥æ‰¾ */ }
    el = el.parentElement
  }
  return base
}

// æ»šåŠ¨åˆ°æŒ‡å®šé”šç‚¹
function scrollTo(id){
  // æå‰è®¾ç½®æ´»è·ƒé¡¹ï¼šè®©ç›®æ ‡å¡ç‰‡åœ¨æœ¬æ¬¡ç‚¹å‡»æ—¶ç«‹å³å…³é—­æ‡’åŠ è½½å¹¶è§¦å‘æ•°æ®åŠ è½½
  // è¯´æ˜ï¼šè¿™ä¸€æ­¥ä½¿å¾— NavigationSiteList æ”¶åˆ° deferLoad=falseï¼Œä»è€Œåœ¨ watch ä¸­ç«‹åˆ»è°ƒç”¨ loadSites()
  // è¿™æ ·æ—¢ä¿ç•™æ•´ä½“æ‡’åŠ è½½ç­–ç•¥ï¼Œåˆä¿è¯â€œç‚¹å‡»å³åŠ è½½ã€æ»šåŠ¨å³æœ‰å†…å®¹â€ï¼Œé¿å…ç©ºç™½å¡ç‰‡ä½“éªŒã€‚
  activeId.value = id
  try{ emit('update:activeId', id) }catch{}
  // å†ªç­‰åŠ å…¥å¼ºåˆ¶é¢„å–é›†åˆï¼šç¡®ä¿è¯¥å¡ç‰‡æ— è®ºæ‡’åŠ è½½çŠ¶æ€å¦‚ä½•éƒ½ç«‹å³åŠ è½½
  try { if (id) forceLoadIds.add(id) } catch {}

  const container = getScrollContainer()
  if (!container) return

  let el = (contentRef.value || container).querySelector('#' + id)
  /**
   * é”šç‚¹ç¼ºå¤±çš„é¦–æ¬¡ç‚¹å‡»ä¿æŠ¤ï¼ˆè¯¦ç»†æ³¨é‡Šï¼‰ï¼š
   * èƒŒæ™¯ï¼š
   * - å½“çˆ¶ç»„ä»¶çš„ sections åˆšä»â€œé»˜è®¤åå¤‡æ•°æ®â€åˆ‡æ¢ä¸ºâ€œåç«¯çœŸå®åˆ†ç±»æ•°æ®â€æ—¶ï¼Œ
   *   å³ä¾§å¡ç‰‡çš„ DOMï¼ˆå«é”šç‚¹ #idï¼‰å¯èƒ½å°šæœªå®Œæˆæ¸²æŸ“ï¼›
   * - æ­¤æ—¶ç¬¬ä¸€æ¬¡ç‚¹å‡»åº•éƒ¨å­å¯¼èˆªï¼ŒscrollTo ç«‹å³æŸ¥æ‰¾é”šç‚¹å¯èƒ½è¿”å› nullï¼Œ
   *   è‹¥ç›´æ¥é€€å‡ºï¼Œä¼šè®©åç»­é«˜äº®é€»è¾‘ä»¥â€œæœ€è¿‘é”šç‚¹â€å‘½ä¸­é”™è¯¯å¡ç‰‡ï¼Œå‡ºç°é”™ä½ã€‚
   * æ–¹æ¡ˆï¼š
   * - åœ¨é”šç‚¹æœªæ‰¾åˆ°æ—¶ï¼Œè¿›è¡ŒçŸ­æ—¶é‡è¯•ï¼ˆæœ€å¤š 8 æ¬¡ï¼Œæ¯æ¬¡ 60msï¼Œæ€»è®¡çº¦ 480msï¼‰ï¼Œ
   *   ç­‰å¾… Vue å®Œæˆæ¸²æŸ“ä¸ HMR æ›´æ–°ï¼Œç¡®ä¿é¦–æ¬¡ç‚¹å‡»ä¹Ÿèƒ½æ­£ç¡®æ»šåŠ¨åˆ°ç›®æ ‡å¡ç‰‡ã€‚
   * - è‹¥é‡è¯•åä»ä¸å­˜åœ¨ï¼Œåˆ™ä¼˜é›…é€€å‡ºï¼Œä¸åšé”™è¯¯æ»šåŠ¨ã€‚
   */
  if (!el){
    let attempts = 0
    const max = 8
    const timer = setInterval(() => {
      try{
        el = (contentRef.value || container).querySelector('#' + id)
        if (el || attempts >= max){ clearInterval(timer) }
        if (el){
          // æ‰¾åˆ°é”šç‚¹åæ‰§è¡Œæ»šåŠ¨ï¼ˆä¸ä¸‹æ–¹é€»è¾‘ä¸€è‡´ï¼‰
          const isScrollableContent = container.classList?.contains('scrollable-content')
          const isContentScroll = container.classList?.contains('content-scroll')
          const containerStyles = getComputedStyle(container)
          const containerPadTop = parseFloat(containerStyles.paddingTop || '0')
          let offset = containerPadTop
          offset += (isScrollableContent || isContentScroll) ? 16 : ((document.querySelector('.square-header')?.offsetHeight || 0) + 24)
          const elRect = el.getBoundingClientRect()
          const containerRect = container.getBoundingClientRect()
          const visibleDelta = elRect.top - containerRect.top
          const targetTop = Math.max(0, container.scrollTop + visibleDelta - offset)
          container.scrollTo({ top: targetTop, behavior: 'smooth' })
          activeId.value = id
          try{ emit('update:activeId', id) }catch{}
        }
        attempts++
      }catch{ attempts++ }
    }, 60)
    return
  }

  // ä¿®å¤æ»šåŠ¨åç§»è®¡ç®—ï¼šé’ˆå¯¹ TwoPaneLayout å¸ƒå±€ä¼˜åŒ–
  // è¯´æ˜ï¼š
  // - åœ¨ TwoPaneLayout ä¸­ï¼Œ.square-header ä¸å¡ç‰‡å†…å®¹éƒ½åœ¨åŒä¸€ä¸ª .scrollable-content å®¹å™¨å†…ï¼›
  // - æ ‡é¢˜ä¸ä¼š"é®æŒ¡"å¡ç‰‡ï¼Œå› ä¸ºå®ƒä»¬æ˜¯å‚ç›´æ’åˆ—çš„ï¼Œæ ‡é¢˜åœ¨ä¸Šæ–¹ï¼Œå¡ç‰‡åœ¨ä¸‹æ–¹ï¼›
  // - å› æ­¤ä¸éœ€è¦å‡å»æ ‡é¢˜é«˜åº¦ï¼Œåªéœ€è¦ä¸€ä¸ªå°çš„å®‰å…¨é—´è·å³å¯ã€‚
  const isScrollableContent = container.classList?.contains('scrollable-content')
  const isContentScroll = container.classList?.contains('content-scroll')
  const containerStyles = getComputedStyle(container)
  const containerPadTop = parseFloat(containerStyles.paddingTop || '0')
  
  // è®¾ç½®åˆé€‚çš„å®‰å…¨é—´è·ï¼š
  // - åœ¨ TwoPaneLayout çš„å³ä¾§æ»šåŠ¨å®¹å™¨ï¼ˆ.scrollable-contentï¼‰æˆ–æœ¬ç»„ä»¶å†…éƒ¨æ»šåŠ¨å®¹å™¨ï¼ˆ.content-scrollï¼‰ä¸­ï¼Œ
  //   éƒ½ä¸éœ€è¦å‡å»æ ‡é¢˜é«˜åº¦ï¼ˆå› ä¸ºæ ‡é¢˜ä¸åœ¨è¿™äº›æ»šåŠ¨å®¹å™¨å†…ï¼‰ï¼Œä»…ä¿ç•™è¾ƒå°çš„å®‰å…¨é—´è· (16px)ã€‚
  // - ä»…å½“æ»šåŠ¨å®¹å™¨ä¸æ˜¯ä¸Šè¿°ä¸¤è€…æ—¶ï¼Œæ‰å›é€€ä¸ºâ€œæ ‡é¢˜é«˜åº¦ + 24pxâ€çš„å…¼å®¹é€»è¾‘ã€‚
  let offset = containerPadTop
  if (isScrollableContent || isContentScroll) {
    // ç»Ÿä¸€å¤„ç†ï¼šå½“å‰æ»šåŠ¨å®¹å™¨ä¸åŒ…å« .square-headerï¼Œæ— éœ€æ‰£å‡æ ‡é¢˜é«˜åº¦
    offset += 16
  } else {
    // å…¶ä»–å¸ƒå±€ï¼šä¿æŒåŸæœ‰é€»è¾‘ï¼ˆå‘åå…¼å®¹ï¼‰
    const titleEl = document.querySelector('.square-header')
    const titleH = titleEl ? titleEl.offsetHeight : 0
    offset += titleH + 24
  }

  // åŸºäºå¯è§ä½ç½®è®¡ç®—æ»šåŠ¨è·ç¦»
  const elRect = el.getBoundingClientRect()
  const containerRect = container.getBoundingClientRect()
  const visibleDelta = elRect.top - containerRect.top
  const targetTop = Math.max(0, container.scrollTop + visibleDelta - offset)
  
  container.scrollTo({ top: targetTop, behavior: 'smooth' })

  // æ›´æ–°æ´»è·ƒé¡¹å¹¶é€šçŸ¥çˆ¶ç»„ä»¶ï¼ˆå†ªç­‰ï¼šå‰é¢å·²è®¾ç½®ä¸€æ¬¡ï¼Œè¿™é‡Œä¿æŒä¸€è‡´ï¼‰
  activeId.value = id
  try{ emit('update:activeId', id) } catch { /* å¿½ç•¥å¼‚å¸¸ä»¥ä¿è¯æ»šåŠ¨ç¨³å®š */ }
}

// æ»šåŠ¨é«˜äº®å¤„ç†
function handleScroll(){
  const container = getScrollContainer()
  if (!container) return

  // ä¿®å¤æ»šåŠ¨åç§»è®¡ç®—ï¼šä¸ scrollTo æ–¹æ³•ä¿æŒä¸€è‡´
  // è¯´æ˜ï¼šé«˜äº®åˆ¤æ–­çš„åç§»é‡åº”è¯¥ä¸æ»šåŠ¨å®šä½çš„åç§»é‡ä¸€è‡´ï¼Œç¡®ä¿äº¤äº’çš„è¿è´¯æ€§
  const isScrollableContent = container.classList?.contains('scrollable-content')
  const isContentScroll = container.classList?.contains('content-scroll')
  const containerStyles = getComputedStyle(container)
  const containerPadTop = parseFloat(containerStyles.paddingTop || '0')
  
  // ä½¿ç”¨ä¸ scrollTo ç›¸åŒçš„åç§»è®¡ç®—é€»è¾‘
  let offset = containerPadTop
  if (isScrollableContent || isContentScroll) {
    // å½“å‰æ»šåŠ¨å®¹å™¨ä¸åŒ…å«æ ‡é¢˜ï¼Œä¿æŒè¾ƒå°å®‰å…¨é—´è·
    offset += 16
  } else {
    // å…¶ä»–å¸ƒå±€ï¼šä¿æŒåŸæœ‰é€»è¾‘
    const titleEl = document.querySelector('.square-header')
    const titleH = titleEl ? titleEl.offsetHeight : 0
    offset += titleH + 24
  }

  // æ”¶é›†æ‰€æœ‰é”šç‚¹å…ƒç´ 
  const nodes = []
  // ä½¿ç”¨ç»Ÿä¸€çš„å¯¼èˆªæ•°æ®ï¼ˆprops.sections ä¼˜å…ˆï¼‰è¿›è¡Œé«˜äº®è®¡ç®—
  if (navigationSections.value) {
    for (const section of navigationSections.value) {
      const elTop = (contentRef.value || container).querySelector('#' + section.id)
      if (elTop) nodes.push({ id: section.id, el: elTop })
      
      if (section.children && section.children.length) {
        for (const child of section.children) {
          const elChild = (contentRef.value || container).querySelector('#' + child.id)
          if (elChild) nodes.push({ id: child.id, el: elChild })
        }
      }
    }
  }

  // è®¡ç®—æœ€æ¥è¿‘çš„é”šç‚¹
  const containerRect = container.getBoundingClientRect()
  let current = navigationSections.value?.[0]?.id || 'site'
  let minDelta = Infinity
  
  for (const n of nodes) {
    const elRect = n.el.getBoundingClientRect()
    const visibleDelta = elRect.top - containerRect.top
    const delta = Math.abs(visibleDelta - offset)
    if (delta < minDelta) { 
      minDelta = delta
      current = n.id 
    }
  }

  // æ›´æ–°çŠ¶æ€
  activeId.value = current
  try { 
    emit('update:activeId', current) 
  } catch { 
    /* å¿½ç•¥å¼‚å¸¸ï¼Œç¡®ä¿æ»šåŠ¨æµç•… */ 
  }
}

// é¡µé¢æŒ‚è½½æ—¶çš„åˆå§‹åŒ–
onMounted(async () => {
  // è‹¥æœªä¼ å…¥ sectionsï¼Œåˆ™åŠ è½½å¯¼èˆªåˆ†ç±»æ•°æ®ä»¥æä¾›åå¤‡æ¸²æŸ“
  if (!(Array.isArray(props.sections) && props.sections.length)){
    await fetchCategories()
  }
  
  // åˆå§‹åŒ–ç™»å½•çŠ¶æ€
  refreshAuth()
  
  // æ·»åŠ äº‹ä»¶ç›‘å¬
  const onHashChange = () => refreshAuth()
  const onVisibilityChange = () => { 
    if (!document.hidden) refreshAuth() 
  }
  
  window.addEventListener('hashchange', onHashChange)
  window.addEventListener('visibilitychange', onVisibilityChange)
  
  // è½»é‡è½®è¯¢ç¡®ä¿ç™»å½•çŠ¶æ€åŒæ­¥
  const authPoller = setInterval(refreshAuth, 1000)
  
  // è·¯ç”±å˜åŒ–ç›‘å¬
  watch(() => route && route.fullPath, () => refreshAuth())
  
  // æ»šåŠ¨ç›‘å¬
  const container = getScrollContainer()
  if (container) { 
    container.addEventListener('scroll', handleScroll, { passive: true })
  }

  // åˆå§‹åŒ–åˆ†å±‚é¢„åŠ è½½ï¼šé¦–å±å°‘é‡ + ç©ºé—²åå°
  initLayeredPrefetch()
  
  // æ¸…ç†å‡½æ•°
  onUnmounted(() => {
    window.removeEventListener('hashchange', onHashChange)
    window.removeEventListener('visibilitychange', onVisibilityChange)
    clearInterval(authPoller)
    if (container) {
      container.removeEventListener('scroll', handleScroll)
    }
    // é‡Šæ”¾åå°é¢„å–è°ƒåº¦å¥æŸ„
    try {
      if (idleHandle && 'cancelIdleCallback' in window) {
        window.cancelIdleCallback(idleHandle)
      } else if (idleHandle) {
        clearTimeout(idleHandle)
      }
    } catch {}
  })
})

// æš´éœ²æ–¹æ³•ç»™çˆ¶ç»„ä»¶
defineExpose({
  scrollTo
})
</script>

<style scoped>
.container {
  height: 100%;
  display: flex;
  flex-direction: column;

  /* å±€éƒ¨è¦†ç›–å…¨å±€ .container çš„å±…ä¸­å®šå®½è§„åˆ™
     èƒŒæ™¯ï¼š
     - å…¨å±€ style.css ä¸º .container è®¾å®šäº† max-width:1080px ä¸ margin: 24px autoï¼›
       è¿™ä¼šå¯¼è‡´æœ¬ç»„ä»¶æ ¹å®¹å™¨è¢«å®šå®½å¹¶æ°´å¹³å±…ä¸­ï¼Œä»è€Œåœ¨å³ä¾§åˆ—äº§ç”Ÿä¸¤ä¾§ç©ºç™½ã€‚
     ç›®æ ‡ï¼š
     - å¹¿åœºæ­£æ–‡éœ€è¦â€œé“ºæ»¡çˆ¶å®¹å™¨å®½åº¦â€ï¼Œä¸å—å…¨å±€è§„åˆ™å½±å“ï¼›
     å¤„ç†ï¼š
     - åœ¨ scoped æ ·å¼ä¸­æ˜¾å¼è¦†ç›–å®½åº¦ã€æœ€å¤§å®½åº¦ä¸å¤–è¾¹è·ï¼›
     - åŒæ—¶ç§»é™¤å·¦å³ paddingï¼Œæ”¹ç”±å†…éƒ¨ .square-header/.content-scroll æ§åˆ¶è‡ªèº«å®‰å…¨è¾¹è·ã€‚
   */
  width: 85%;          /* å æ»¡çˆ¶å®¹å™¨å¯ç”¨å®½åº¦ */
  max-width: none;      /* å–æ¶ˆ 1080px ä¸Šé™ */
  padding: 0px;           /* ç§»é™¤å…¨å±€å·¦å³ 16px å†…è¾¹è· */
}

.square-header {
  /* æ ‡é¢˜åŒºå¡ç‰‡åŒ–ï¼šæŸ”å’Œæ¸å˜èƒŒæ™¯ + åœ†è§’ + è½»é˜´å½±
     è¯´æ˜ï¼š
     - ç”¨æµ…è‰²æ¸å˜æå‡å±‚æ¬¡ï¼ŒåŒæ—¶ä¿æŒæ•´ä½“æ¸…çˆ½ï¼›
     - åœ†è§’ä¸é˜´å½±ä»…åœ¨æ ‡é¢˜åŒºå†…ï¼Œé¿å…å½±å“å³ä¾§æ»šåŠ¨å®¹å™¨ï¼›
     - ä¿ç•™ flex-shrink é˜²æ­¢æ»šåŠ¨æ—¶è¢«å‹ç¼©ã€‚ */
  padding: 16px 24px;
  background: linear-gradient(180deg, #f9fbff 0%, #ffffff 100%);
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  box-shadow: 0 8px 24px -12px rgba(31, 41, 55, 0.25);
  flex-shrink: 0;
}

.brand {
  /* æ ‡é¢˜è¡Œï¼šå›¾æ ‡ + æ–‡æœ¬å— */
  display: flex;
  align-items: center;
  gap: 14px;
}

/* å“ç‰Œå›¾æ ‡å®¹å™¨ï¼šç‹¬ç«‹çš„åœ†è§’å¡ç‰‡ï¼Œå¢å¼ºè¯†åˆ«åº¦ */
.logo-wrap {
  width: 40px;
  height: 40px;
  display: grid;           /* å±…ä¸­å›¾æ ‡ */
  place-items: center;
  background: #ffffff;
  border: 1px solid #e6effa;
  border-radius: 12px;
  box-shadow: 0 6px 18px -10px rgba(64, 158, 255, 0.35);
}

/* æ–‡æœ¬å—ï¼šä¸»æ ‡é¢˜ + å‰¯æ ‡é¢˜ */
.title-wrap { display: flex; flex-direction: column; }

/* æ¸å˜ä¸»æ ‡é¢˜ï¼šä½¿ç”¨èƒŒæ™¯è£å‰ªå®ç°æŸ”å’Œå“ç‰Œè‰²è¿‡æ¸¡ */
.title {
  margin: 0;
  font-size: 22px;
  font-weight: 700;
  line-height: 1.2;
  /* æ¸å˜æ–‡æœ¬ï¼šä» #409eff è¿‡æ¸¡åˆ°æ›´æµ…çš„å“ç‰Œè‰² */
  background-image: linear-gradient(90deg, #409eff 0%, #67a6ff 50%, #a0cfff 100%);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;          /* è®©æ¸å˜ä½œä¸ºæ–‡æœ¬å¡«å…… */
  letter-spacing: 0.2px;
}

/* å‰¯æ ‡é¢˜ï¼šä½å¯¹æ¯”åº¦æç¤ºè¯­ï¼Œå‡å°‘è§†è§‰è´Ÿæ‹… */
.subtitle {
  margin: 4px 0 0;
  font-size: 13px;
  color: #6b7280;
}

.layout {
  flex: 1;
  overflow: hidden;
}

.content-scroll {
  height: 100%;
  /* å³ä¾§å¡ç‰‡åŒºæ»šåŠ¨å®¹å™¨ï¼šä¿æŒæ»šåŠ¨ï¼Œä½†éšè—æ»šåŠ¨æ¡
     éœ€æ±‚ï¼š
     - â€œå¡ç‰‡çš„æ»šåŠ¨æ¡éšè—â€ï¼ŒæŒ‡ç”¨æˆ·ä¸å¸Œæœ›çœ‹åˆ°å‚ç›´æ»šåŠ¨æ¡å ä½å½±å“è§†è§‰ï¼›
     - ä¿æŒæ»šåŠ¨åŠŸèƒ½ï¼Œé‡‡ç”¨å„æµè§ˆå™¨çš„éšè—æ»šåŠ¨æ¡æ–¹æ¡ˆï¼š
       * WebKitï¼ˆChrome/Edge/Safariï¼‰ï¼š::-webkit-scrollbar å®½é«˜è®¾ä¸º 0ï¼›
       * Firefoxï¼šscrollbar-width: noneï¼›
       * æ—§ç‰ˆ IE/Edgeï¼š-ms-overflow-style: noneï¼›
     æ³¨æ„ï¼šå¦‚æœæŸäº›å¹³å°ä»æ˜¾ç¤ºæ»šåŠ¨æŒ‡ç¤ºï¼Œå¯è€ƒè™‘åœ¨å®¹å™¨å†…å¢åŠ é¢å¤–çš„å†…è¾¹è·ä»¥å¼±åŒ–è§†è§‰å¹²æ‰°ã€‚
   */
  overflow-y: auto;
  padding: 4px;
  scroll-behavior: smooth;
}

/* éšè—æ»šåŠ¨æ¡ï¼ˆå„æµè§ˆå™¨å…¼å®¹æ–¹æ¡ˆï¼‰ */
.content-scroll::-webkit-scrollbar { width: 0; height: 0; }
.content-scroll { scrollbar-width: none; -ms-overflow-style: none; }

/* ç©ºçŠ¶æ€å®¹å™¨ï¼šå‚ç›´å±…ä¸­ï¼Œä¿æŒå†…å®¹å±…ä¸­å¯¹é½ */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 400px;
  text-align: center;
  color: #6b7280;
}

.empty-icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.empty-title {
  font-size: 18px;
  font-weight: 500;
  margin-bottom: 8px;
  color: #374151;
}

/* ç©ºçŠ¶æ€æè¿°ï¼šä½å¯¹æ¯”åº¦ã€ä¸­ç­‰å®½åº¦ï¼Œä¿æŒå¯è¯»æ€§ */
.empty-desc {
  font-size: 14px;
  max-width: 400px;
  line-height: 1.5;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .content-scroll {
    padding: 16px;
  }
  
  .square-header {
    /* ç§»åŠ¨ç«¯ï¼šæ”¶æ•›å†…è¾¹è·ä¸é˜´å½±å¤§å°ï¼Œé¿å…å–§å®¾å¤ºä¸» */
    padding: 12px 16px;
    box-shadow: 0 6px 18px -12px rgba(31, 41, 55, 0.25);
  }
  
  .title { font-size: 18px; }
}
</style>
