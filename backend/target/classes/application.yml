server:
  port: 8080
  # 统一请求/响应的字符编码为 UTF-8，避免中文在纯文本响应或老旧客户端下出现乱码
  servlet:
    encoding:
      charset: UTF-8
      enabled: true
      force: true
spring:
  datasource:
    # 使用 UTF-8 作为 JDBC 连接字符集；数据库与表应配置为 utf8mb4 以支持 Emoji
    url: jdbc:mysql://localhost:3306/yunbq?useUnicode=true&characterEncoding=utf8&serverTimezone=UTC&useSSL=false
    username: root
    password: root
    driver-class-name: com.mysql.cj.jdbc.Driver
  jackson:
    # 使用默认的 camelCase 命名策略，确保与前端字段名一致
    # API 返回的 JSON 字段名将是 camelCase 格式（如 userId, createdAt）
    # 配合 MyBatis 的 map-underscore-to-camel-case: true 实现完整的字段映射
    date-format: yyyy-MM-dd'T'HH:mm:ss.SSS'Z'
    time-zone: UTC
  sql:
    init:
      mode: always
      schema-locations: classpath:schema.sql
  servlet:
    multipart:
      max-file-size: 5MB
      max-request-size: 5MB
  data:
    redis:
      host: localhost
      port: 6379
      # password: your_redis_password
      timeout: 2000
  mail:
    host: "smtp.163.com"
    port: 465
    username: "your_163_email@163.com"
    password: "your_163_password"
    properties:
      mail:
        smtp:
          auth: true
          ssl:
            enable: true
          starttls:
            enable: false
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      id-type: auto
      logic-delete-field: deleted
      logic-delete-value: 1
      logic-not-delete-value: 0
jwt:
  secret: "change-this-secret-to-a-long-random-string"
  issuer: "yunbq"
  expire-minutes: 1440

frontend:
  # 前端公网地址（Cloudflare Tunnel 域名）：用于 OAuth 回跳到前端回调页
  # 说明：后端在完成 QQ 授权并生成站内 JWT 后，将 302 重定向到
  #       `${frontend.base-url}/#/oauth/callback?token=...`，因此此处必须写公网可访问的前端域名。
  base-url: "https://app.shiyan.online"

oauth:
  qq:
    app-id: "your_app_id"
    app-key: "your_app_key"
    # QQ 授权回调地址（公网）：必须与 QQ 互联平台设置完全一致（协议/域名/路径）
    # 通过 Cloudflare Tunnel 将外网 `https://api.shiyan.online` 映射到本机 `http://localhost:8080`
    redirect-uri: "https://api.shiyan.online/api/auth/qq/callback"
  wechat:
    app-id: ""
    secret: ""
    redirect-uri: "http://localhost:8080/api/auth/wechat/callback"
cache:
  notes:
    hot-ttl-seconds: 60
    recent-ttl-seconds: 20
cors:
  allowed-origins:
    # 允许的跨域来源：前端开发与公网站点
    - "http://localhost:5500"
    - "http://localhost:5173"
    - "https://app.shiyan.online"
    - "https://api.shiyan.online"
  allowed-origin-patterns:
    - "http://localhost:*"
    # 为所有 HTTPS 子域（如 app.shiyan.online、api.shiyan.online）启用跨域匹配
    # 说明：若未来调整子域（如 m.shiyan.online、www.shiyan.online），无需逐一添加到 allowed-origins
    # 注意：当 allowCredentials=true 时，不能使用 "*"，需使用 patterns 精确匹配
    - "https://*.shiyan.online"
    # 新增：允许所有 HTTP 子域（如 http://app.shiyan.online）
    # 说明：从控制台日志可见请求的 Origin 为 http://app.shiyan.online，未命中 HTTPS 通配导致 403；
    # 若你后续将前端页面切换到 HTTPS（推荐），可移除此项以提升整体安全性。
    - "http://*.shiyan.online"
  allowed-methods:
    - GET
    # 一些浏览器/代理会先发起 HEAD 探测请求；未放行 HEAD 可能导致 403
    - HEAD
    - POST
    - PUT
    - DELETE
    - OPTIONS
    # 说明：前端管理员页面的“禁用/启用”操作使用 PATCH 方法；
    # 如果不在 CORS 允许方法中声明 PATCH，浏览器会在预检（OPTIONS）阶段直接拦截，
    # 导致实际请求无法到达后端并出现 403 或“操作失败”的提示。
    - PATCH
  allowed-headers:
    - Authorization
    - Content-Type
    # 某些浏览器/前端库会自动携带该头，若未允许可能导致预检失败或被 CORS 拦截
    - X-Requested-With
logging:
  level:
    org.springframework.security: DEBUG
    com.yunbq.backend.security: DEBUG
  # 控制台日志包含 MDC（requestId），便于跨模块关联；生产环境可按需调整格式
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level [%thread] %logger{36} - %msg %mdc%n"

#
# Actuator 端点暴露与健康检查设置：
# - 暴露 /actuator/health 与 /actuator/info，便于部署与监控探测；
# - 健康检查细节在授权后显示（when_authorized），避免对外泄露过多信息；
# - 如需统一前缀，可设置 base-path: /ops（此处保留默认 /actuator）。
management:
  endpoints:
    web:
      exposure:
        include: health,info
      base-path: /actuator
  endpoint:
    health:
      show-details: when_authorized
      # 在开发环境下，避免因为某些可选依赖（如 Redis 未启动）导致整体状态为 DOWN，从而返回 503：
      # 将部分异常状态映射为 200，便于本地与前端联调。
      status:
        http-mapping:
          DOWN: 200
          OUT_OF_SERVICE: 200

  # 在开发环境下，如未启动 Redis，可关闭 Redis 健康检查以避免返回 503：
  # 生产环境请根据实际依赖选择开启/关闭。
  health:
    redis:
      enabled: false

# 日志数据库写入相关配置（LogProperties）
logdb:
  # 开关：按需开启/关闭各类日志
  request-enabled: true
  auth-enabled: true
  error-enabled: true
  audit-enabled: true
  # 请求日志采样百分比（0-100；100 表示全量写入）
  request-sampling-percent: 100
  # 保留天数：定期清理超期数据
  retention-request-days: 30
  retention-auth-days: 30
  retention-error-days: 90
  retention-audit-days: 90
  # 清理任务执行间隔（毫秒）：默认 1 小时
  retention-sweep-interval-ms: 3600000