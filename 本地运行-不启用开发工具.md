# 拾言（YunBQ）本地运行指南（不启用开发工具）

> 目标：在本地环境运行“打包后的后端 Jar + 生产构建的前端静态文件”，不启动任何前端/后端的开发服务器或热重载工具。本文提供纯本机与 Docker 两种方式，并给出端到端的校验方法与常见问题。

---

## 0、环境示例

- 操作系统：Windows 10/11 或 Linux（Ubuntu 22.04+）
- 工具链：`Java 17`、`Maven`、`Node.js 18+`、`npm`
- 数据与缓存：`MySQL 8`、`Redis 7`（可选）



## 1. 前置条件

- 已安装基础工具（任选其一或两者）：
  - 纯本机：`Java 17`、`Node.js 18+`、`npm`、`MySQL`（或使用 Docker 运行 MySQL/Redis）
  - Docker 本地：`Docker` 与 `Docker Compose`
- 数据库与缓存：
  - MySQL：本机或容器中可用，已创建数据库与用户权限
  - Redis：本机或容器中可用（默认端口 6379）
- 邮件（可选）：若需邮箱验证码功能，需要配置 SMTP（可跳过，仅不调用相关接口即可）

> 本文所有命令均为示例，端口与路径可按需调整。默认后端端口使用 `6639`，以与已有文档保持一致。

---

## 2. 快速路径 A：纯本机运行（不使用 Docker）

### 2.1 构建后端并运行 Jar（prod 配置）

```bash
# 进入后端目录
cd backend

# 说明：跳过测试打包，产物位于 target/*.jar
mvn -q -DskipTests package

# 说明：以 prod 配置运行，并显式传入必要参数
# - server.port：后端端口（本指南使用 6639）
# - spring.datasource.*：MySQL 连接（需提前创建数据库与用户）
# - spring.redis.*：Redis 连接（本机默认 6379）
# - jwt.secret：强度足够的密钥字符串
# - frontend.base-url：前端访问的根 URL（用于后端生成资源链接与校验）
java -jar target/backend-0.0.1-SNAPSHOT.jar \
  --spring.profiles.active=prod \
  --server.port=6639 \
  --spring.datasource.url=jdbc:mysql://localhost:3306/yunbq?useSSL=false&serverTimezone=UTC \
  --spring.datasource.username=yunbq_user \
  --spring.datasource.password=strong_password_here \
  --spring.redis.host=localhost \
  --spring.redis.port=6379 \
  --jwt.secret=please_replace_with_a_strong_secret \
  --frontend.base-url=http://localhost:5173
```

> 数据库初始化：
> - 自动建表（推荐）：启动时设置 `spring.sql.init.mode=always`，创建完成后改为 `never`
> - 手动建表：在 MySQL 执行 `backend/sql/init_schema.sql`

### 2.2 构建前端并作为静态文件提供

```bash
# 进入前端目录
cd ../frontend

# 安装依赖并进行生产构建
npm ci

# 说明：在生产构建前设置 API 基础地址，指向后端 6639 端口的 /api
# 方法 1：临时设置（仅当前 shell 有效）
# Windows PowerShell：
# $env:VITE_API_BASE="http://localhost:6639/api"
# Linux/macOS：
# export VITE_API_BASE="http://localhost:6639/api"

npm run build

# 说明：dist/ 为生产静态文件目录。将其作为静态站点提供即可。
# 使用轻量静态服务器（不会启用开发工具或热重载）
npx -y serve -s dist -l 5173

# 方式 2：使用 Nginx（如已安装）将 dist/ 作为根目录
# 请参考根目录文件：生产部署-Docker-Nginx.md（有完整 server 配置范例）
```

> 选择轻量静态服务器快速，无需额外配置；选择 Nginx 更接近生产环境（参考 `生产部署-Docker-Nginx.md`）。

### 2.3 访问与验证

- 浏览器打开前端：`http://localhost:5173`
- 后端接口健康检查：

```bash
# 简单检查后端服务是否存活（按需替换路径）
curl -i http://localhost:6639/api/health || curl -i http://localhost:6639/actuator/health
```

> 若项目未提供上述健康接口，可直接访问登录、用户信息等已有接口进行验证。

---

## 3. 快速路径 B：Docker 本地运行（不启用任何开发服务器）

> 如果使用 Docker，可将 MySQL、Redis 与后端、前端统一以 Compose 启动。下方为一个最小示例（本地验证）。

```yaml
# docker-compose.local.yml（示例）
version: "3.9"
services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_DATABASE: yunbq
      MYSQL_USER: yunbq_user
      MYSQL_PASSWORD: strong_password_here
      MYSQL_ROOT_PASSWORD: root_password_here
    ports:
      - "3306:3306"
    command: ["--default-authentication-plugin=mysql_native_password"]
    volumes:
      - ./data/mysql:/var/lib/mysql

  redis:
    image: redis:7
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis:/data

  backend:
    image: eclipse-temurin:17-jre
    container_name: yunbq-backend-local
    working_dir: /app
    volumes:
      - ./backend/target/backend-0.0.1-SNAPSHOT.jar:/app/app.jar:ro
    command: [
      "java","-jar","/app/app.jar",
      "--spring.profiles.active=prod",
      "--server.port=6639",
      "--spring.datasource.url=jdbc:mysql://mysql:3306/yunbq?useSSL=false&serverTimezone=UTC",
      "--spring.datasource.username=yunbq_user",
      "--spring.datasource.password=strong_password_here",
      "--spring.redis.host=redis",
      "--spring.redis.port=6379",
      "--jwt.secret=please_replace_with_a_strong_secret",
      "--frontend.base-url=http://localhost:5173"
    ]
    depends_on:
      - mysql
      - redis
    ports:
      - "6639:6639"

  frontend:
    image: nginx:alpine
    container_name: yunbq-frontend-local
    volumes:
      - ./frontend/dist:/usr/share/nginx/html:ro
      - ./nginx/local-nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "5173:80"
    depends_on:
      - backend
```

- 准备步骤：
  - 在宿主机完成后端打包：`cd backend && mvn -q -DskipTests package`
  - 在宿主机完成前端构建：
    - 设置 `VITE_API_BASE=http://localhost:6639/api`
    - `cd frontend && npm ci && npm run build`
  - 准备前端 Nginx 配置 `./nginx/local-nginx.conf`（最小示例）：

```nginx
server {
  listen 80;
  server_name localhost;

  # 前端静态资源
  root /usr/share/nginx/html;
  index index.html;

  location / {
    try_files $uri $uri/ /index.html;
  }
}
```

- 启动 Compose：

```bash
# 在项目根目录执行：
docker compose -f docker-compose.local.yml up -d
```

- 访问：前端 `http://localhost:5173`，后端 `http://localhost:6639/api`

> 生产化的 Docker+Nginx 配置请参考 `生产部署-Docker-Nginx.md` 与 `scripts/README.md`。

---

## 4. 端口与 URL 对齐规则

- 后端监听：`server.port=6639`
- 前端 API：`VITE_API_BASE=http://localhost:6639/api`
- 前端访问：
  - 纯本机静态服务器：`http://localhost:5173`
  - Docker 前端容器（Nginx）：`http://localhost:5173`

> 保证“前端访问域名/端口”与“VITE_API_BASE 指向的后端地址”一致且可达。

---

## 5. 数据库与缓存（本地）

- 若未安装 MySQL/Redis，可使用容器快速启动：

```bash
# MySQL（本地快速启动示例）
docker run -d --name mysql-local -p 3306:3306 \
  -e MYSQL_DATABASE=yunbq \
  -e MYSQL_USER=yunbq_user \
  -e MYSQL_PASSWORD=strong_password_here \
  -e MYSQL_ROOT_PASSWORD=root_password_here \
  mysql:8.0 --default-authentication-plugin=mysql_native_password

# Redis（本地快速启动示例）
docker run -d --name redis-local -p 6379:6379 redis:7
```

- 初始化表结构：参考 `backend/sql/init_schema.sql` 或在首次启动启用 `spring.sql.init.mode=always`。

---

## 6. 邮件服务（可选）

- 如需使用邮箱绑定与验证码功能，需要在后端启动参数或 `application-prod.yml` 中配置：
  - `spring.mail.host`、`spring.mail.port`、`spring.mail.username`、`spring.mail.password`
  - 邮件加密与端口（常见 465/587），以及发件人显示名（按需）

> 本地演示可跳过邮件功能，仅避免调用相关接口。

---

## 7. 常见问题与排查

- 页面能打开但接口 404 或 CORS 报错：
  - 检查 `VITE_API_BASE` 是否指向 `http://localhost:6639/api`
  - 后端是否已启动并监听 `6639` 端口；接口路径前缀是否为 `/api`
  - 若使用 Docker，确认端口映射与容器健康状态
- 邮件发送失败：
  - 检查 SMTP 配置、账号权限与加密端口；查看后端日志中的异常堆栈
- 头像或静态资源无法显示：
  - 确认后端返回的 `avatar_url` 可达；若为本地文件，请在 Nginx 或静态服务器正确映射路径
- JWT 相关报错：
  - 校验 `jwt.secret` 是否一致、长度足够；检查 Token 是否过期

---

## 8. 停止与清理

- 纯本机：
  - 静态服务器：在命令行按 `Ctrl+C` 结束
  - 后端 Jar：在命令行按 `Ctrl+C` 结束，或在任务管理器/命令行结束进程
- Docker：

```bash
# 停止并移除服务（保留数据卷）
docker compose -f docker-compose.local.yml down
```

---

## 9. 本地运行清单（不启用开发工具）

- 构建后端 Jar 并以生产参数运行（端口 6639）
- 设置前端 `VITE_API_BASE=http://localhost:6639/api` 并进行生产构建（生成 dist/）
- 用静态服务器或 Nginx 提供 `dist/`（端口 5173）
- 验证前后端连通与基础接口（如登录、查询用户信息）
- 可选：通过 Docker 统一编排本地 MySQL / Redis / 后端 / 前端

---

更多脚本与模板请参考 `scripts/README.md`。

---

## 10. 一键本地运行脚本（Windows/Linux）

- Windows：
  - 启动：`scripts/local-run/windows/build_and_run_local.ps1`
  - 停止：`scripts/local-run/windows/stop_local.ps1`
  - 说明：自动构建后端、启动 Jar（prod 配置）、构建前端并使用 `npx serve` 提供静态文件；写入 PID 并进行健康检查。
- Linux：
  - 启动：`scripts/local-run/linux/build_and_run_local.sh`
  - 停止：`scripts/local-run/linux/stop_local.sh`
  - 说明：与 Windows 类似，使用 `nohup` 后台运行并将日志写入 `logs/`。

> 脚本均包含详细注释与可配置参数，默认端口为后端 `6639`、前端 `5173`，并设置 `VITE_API_BASE=http://localhost:6639/api`。
