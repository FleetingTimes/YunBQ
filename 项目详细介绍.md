# YunBQ 项目详细介绍（架构、模块、配置、运行与运维）

> 本文面向开发、测试与运维人员，系统性介绍 YunBQ 项目的整体架构、核心模块、技术栈、配置项、运行与构建方式、部署与运维要点，以及安全与性能策略。阅读后应能独立完成本项目的开发、打包与生产部署。

---

## 1. 项目概览

YunBQ 是一个前后端分离的站点与内容管理平台，提供用户注册登录、资料管理、内容发布交互（如收藏、点赞）、导航站点归类展示、审计日志与请求日志记录、管理员后台等功能。

- 项目根目录：`e:\Trea_WorkSpace\YunBQ`
- 前端：`frontend/`（Vue 3 + Vite）
- 后端：`backend/`（Spring Boot 3 + Java 17）
- 数据库：MySQL（见 `backend/sql/*.sql` 与 `schema.sql`/迁移脚本）
- 缓存：Redis
- 部署：Nginx 反向代理 + Docker/Compose（可选），或直接运行 Jar
- 生产文档：`部署.md`、`生产部署-Docker-Nginx.md`、`生产上线完整清单.md`

---

## 2. 技术栈与版本

- 后端
  - `Java 17`
  - `Spring Boot 3.3.4`
  - `spring-boot-maven-plugin`（打包与运行）
  - 数据访问：`MyBatis-Plus`
  - 认证与授权：`JWT (jjwt)`
  - 缓存：`Redis`
  - 邮件：`Spring Mail`
  - CORS：按环境配置 `application-dev.yml` 与 `application-prod.yml`
- 前端
  - `Vue 3`、`Vue Router`
  - `Vite`（构建与开发服务器）
  - `Axios`（HTTP 客户端）
  - 环境变量：`import.meta.env.VITE_API_BASE`（API 基础 URL）
- 反向代理与部署
  - `Nginx`（静态托管、反向代理、TLS/HTTPS）
  - `Docker` 与 `Docker Compose`（可选）

---

## 3. 系统架构与目录结构

- 架构风格：前后端分离 + 反向代理（Nginx）
- 典型请求流：`浏览器 → Nginx(https) → 前端静态资源 → 后端 /api → 数据库/Redis`

```
YunBQ/
├── backend/                 # 后端工程（Spring Boot）
│   ├── pom.xml              # Maven 配置，含插件与依赖
│   ├── src/main/...         # 源代码（入口、配置、Controller、Service、Mapper 等）
│   ├── sql/*.sql            # 数据库建表与迁移脚本
│   ├── application*.yml     # 环境配置（dev/prod）
│   ├── uploads/avatars      # 默认头像上传目录（开发态）
│   └── target/              # 打包产物（Jar 等）
├── frontend/                # 前端工程（Vue + Vite）
│   ├── src/                 # 组件、视图、路由、API 等
│   ├── .env.development     # 开发环境变量（示例）
│   └── vite.config.js       # 构建配置
├── 部署.md                   # 部署实施指南（前后端、数据库、Nginx、远端运行）
├── 生产部署-Docker-Nginx.md   # Linux+Docker+Nginx 的生产部署配置与脚本
└── 生产上线完整清单.md        # 全面上线准备与核对清单
```

---

## 4. 后端设计概述

- 应用入口：`YunbqBackendApplication.java`
- 安全配置：`SecurityConfig.java`（静态资源、CORS、鉴权策略）
- 配置文件：`application.yml`、`application-dev.yml`、`application-prod.yml`
- 持久层：`MyBatis-Plus` Mapper + SQL 脚本（`backend/sql/*.sql`）
- 日志与审计：`audit_logs`、`request_logs`、`auth_logs`、`error_logs` 等表
- 静态资源与上传：默认 `uploads/avatars`（本地开发），生产建议挂载至持久卷或对象存储

### 4.1 认证与授权

- 采用 `JWT` 无状态认证，前端携带 `Authorization: Bearer <token>`
- 登录成功后返回 Token；后续请求以 Token 校验用户身份与权限
- CORS 与跨域策略：由 `application-*.yml` 控制（生产环境更严格）

### 4.2 典型功能模块

- 账户模块：用户信息查询、资料更新、头像上传、邮箱绑定与验证码、签名与昵称更新
- 管理模块：用户管理、导航分类与站点管理、操作审计、日志查询与导出
- 交互模块：点赞与收藏（`note_likes`、`note_favorites`）
- 导航模块：`navigation_categories` 与 `navigation_sites`（分类、标签、展示）

### 4.3 数据库模型（摘要）

- `users`：用户基础信息（含邮箱唯一约束、角色、签名、头像 URL）
- `navigation_categories` / `navigation_sites`：导航分类与站点信息
- `audit_logs` / `request_logs` / `auth_logs` / `error_logs`：系统日志与审计追踪
- 交互表：`note_likes`、`note_favorites`

> 完整字段请参考 `backend/sql/*.sql` 与数据库初始化脚本。

---

## 5. 前端设计概述

- 构建工具：`Vite`
- 框架：`Vue 3` + `Vue Router`
- HTTP 客户端：`Axios`（统一的实例在 `src/api/http.js` / `src/utils/http.js`）
- 环境变量：`VITE_API_BASE` 定义 API 基础 URL（默认回退 `http://localhost:8080/api`）
- 资源路径：头像与其他静态资源通过后端返回的 URL 拼接展示

### 5.1 环境变量示例

```env
# .env.development（开发态示例）
VITE_API_BASE=http://localhost:8080/api
# 可根据本机后端端口调整（仅示例）
```

```env
# .env.production（生产态建议示例）
VITE_API_BASE=https://your-domain.example.com/api
# 上线前需将域名与 TLS 证书在 Nginx 层完成配置
```

### 5.2 HTTP 客户端与 API

- `http.js` 中通过 `import.meta.env?.VITE_API_BASE` 读取 `API_BASE`
- 当 `VITE_API_BASE` 未设置时，回退至 `http://localhost:8080/api`
- 通过 `axios.create({ baseURL: API_BASE })` 创建统一客户端实例

---

## 6. 运行与构建

### 6.1 开发环境启动

```bash
# 后端（在 backend/）
# 说明：跳过测试进行编译；开发态也可直接在 IDE 运行 Main
mvn -q -DskipTests compile
mvn -q spring-boot:run

# 前端（在 frontend/）
# 说明：安装依赖并启动开发服务器，默认 http://localhost:5173
npm ci
npm run dev
```

- 前端默认会将请求代理到 `VITE_API_BASE` 指定的后端地址，开发时建议将其设置为 `http://localhost:8080/api`。

### 6.2 生产构建与打包

```bash
# 后端（在 backend/）
# 说明：跳过测试进行打包，产物位于 target/*.jar
git pull --rebase
mvn -q -DskipTests package
# 启动命令（示例）：
java -jar target/backend-0.0.1-SNAPSHOT.jar \
  --spring.profiles.active=prod \
  --server.port=6639 \
  --spring.datasource.url=jdbc:mysql://<db-host>:3306/<db-name>?useSSL=false&serverTimezone=UTC \
  --spring.datasource.username=<db-user> \
  --spring.datasource.password=<db-pass> \
  --spring.redis.host=<redis-host> \
  --spring.redis.port=6379 \
  --jwt.secret=<strong-secret> \
  --frontend.base-url=https://your-domain.example.com

# 前端（在 frontend/）
# 说明：基于 VITE_API_BASE 进行打包；产物在 dist/
npm ci
npm run build
```

> 更详细的生产部署命令与容器脚本请参考 `生产部署-Docker-Nginx.md` 与 `部署.md`。

---

## 7. 配置详解（后端 application.yml 关键项）

- `server.port`：服务端口（开发默认 8080，生产可按需调整，如 6639）
- `spring.datasource.*`：MySQL 连接信息
- `spring.redis.*`：Redis 连接信息
- `spring.mail.*`：邮件服务配置（用于发送邮箱绑定验证码等）
- `jwt.secret`：JWT 密钥（必须为高强度、保密）
- `frontend.base-url`：前端基础 URL（用于生成资源访问、跨域校验等）
- `cors`：跨域策略（`application-dev.yml` 与 `application-prod.yml` 中按环境设置）
- `logging.*`：日志级别与是否写入数据库（`audit_logs`/`request_logs` 等）

> 实际键名以 `application.yml` 为准，生产环境务必通过 `application-prod.yml` 或启动参数覆盖敏感配置。

---

## 8. 部署与运维概述

- Nginx 反向代理：提供静态资源托管与后端 `/api` 转发；生产强烈建议启用 HTTPS
- Docker/Compose：将 `mysql`、`redis`、`backend`、`nginx` 编排在一起，声明数据卷进行持久化
- 服务托管方式：
  - 直接运行 Jar（小型环境或快速验证）
  - `systemd`（Linux）或 `NSSM`（Windows）作为长期服务
  - `Docker Compose`（推荐）统一编排与生命周期管理

> 已提供一份可直接使用的生产示例，请参阅：`生产部署-Docker-Nginx.md`。

---

## 9. 安全与合规

- 强制使用 HTTPS 与 HSTS，避免 Token 在明文链路传输
- JWT 使用短期有效期与刷新策略；密钥使用环境变量或安全密钥管理
- 邮箱绑定与验证码：限制频率、过期时间与错误处理；避免暴力尝试
- 文件上传：校验文件类型与大小，存储在专用目录/对象存储，并限制访问路径
- 管理接口授权：区分 `admin` 与普通用户角色，配合操作审计
- SQL 注入与 XSS：参数校验与编码处理；严格使用绑定参数

---

## 10. 性能与伸缩

- 缓存：使用 Redis 做热点数据缓存与会话信息（如验证码、临时状态）
- 数据库优化：对高频查询添加索引；慢查询监控与分析
- 导出接口：分页与限速；对大数据量导出增加异步任务、分片或队列
- 前端优化：资源压缩与缓存策略（Cache-Control），CDN 可选

---

## 11. 日志与监控

- 应用日志：按级别输出并采集至审计表（`audit_logs`、`request_logs`、`error_logs` 等）
- 外部监控：建议接入 `Prometheus + Grafana` 或商业监控平台（可选）
- 告警：登录失败、接口异常率飙升、响应时间延迟等设阈值告警

---

## 12. 常见问题（FAQ）

- 前端无法请求后端？
  - 检查 `VITE_API_BASE` 是否正确，Nginx 代理是否将 `/api` 转发到后端实际端口，如 `6639`
  - 跨域策略是否允许对应来源（生产环境默认更严格）
- 邮件发送失败？
  - 检查 `spring.mail.*` 配置与 SMTP 凭证；留意端口与 TLS 要求
- 头像无法显示？
  - 确认后端 `avatar_url` 为可访问 URL，Nginx 静态映射或对象存储地址是否正确
- JWT 解析异常？
  - 核对 `jwt.secret` 与 Token 的签名算法版本；检查有效期与时钟偏差

---

## 13. 贡献与规范

- 代码风格：保持与现有项目一致（命名、分层、异常处理与日志）
- Javadoc 与注释：统一术语、分页/筛选/排序说明；导出接口需注明性能与安全注意事项
- 提交规范：尽量原子化提交，变更点清晰；必要时在 PR 描述中列出影响面
- 测试：为核心逻辑补充单元或集成测试；避免在无验证的情况下上线关键变更

---

## 14. 术语表

- `API_BASE`：前端请求后端接口的基础地址，由 `VITE_API_BASE` 提供
- `JWT`：JSON Web Token，无状态认证方式，用于携带用户身份
- `HSTS`：HTTP Strict Transport Security，强制客户端使用 HTTPS
- `CORS`：Cross-Origin Resource Sharing，跨域资源共享策略

---

## 15. 附录：API 调用示例（带注释）

```bash
# 获取当前用户信息（需要携带 JWT Token）
curl -sS -H "Authorization: Bearer <token>" \
  "https://your-domain.example.com/api/account/me"

# 更新昵称
curl -sS -X POST -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"nickname":"新昵称"}' \
  "https://your-domain.example.com/api/account/nickname"

# 发送绑定邮箱验证码（限频）
curl -sS -X POST -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com"}' \
  "https://your-domain.example.com/api/account/email/send-code"

# 确认绑定邮箱
curl -sS -X POST -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","code":"123456"}' \
  "https://your-domain.example.com/api/account/email/confirm"
```

> 更多管理员相关接口请参考后端 Controller 的 Javadoc 与接口定义。

---

## 16. 参考与延伸

- 部署实施步骤：`部署.md`
- 生产部署（Linux + Docker + Nginx，含自定义域名与端口）：`生产部署-Docker-Nginx.md`
- 上线完整清单（含安全、监控、备份、CI/CD 等）：`生产上线完整清单.md`
 - 本地运行（不启用开发工具）：`本地运行-不启用开发工具.md`

---

## 17. 快速上手（Checklist）

- 拉取代码并安装依赖（前后端）
- 配置数据库与 Redis；导入初始表结构
- 设置后端 `application-prod.yml` 与启动参数（含 `jwt.secret`）
- 配置前端 `VITE_API_BASE` 指向 Nginx `/api` 转发地址
- 构建前后端产物；部署至服务器或 Compose 编排
- 启用 HTTPS 与基础安全策略；完成健康检查与验收

---

如需将本文扩展为“含 80/443 标准端口 + 自动签证书（acme.sh 或 certbot）+ env_file 模板”的一键部署版本，我可以直接提供完整脚本与配置。